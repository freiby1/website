<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Создание теста</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
  <link rel="preload" href="./sidebar.js" as="script" crossorigin="anonymous">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js" as="script" crossorigin="anonymous">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js" as="script" crossorigin="anonymous">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js" as="script" crossorigin="anonymous">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js" as="script" crossorigin="anonymous">
  
  <!-- Cropper.js для кадрирования изображения -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  
  <!-- Добавляем синхронную инициализацию темы -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'system') {
        document.documentElement.style.visibility = 'hidden';
        document.documentElement.classList.add(prefersDark ? 'dark-mode' : 'light-mode');
        
        document.addEventListener('DOMContentLoaded', () => {
          document.body.classList.add(prefersDark ? 'dark-mode' : 'light-mode');
          document.documentElement.classList.remove(prefersDark ? 'dark-mode' : 'light-mode');
          document.documentElement.style.visibility = 'visible';
        });
      } else {
        const theme = savedTheme || (prefersDark ? 'dark-mode' : 'light-mode');
        document.documentElement.style.visibility = 'hidden';
        document.documentElement.classList.add(theme);
        
        document.addEventListener('DOMContentLoaded', () => {
          document.body.classList.add(theme);
          document.documentElement.classList.remove(theme);
          document.documentElement.style.visibility = 'visible';
        });
      }

      // Добавляем слушатель изменения системной темы
      if (savedTheme === 'system') {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          document.body.classList.remove('dark-mode', 'light-mode');
          document.body.classList.add(e.matches ? 'dark-mode' : 'light-mode');
        });
      }
    })();
  </script>

  <style>
    /* Стили кнопки добавления вопроса */
    .add-question-btn {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 20px 0;
      background-color: var(--card-background);
      border: 2px dashed var(--primary-color);
      border-radius: 8px;
      color: var(--primary-color);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .add-question-btn:hover {
      background-color: var(--primary-color);
      color: white;
    }
    
    /* Стили для элемента select */
    select.form-control {
      background-color: var(--card-background);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      padding-left: 40px; /* Добавляем отступ слева для иконки */
      width: 100%;
      font-size: 16px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
    }
    
    select.form-control:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.25);
    }
    
    .dark-mode select.form-control {
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23adb5bd' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    }
    
    .dark-mode select.form-control option {
      background-color: var(--card-background);
      color: var(--text-color);
    }

    /* Стиль для кнопки удаления вопроса */
    .delete-question-btn {
      border: none;
      background: transparent;
      color: #dc3545;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .delete-question-btn:hover {
      background-color: rgba(220, 53, 69, 0.1);
    }

    /* Выравнивание заголовка вопроса */
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    /* Стили для всплывающей подсказки */
    .tooltip {
      position: relative;
      display: inline-block;
      margin-left: 5px;
      color: var(--primary-color);
      cursor: pointer;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 300px;
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 14px;
      font-weight: normal;
    }
    
    .tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    /* Стили для модального окна кадрирования */
    .crop-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      overflow: hidden;
    }
    
    .crop-modal.active {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .crop-container {
      width: 90%;
      max-width: 800px;
      background-color: var(--card-background);
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .crop-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .crop-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--text-color);
    }
    
    .crop-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }
    
    .crop-area {
      width: 100%;
      height: 50vh;
      max-height: 500px;
      margin-bottom: 1rem;
      background-color: #333;
      overflow: hidden;
    }
    
    .crop-img {
      display: block;
      max-width: 100%;
    }
    
    .crop-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .crop-zoom {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .zoom-slider {
      width: 150px;
      margin: 0 10px;
    }
    
    .crop-actions {
      display: flex;
      gap: 1rem;
    }
    
    .crop-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .crop-btn.cancel {
      background: transparent;
      border: 1px solid var(--border-color);
    }
    
    .crop-btn.cancel:hover {
      background: var(--hover-bg);
    }
    
    .crop-btn.apply {
      background: var(--primary-color);
      color: white;
    }
    
    .crop-btn.apply:hover {
      opacity: 0.9;
    }
    
    /* Стиль для прогресс-бара при загрузке */
    .upload-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 5px;
      width: 0;
      background-color: var(--primary-color);
      transition: width 0.3s ease;
    }
    
    /* Стили для загрузки изображений вопросов и ответов */
    .image-preview {
      width: 100%;
      height: 150px;
      margin-bottom: 10px;
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      overflow: hidden;
    }
    
    .image-preview.has-image {
      border: none;
      background-color: var(--card-secondary-bg);
    }
    
    .image-preview img {
      max-width: 100%;
      max-height: 150px;
      object-fit: contain;
    }
    
    .image-upload-label {
      display: inline-flex;
      align-items: center;
      margin-bottom: 10px;
      background-color: var(--card-background);
      color: var(--primary-color);
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .image-upload-label i {
      margin-right: 8px;
    }
    
    .image-upload-label:hover {
      background-color: var(--primary-color);
      color: white;
    }
    
    .image-remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 2;
    }
    
    .image-remove-btn:hover {
      background-color: rgba(220, 53, 69, 0.8);
    }
    
    .answer-image-preview {
      max-width: 100%;
      height: 80px;
      margin-top: 5px;
      border-radius: 4px;
      display: none;
      align-items: center;
      justify-content: center;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }
    
    .answer-image-preview.has-image {
      display: flex;
      background-color: var(--card-secondary-bg);
    }
    
    .answer-image-preview img {
      max-width: 100%;
      max-height: 80px;
      object-fit: contain;
    }
    
    .answer-image-upload-label {
      display: inline-flex;
      align-items: center;
      margin-top: 5px;
      background-color: transparent;
      color: var(--secondary-text-color);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
    }
    
    .answer-image-upload-label i {
      margin-right: 5px;
    }
    
    .answer-image-upload-label:hover {
      background-color: var(--hover-bg);
    }

    /* Стили для контейнера с иконкой */
    .select-with-icon {
      position: relative;
      width: 100%;
    }
    
    .selected-option-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1;
      color: var(--primary-color);
      font-size: 18px;
      pointer-events: none;
    }
    
    /* Стилизация выпадающего списка */
    #test-category-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background-color: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
    }
    
    #test-category-dropdown.show {
      display: block;
    }
    
    .dropdown-option {
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    
    .dropdown-option:hover {
      background-color: var(--hover-bg);
    }
    
    .dropdown-option i {
      margin-right: 10px;
      color: var(--primary-color);
      width: 20px;
      text-align: center;
    }
    
    .dropdown-option.selected {
      background-color: rgba(var(--primary-color-rgb), 0.1);
    }
  </style>
</head>

<body>
  <div class="create-test-container">
    <div class="create-test-form">
      <!-- Шаг 1: Основная информация о тесте -->
      <div id="step1" class="step-container active">
        <h2 class="form-title">Создание нового теста</h2>
        
        <div class="form-group">
          <label for="test-cover">Обложка теста (по желанию)</label>
          <div class="cover-preview" id="cover-preview">
            <i class="fas fa-image" style="font-size: 48px; color: #bdbdbd;"></i>
          </div>
          <label class="cover-upload-label">
            <i class="fas fa-upload"></i>
            Загрузить изображение
            <input type="file" id="test-cover" accept="image/*" style="display: none;">
          </label>
        </div>
        
        <div class="form-group">
          <label for="test-title">Название теста *</label>
          <input type="text" id="test-title" class="form-control" placeholder="Введите название теста" required>
        </div>
        
        <div class="form-group">
          <label for="test-description">Описание теста (по желанию)</label>
          <textarea id="test-description" class="form-control" rows="4" placeholder="Краткое описание теста"></textarea>
        </div>
        
        <div class="form-group">
          <label for="test-category">Категория теста</label>
          <div class="select-with-icon">
            <select id="test-category" class="form-control">
              <option value="general" data-icon="fas fa-globe">Общее</option>
              <option value="education" data-icon="fas fa-graduation-cap">Образование</option>
              <option value="science" data-icon="fas fa-flask">Наука</option>
              <option value="technology" data-icon="fas fa-laptop-code">Технологии</option>
              <option value="history" data-icon="fas fa-landmark">История</option>
              <option value="geography" data-icon="fas fa-map-marked-alt">География</option>
              <option value="art" data-icon="fas fa-palette">Искусство</option>
              <option value="sports" data-icon="fas fa-running">Спорт</option>
              <option value="entertainment" data-icon="fas fa-film">Развлечения</option>
              <option value="other" data-icon="fas fa-ellipsis-h">Другое</option>
            </select>
            <div class="selected-option-icon"><i class="fas fa-globe"></i></div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="questions-count">Количество вопросов *</label>
          <input type="number" id="questions-count" class="form-control" min="1" max="50" value="5" required>
          <div class="form-text">Максимальное количество вопросов: 50</div>
        </div>
        
        <div class="form-group">
          <div class="checkbox-container">
            <input type="checkbox" id="cooperative-mode" class="form-checkbox">
            <label for="cooperative-mode">Совместное прохождение</label>
            <div class="tooltip">
              <i class="fas fa-info-circle"></i>
              <span class="tooltip-text">
                Позволяет пользователям проходить тест вместе. Первый пользователь становится хостом, другие могут присоединиться. 
                Каждый участник будет видеть ответы других после того, как все ответят на вопрос. Хост контролирует начало теста.
              </span>
            </div>
          </div>
          <div class="form-text">Позволяет пользователям проходить тест вместе и видеть ответы друг друга</div>
        </div>
        
        <div class="form-group">
          <div class="checkbox-container">
            <input type="checkbox" id="show-correct-answers" class="form-checkbox">
            <label for="show-correct-answers">Показать правильные ответы после прохождения</label>
            <div class="tooltip">
              <i class="fas fa-info-circle"></i>
              <span class="tooltip-text">
                При включении этой опции после завершения теста пользователи увидят список вопросов, свои выбранные ответы и правильные ответы.
                Работает как в одиночном, так и в совместном режиме прохождения.
              </span>
            </div>
          </div>
          <div class="form-text">Отображает полный список вопросов и правильных ответов после прохождения теста</div>
        </div>
        
        <div class="form-group">
          <label for="time-limit">Ограничение времени на вопрос (в секундах)</label>
          <input type="number" id="time-limit" class="form-control" min="0" value="0" placeholder="0 - без ограничения">
          <div class="form-text">Укажите 0, если не хотите устанавливать ограничение времени</div>
        </div>
        
        <!-- Секция создания вопросов -->
        <div class="questions-section">
          <h2>Создание вопросов</h2>
          
          <div class="layout-selector">
            <span>Расположение вопросов:</span>
            <div class="layout-options">
              <label class="layout-option">
                <input type="radio" name="layout" value="vertical" checked>
                <span class="layout-icon"><i class="fas fa-grip-lines"></i></span>
                <span class="layout-text">Вертикально</span>
              </label>
              <label class="layout-option">
                <input type="radio" name="layout" value="horizontal">
                <span class="layout-icon"><i class="fas fa-grip-lines-vertical"></i></span>
                <span class="layout-text">Горизонтально</span>
              </label>
            </div>
          </div>
          
          <div id="questions-container">
            <!-- Здесь будут динамически создаваться вопросы -->
          </div>
          
          <button type="button" class="add-question-btn" id="add-new-question">
            <i class="fas fa-plus"></i> Добавить новый вопрос
          </button>
        </div>
        
        <div class="btn-container">
          <button class="btn btn-secondary" id="cancel-btn">Отмена</button>
          <button class="btn btn-primary" id="save-test-btn">Сохранить тест</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, push, set } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js';
    import { initializeSidebar } from './sidebar.js';

    // Инициализация Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAR-ui1g1VurKML1wQwZFdon_2Bgcrz-ms",
      authDomain: "tpoproject-35957.firebaseapp.com",
      databaseURL: "https://tpoproject-35957-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "tpoproject-35957",
      storageBucket: "tpoproject-35957.appspot.com",
      messagingSenderId: "683982725892",
      appId: "1:683982725892:web:4d4e07e6ea913ddff5a2f7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);
    
    // Проверка авторизации
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = 'index.html';
      }
    });

    let currentUser = null;
    let selectedFile = null;
    let questionsCount = 5;
    let cooperativeMode = false;
    let timeLimit = 0;
    
    // Получаем данные пользователя из localStorage
    const savedUserData = localStorage.getItem('userData');
    if (savedUserData) {
      currentUser = JSON.parse(savedUserData);
    } else {
      window.location.href = 'index.html';
    }

    // Элементы шагов
    const step1 = document.getElementById('step1');
    
    // Кнопки навигации
    const saveTestBtn = document.getElementById('save-test-btn');
    
    // Обработчик загрузки обложки
    const testCoverInput = document.getElementById('test-cover');
    const coverPreview = document.getElementById('cover-preview');
    
    testCoverInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      // Проверяем, является ли файл изображением
      if (!file.type.startsWith('image/')) {
        alert('Пожалуйста, выберите изображение');
        return;
      }
      
      // Если это GIF, загружаем без кадрирования
      if (file.type === 'image/gif') {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (event) => {
          coverPreview.innerHTML = `<img src="${event.target.result}" alt="Обложка теста">`;
        };
        reader.readAsDataURL(file);
        return;
      }
      
      // Инициализируем модальное окно для кадрирования
      const modal = document.getElementById('crop-modal');
      const cropImg = document.getElementById('crop-img');
      const zoomSlider = document.getElementById('zoom-slider');
      const closeBtn = document.getElementById('crop-close');
      const cancelBtn = document.getElementById('crop-cancel');
      const applyBtn = document.getElementById('crop-apply');
      
      let cropper;
      
      // Показываем изображение в модальном окне
      const reader = new FileReader();
      reader.onload = function(e) {
        cropImg.src = e.target.result;
        modal.classList.add('active');
        
        // Инициализируем Cropper.js после загрузки изображения
        setTimeout(() => {
          cropper = new Cropper(cropImg, {
            aspectRatio: 16 / 9, // Соотношение сторон для обложки теста
            viewMode: 1, // Обрезаем по размеру области просмотра
            guides: true, // Показываем направляющие линии
            center: true, // Показываем индикатор центра
            minContainerWidth: 300,
            minContainerHeight: 150,
            dragMode: 'move', // Режим перемещения изображения
            autoCropArea: 0.8, // Размер области кадрирования (0-1)
            responsive: true,
            restore: false,
            checkOrientation: false, // Отключаем автоматическое исправление ориентации
            background: false, // Отключаем фон области кадрирования
            ready() {
              // Настраиваем слайдер масштабирования
              zoomSlider.value = 0;
            }
          });
        }, 100);
      };
      reader.readAsDataURL(file);
      
      // Функция для закрытия модального окна
      function closeModal() {
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        modal.classList.remove('active');
        cropImg.src = '';
        testCoverInput.value = ''; // Сбрасываем значение input, чтобы можно было выбрать тот же файл снова
      }
      
      // Настраиваем слайдер масштабирования
      zoomSlider.addEventListener('input', function() {
        if (cropper) {
          // Преобразуем значение слайдера (0-100) в масштаб (0.5-2)
          const zoom = 0.5 + (this.value / 100) * 1.5;
          cropper.zoomTo(zoom);
        }
      });
      
      // Обработчики событий для кнопок
      closeBtn.onclick = closeModal;
      cancelBtn.onclick = closeModal;
      
      // Обработчик события для кнопки "Применить"
      applyBtn.onclick = function() {
        if (!cropper) {
          alert('Ошибка: кадрирование не инициализировано');
          closeModal();
          return;
        }
        
        // Получаем кадрированное изображение в формате canvas
        const canvas = cropper.getCroppedCanvas({
          width: 1280, // Максимальная ширина
          height: 720, // Максимальная высота
          minWidth: 640, // Минимальная ширина
          minHeight: 360, // Минимальная высота
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        });
        
        if (!canvas) {
          alert('Ошибка: не удалось создать кадрированное изображение');
          closeModal();
          return;
        }
        
        // Преобразуем canvas в DataURL для предпросмотра
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        coverPreview.innerHTML = `<img src="${dataUrl}" alt="Обложка теста">`;
        
        // Преобразуем canvas в Blob для сохранения
        canvas.toBlob((blob) => {
          selectedFile = new File([blob], "cropped-cover.jpg", { type: "image/jpeg" });
        }, 'image/jpeg', 0.9);
        
        // Закрываем модальное окно
        closeModal();
      };
    });
    
    // Обработчик для чекбокса совместного режима
    const cooperativeModeCheckbox = document.getElementById('cooperative-mode');
    cooperativeModeCheckbox.addEventListener('change', (e) => {
      cooperativeMode = e.target.checked;
    });
    
    // Обработчик для чекбокса показа правильных ответов
    const showCorrectAnswersCheckbox = document.getElementById('show-correct-answers');
    let showCorrectAnswers = false;
    showCorrectAnswersCheckbox.addEventListener('change', (e) => {
      showCorrectAnswers = e.target.checked;
    });
    
    // Обработчик для поля ограничения времени
    const timeLimitInput = document.getElementById('time-limit');
    timeLimitInput.addEventListener('change', (e) => {
      timeLimit = parseInt(e.target.value) || 0;
    });
    
    // Реагируем на изменение количества вопросов
    const questionsCountInput = document.getElementById('questions-count');
    questionsCountInput.addEventListener('change', (e) => {
      const count = parseInt(e.target.value) || 5;
      if (count >= 1 && count <= 50) {
        questionsCount = count;
        generateQuestionForms(count);
      }
    });
    
    // Генерация форм для вопросов
    function generateQuestionForms(count) {
      const questionsContainer = document.getElementById('questions-container');
      questionsContainer.innerHTML = '';
      
      for (let i = 0; i < count; i++) {
        createQuestionForm(i, questionsContainer);
      }
    }
    
    // Создание формы для одного вопроса
    function createQuestionForm(index, container) {
      const questionDiv = document.createElement('div');
      questionDiv.className = 'question-builder';
      questionDiv.dataset.questionIndex = index;
      
      questionDiv.innerHTML = `
        <div class="question-header">
          <div class="question-number">Вопрос ${index + 1}</div>
          ${index > 0 ? '<button type="button" class="delete-question-btn" title="Удалить вопрос"><i class="fas fa-trash"></i></button>' : ''}
        </div>
        
        <div class="form-group">
          <label for="question-text-${index}">Текст вопроса *</label>
          <input type="text" id="question-text-${index}" class="form-control question-text" placeholder="Введите текст вопроса" required>
        </div>
        
        <div class="form-group">
          <label>Изображение для вопроса (по желанию)</label>
          <div class="image-preview" id="question-image-preview-${index}">
            <i class="fas fa-image" style="font-size: 48px; color: #bdbdbd;"></i>
          </div>
          <label class="image-upload-label">
            <i class="fas fa-upload"></i>
            Загрузить изображение
            <input type="file" class="question-image-input" data-question="${index}" accept="image/*" style="display: none;">
          </label>
        </div>
        
        <div class="answers-list" id="answers-list-${index}">
          <div class="answer-item">
            <div class="answer-checkbox">
              <input type="checkbox" id="answer-correct-${index}-0" class="answer-correct">
            </div>
            <div class="answer-text">
              <input type="text" class="form-control answer-text-input" placeholder="Вариант ответа" required>
              
              <div class="answer-image-preview" id="answer-image-preview-${index}-0">
              </div>
              <label class="answer-image-upload-label">
                <i class="fas fa-image"></i>
                Добавить изображение
                <input type="file" class="answer-image-input" data-question="${index}" data-option="0" accept="image/*" style="display: none;">
              </label>
            </div>
            <div class="answer-actions">
              <button type="button" class="delete-answer-btn" title="Удалить ответ"><i class="fas fa-trash"></i></button>
            </div>
          </div>
          
          <div class="answer-item">
            <div class="answer-checkbox">
              <input type="checkbox" id="answer-correct-${index}-1" class="answer-correct">
            </div>
            <div class="answer-text">
              <input type="text" class="form-control answer-text-input" placeholder="Вариант ответа" required>
              
              <div class="answer-image-preview" id="answer-image-preview-${index}-1">
              </div>
              <label class="answer-image-upload-label">
                <i class="fas fa-image"></i>
                Добавить изображение
                <input type="file" class="answer-image-input" data-question="${index}" data-option="1" accept="image/*" style="display: none;">
              </label>
            </div>
            <div class="answer-actions">
              <button type="button" class="delete-answer-btn" title="Удалить ответ"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        </div>
        
        <button type="button" class="add-answer-btn" data-question="${index}">
          <i class="fas fa-plus"></i> Добавить вариант ответа
        </button>
      `;
      
      container.appendChild(questionDiv);
      
      // Добавляем обработчики для кнопок
      addQuestionEventListeners(questionDiv, index);
    }
    
    // Добавление обработчиков событий для вопроса
    function addQuestionEventListeners(questionDiv, questionIndex) {
      // Обработчик для кнопки "Добавить вариант ответа"
      const addAnswerBtn = questionDiv.querySelector('.add-answer-btn');
      addAnswerBtn.addEventListener('click', () => {
        addAnswerToQuestion(questionIndex);
      });
      
      // Обработчики для кнопок "Удалить вариант ответа"
      const deleteAnswerBtns = questionDiv.querySelectorAll('.delete-answer-btn');
      deleteAnswerBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          deleteAnswerFromQuestion(e, questionIndex);
        });
      });
      
      // Обработчик для кнопки "Удалить вопрос"
      const deleteQuestionBtn = questionDiv.querySelector('.delete-question-btn');
      if (deleteQuestionBtn) {
        deleteQuestionBtn.addEventListener('click', () => {
          deleteQuestion(questionIndex);
        });
      }
      
      // Обработчик загрузки изображения для вопроса
      const questionImageInput = questionDiv.querySelector('.question-image-input');
      questionImageInput.addEventListener('change', (e) => {
        handleImageUpload(e, questionIndex);
      });
      
      // Обработчики загрузки изображений для вариантов ответов
      const answerImageInputs = questionDiv.querySelectorAll('.answer-image-input');
      answerImageInputs.forEach(input => {
        input.addEventListener('change', (e) => {
          handleAnswerImageUpload(e);
        });
      });
    }
    
    // Объект для хранения данных изображений вопросов
    let questionsData = {};
    
    // Получение данных вопроса
    function getQuestionData(questionIndex) {
      if (!questionsData[questionIndex]) {
        questionsData[questionIndex] = {
          image: null,
          answerImages: {}
        };
      }
      return questionsData[questionIndex];
    }
    
    // Функция обработки загрузки изображения для вопроса
    function handleImageUpload(event, questionIndex) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Проверяем, является ли файл изображением
      if (!file.type.startsWith('image/')) {
        alert('Пожалуйста, выберите изображение');
        return;
      }
      
      // Если это GIF, загружаем без кадрирования
      if (file.type === 'image/gif') {
        uploadQuestionImage(file, questionIndex);
        return;
      }
      
      // Открываем модальное окно для кадрирования
      openCropModal(file, (croppedFile) => {
        uploadQuestionImage(croppedFile, questionIndex);
      });
    }
    
    // Функция обработки загрузки изображения для варианта ответа
    function handleAnswerImageUpload(event) {
      const questionIndex = parseInt(event.target.dataset.question);
      const optionIndex = parseInt(event.target.dataset.option);
      const file = event.target.files[0];
      
      if (!file) return;
      
      // Проверяем, является ли файл изображением
      if (!file.type.startsWith('image/')) {
        alert('Пожалуйста, выберите изображение');
        return;
      }
      
      // Если это GIF, загружаем без кадрирования
      if (file.type === 'image/gif') {
        uploadAnswerImage(file, questionIndex, optionIndex);
        return;
      }
      
      // Открываем модальное окно для кадрирования
      openCropModal(file, (croppedFile) => {
        uploadAnswerImage(croppedFile, questionIndex, optionIndex);
      });
    }
    
    // Функция загрузки изображения для вопроса
    function uploadQuestionImage(file, questionIndex) {
      try {
        const preview = document.getElementById(`question-image-preview-${questionIndex}`);
        
        // Создаем предварительный просмотр
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Изображение вопроса">
            <button type="button" class="image-remove-btn" data-question="${questionIndex}"><i class="fas fa-times"></i></button>
          `;
          preview.classList.add('has-image');
          
          // Добавляем обработчик для кнопки удаления
          const removeBtn = preview.querySelector('.image-remove-btn');
          removeBtn.addEventListener('click', () => {
            removeQuestionImage(questionIndex);
          });
        };
        reader.readAsDataURL(file);
        
        // Сохраняем файл в памяти для последующей загрузки при сохранении теста
        const questionData = getQuestionData(questionIndex);
        questionData.image = file;
        
        // Отмечаем, что есть несохраненные изменения
        markUnsavedChanges();
      } catch (error) {
        console.error('Ошибка при загрузке изображения:', error);
        alert('Произошла ошибка при загрузке изображения');
      }
    }
    
    // Функция загрузки изображения для варианта ответа
    function uploadAnswerImage(file, questionIndex, optionIndex) {
      try {
        const preview = document.getElementById(`answer-image-preview-${questionIndex}-${optionIndex}`);
        
        // Создаем предварительный просмотр
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Изображение варианта ответа">
            <button type="button" class="image-remove-btn" data-question="${questionIndex}" data-option="${optionIndex}"><i class="fas fa-times"></i></button>
          `;
          preview.classList.add('has-image');
          
          // Добавляем обработчик для кнопки удаления
          const removeBtn = preview.querySelector('.image-remove-btn');
          removeBtn.addEventListener('click', () => {
            removeAnswerImage(questionIndex, optionIndex);
          });
        };
        reader.readAsDataURL(file);
        
        // Сохраняем файл в памяти для последующей загрузки при сохранении теста
        const questionData = getQuestionData(questionIndex);
        if (!questionData.answerImages) {
          questionData.answerImages = {};
        }
        questionData.answerImages[optionIndex] = file;
        
        // Отмечаем, что есть несохраненные изменения
        markUnsavedChanges();
      } catch (error) {
        console.error('Ошибка при загрузке изображения:', error);
        alert('Произошла ошибка при загрузке изображения');
      }
    }
    
    // Функция удаления изображения вопроса
    function removeQuestionImage(questionIndex) {
      const preview = document.getElementById(`question-image-preview-${questionIndex}`);
      preview.innerHTML = '<i class="fas fa-image" style="font-size: 48px; color: #bdbdbd;"></i>';
      preview.classList.remove('has-image');
      
      // Удаляем файл из памяти
      const questionData = getQuestionData(questionIndex);
      questionData.image = null;
      
      // Отмечаем, что есть несохраненные изменения
      markUnsavedChanges();
    }
    
    // Функция удаления изображения варианта ответа
    function removeAnswerImage(questionIndex, optionIndex) {
      const preview = document.getElementById(`answer-image-preview-${questionIndex}-${optionIndex}`);
      preview.innerHTML = '';
      preview.classList.remove('has-image');
      
      // Удаляем файл из памяти
      const questionData = getQuestionData(questionIndex);
      if (questionData.answerImages && questionData.answerImages[optionIndex]) {
        delete questionData.answerImages[optionIndex];
      }
      
      // Отмечаем, что есть несохраненные изменения
      markUnsavedChanges();
    }
    
    // Функция открытия модального окна для кадрирования
    function openCropModal(file, callback) {
      const modal = document.getElementById('crop-modal');
      const cropImg = document.getElementById('crop-img');
      const zoomSlider = document.getElementById('zoom-slider');
      const closeBtn = document.getElementById('crop-close');
      const cancelBtn = document.getElementById('crop-cancel');
      const applyBtn = document.getElementById('crop-apply');
      
      let cropper;
      
      // Показываем изображение в модальном окне
      const reader = new FileReader();
      reader.onload = function(e) {
        cropImg.src = e.target.result;
        modal.classList.add('active');
        
        // Инициализируем Cropper.js после загрузки изображения
        setTimeout(() => {
          cropper = new Cropper(cropImg, {
            aspectRatio: NaN, // Свободное соотношение сторон для изображений вопросов и ответов
            viewMode: 1, // Обрезаем по размеру области просмотра
            guides: true, // Показываем направляющие линии
            center: true, // Показываем индикатор центра
            minContainerWidth: 300,
            minContainerHeight: 150,
            dragMode: 'move', // Режим перемещения изображения
            autoCropArea: 0.8, // Размер области кадрирования (0-1)
            responsive: true,
            restore: false,
            checkOrientation: false, // Отключаем автоматическое исправление ориентации
            background: false, // Отключаем фон области кадрирования
            ready() {
              // Настраиваем слайдер масштабирования
              zoomSlider.value = 0;
            }
          });
        }, 100);
      };
      reader.readAsDataURL(file);
      
      // Функция для закрытия модального окна
      function closeModal() {
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        modal.classList.remove('active');
        cropImg.src = '';
      }
      
      // Настраиваем слайдер масштабирования
      zoomSlider.addEventListener('input', function() {
        if (cropper) {
          // Преобразуем значение слайдера (0-100) в масштаб (0.5-2)
          const zoom = 0.5 + (this.value / 100) * 1.5;
          cropper.zoomTo(zoom);
        }
      });
      
      // Обработчики событий для кнопок
      closeBtn.onclick = closeModal;
      cancelBtn.onclick = closeModal;
      
      // Обработчик события для кнопки "Применить"
      applyBtn.onclick = function() {
        if (!cropper) {
          alert('Ошибка: кадрирование не инициализировано');
          closeModal();
          return;
        }
        
        // Получаем кадрированное изображение в формате canvas
        const canvas = cropper.getCroppedCanvas({
          maxWidth: 1280, // Максимальная ширина
          maxHeight: 720, // Максимальная высота
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        });
        
        if (!canvas) {
          alert('Ошибка: не удалось создать кадрированное изображение');
          closeModal();
          return;
        }
        
        // Преобразуем canvas в Blob для сохранения
        canvas.toBlob((blob) => {
          const croppedFile = new File([blob], "cropped-image.jpg", { type: "image/jpeg" });
          callback(croppedFile);
        }, 'image/jpeg', 0.9);
        
        // Закрываем модальное окно
        closeModal();
      };
    }
    
    // Добавление варианта ответа к вопросу
    function addAnswerToQuestion(questionIndex) {
      const answersList = document.getElementById(`answers-list-${questionIndex}`);
      const answersCount = answersList.querySelectorAll('.answer-item').length;
      
      const answerItem = document.createElement('div');
      answerItem.className = 'answer-item';
      answerItem.innerHTML = `
        <div class="answer-checkbox">
          <input type="checkbox" id="answer-correct-${questionIndex}-${answersCount}" class="answer-correct">
        </div>
        <div class="answer-text">
          <input type="text" class="form-control answer-text-input" placeholder="Вариант ответа" required>
          
          <div class="answer-image-preview" id="answer-image-preview-${questionIndex}-${answersCount}">
          </div>
          <label class="answer-image-upload-label">
            <i class="fas fa-image"></i>
            Добавить изображение
            <input type="file" class="answer-image-input" data-question="${questionIndex}" data-option="${answersCount}" accept="image/*" style="display: none;">
          </label>
        </div>
        <div class="answer-actions">
          <button type="button" class="delete-answer-btn" title="Удалить ответ"><i class="fas fa-trash"></i></button>
        </div>
      `;
      
      answersList.appendChild(answerItem);
      
      // Добавляем обработчик для новой кнопки удаления
      const deleteBtn = answerItem.querySelector('.delete-answer-btn');
      deleteBtn.addEventListener('click', (e) => {
        deleteAnswerFromQuestion(e, questionIndex);
      });
      
      // Добавляем обработчик для загрузки изображений
      const imageInput = answerItem.querySelector('.answer-image-input');
      imageInput.addEventListener('change', (e) => {
        handleAnswerImageUpload(e);
      });
    }
    
    // Удаление варианта ответа из вопроса
    function deleteAnswerFromQuestion(e, questionIndex) {
      const answersList = e.currentTarget.closest('.answers-list');
      const answerItems = answersList.querySelectorAll('.answer-item');
      
      if (answerItems.length > 2) {
        // Находим индекс удаляемого элемента
        const answerItem = e.currentTarget.closest('.answer-item');
        const answerIndex = Array.from(answerItems).indexOf(answerItem);
        
        // Удаляем любые загруженные изображения для этого варианта ответа
        const questionData = getQuestionData(questionIndex);
        if (questionData.answerImages && questionData.answerImages[answerIndex]) {
          delete questionData.answerImages[answerIndex];
        }
        
        // Удаляем элемент из DOM
        answerItem.remove();
        
        // Обновляем атрибуты у оставшихся вариантов ответов
        updateAnswerAttributes(answersList, questionIndex);
      } else {
        alert('Должно быть минимум 2 варианта ответа');
      }
    }
    
    // Обновление атрибутов у вариантов ответов после удаления
    function updateAnswerAttributes(answersList, questionIndex) {
      const answerItems = answersList.querySelectorAll('.answer-item');
      
      answerItems.forEach((item, index) => {
        // Обновляем ID чекбокса
        const checkbox = item.querySelector('.answer-correct');
        checkbox.id = `answer-correct-${questionIndex}-${index}`;
        
        // Обновляем атрибуты изображения
        const imageInput = item.querySelector('.answer-image-input');
        imageInput.dataset.option = index;
        
        // Обновляем ID превью изображения
        const imagePreview = item.querySelector('.answer-image-preview');
        imagePreview.id = `answer-image-preview-${questionIndex}-${index}`;
      });
    }
    
    // Удаление вопроса
    function deleteQuestion(questionIndex) {
      const questionsContainer = document.getElementById('questions-container');
      const questions = questionsContainer.querySelectorAll('.question-builder');
      
      if (questions.length <= 1) {
        alert('Должен быть минимум 1 вопрос');
        return;
      }
      
      // Удаляем данные изображений вопроса
      const questionData = getQuestionData(questionIndex);
      if (questionData) {
        delete questionsData[questionIndex];
      }
      
      // Удаляем вопрос из DOM
      const questionToRemove = questions[questionIndex];
      if (questionToRemove) {
        questionToRemove.remove();
      } else {
        console.error(`Элемент вопроса с индексом ${questionIndex} не найден`);
        return;
      }
      
      // Обновляем индексы оставшихся вопросов
      const remainingQuestions = questionsContainer.querySelectorAll('.question-builder');
      
      // Пересоздаем массив с данными вопросов
      const newQuestionsData = {};
      
      remainingQuestions.forEach((question, index) => {
        // Обновляем атрибут data-question-index
        question.dataset.questionIndex = index;
        
        // Получаем старый индекс из номера вопроса
        const oldIndex = parseInt(question.querySelector('.question-number').textContent.replace('Вопрос ', '')) - 1;
        
        // Перемещаем данные изображений для этого вопроса в новую позицию
        if (questionsData[oldIndex]) {
          newQuestionsData[index] = questionsData[oldIndex];
        }
        
        // Обновляем номер вопроса
        question.querySelector('.question-number').textContent = `Вопрос ${index + 1}`;
        
        // Обновляем ID и атрибуты полей
        const questionText = question.querySelector('.question-text');
        questionText.id = `question-text-${index}`;
        
        // Обновляем ID превью изображения вопроса
        const imagePreview = question.querySelector('.image-preview');
        imagePreview.id = `question-image-preview-${index}`;
        
        // Обновляем data-атрибут у input изображения
        const imageInput = question.querySelector('.question-image-input');
        imageInput.dataset.question = index;
        
        // Обновляем атрибут data-question у кнопки добавления ответа
        const addAnswerBtn = question.querySelector('.add-answer-btn');
        addAnswerBtn.dataset.question = index;
        
        // Обновляем ID списка ответов
        const answersList = question.querySelector('.answers-list');
        answersList.id = `answers-list-${index}`;
        
        // Обновляем атрибуты вариантов ответов
        updateAnswerAttributes(answersList, index);
        
        // Обновляем обработчики событий для кнопок
        updateQuestionEventListeners(question, oldIndex, index);
      });
      
      // Обновляем данные вопросов
      questionsData = newQuestionsData;
      
      // Обновляем количество вопросов
      questionsCount = remainingQuestions.length;
    }
    
    // Обновление обработчиков событий для вопроса после изменения индекса
    function updateQuestionEventListeners(questionDiv, oldIndex, newIndex) {
      // Обновляем обработчик для кнопки удаления вопроса
      const deleteQuestionBtn = questionDiv.querySelector('.delete-question-btn');
      if (deleteQuestionBtn) {
        deleteQuestionBtn.replaceWith(deleteQuestionBtn.cloneNode(true));
        const newDeleteBtn = questionDiv.querySelector('.delete-question-btn');
        newDeleteBtn.addEventListener('click', () => {
          deleteQuestion(newIndex);
        });
      }
      
      // Обновляем обработчик для кнопки добавления ответа
      const addAnswerBtn = questionDiv.querySelector('.add-answer-btn');
      addAnswerBtn.replaceWith(addAnswerBtn.cloneNode(true));
      const newAddAnswerBtn = questionDiv.querySelector('.add-answer-btn');
      newAddAnswerBtn.addEventListener('click', () => {
        addAnswerToQuestion(newIndex);
      });
      
      // Обновляем обработчики для кнопок удаления ответов
      const deleteAnswerBtns = questionDiv.querySelectorAll('.delete-answer-btn');
      deleteAnswerBtns.forEach(btn => {
        btn.replaceWith(btn.cloneNode(true));
      });
      
      const newDeleteAnswerBtns = questionDiv.querySelectorAll('.delete-answer-btn');
      newDeleteAnswerBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          deleteAnswerFromQuestion(e, newIndex);
        });
      });
      
      // Обновляем обработчик для загрузки изображения вопроса
      const questionImageInput = questionDiv.querySelector('.question-image-input');
      questionImageInput.replaceWith(questionImageInput.cloneNode(true));
      const newQuestionImageInput = questionDiv.querySelector('.question-image-input');
      newQuestionImageInput.addEventListener('change', (e) => {
        handleImageUpload(e, newIndex);
      });
      
      // Обновляем обработчики для загрузки изображений ответов
      const answerImageInputs = questionDiv.querySelectorAll('.answer-image-input');
      answerImageInputs.forEach(input => {
        const optionIndex = input.dataset.option;
        input.replaceWith(input.cloneNode(true));
      });
      
      const newAnswerImageInputs = questionDiv.querySelectorAll('.answer-image-input');
      newAnswerImageInputs.forEach(input => {
        input.dataset.question = newIndex;
        input.addEventListener('change', (e) => {
          handleAnswerImageUpload(e);
        });
      });
    }
    
    // Обработчик для кнопки добавления нового вопроса
    document.getElementById('add-new-question').addEventListener('click', () => {
      const questionsContainer = document.getElementById('questions-container');
      const currentCount = questionsContainer.querySelectorAll('.question-builder').length;
      
      // Добавляем новый вопрос
      createQuestionForm(currentCount, questionsContainer);
      
      // Обновляем количество вопросов
      questionsCount = currentCount + 1;
      
      // Обновляем значение поля с количеством вопросов
      document.getElementById('questions-count').value = questionsCount;
    });
    
    // Сохранение теста
    saveTestBtn.addEventListener('click', async () => {
      try {
        // Проверяем данные теста
        const testTitle = document.getElementById('test-title').value.trim();
        const testDescription = document.getElementById('test-description').value.trim();
        const testCategory = document.getElementById('test-category').value;
        
        if (!testTitle) {
          alert('Пожалуйста, введите название теста');
          return;
        }
        
        // Собираем данные вопросов
        const questions = [];
        const questionForms = document.querySelectorAll('.question-builder');
        
        if (questionForms.length === 0) {
          alert('Пожалуйста, добавьте хотя бы один вопрос');
          return;
        }
        
        // Показываем индикатор загрузки
        saveTestBtn.disabled = true;
        saveTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';
        
        // Загрузка обложки (если выбрана)
        let coverURL = null;
        if (selectedFile) {
          const fileRef = storageRef(storage, `test-covers/${currentUser.uid}/${Date.now()}_${selectedFile.name}`);
          const snapshot = await uploadBytes(fileRef, selectedFile);
          coverURL = await getDownloadURL(snapshot.ref);
        } else {
          // Если изображение не выбрано, используем изображение по умолчанию
          const defaultImageRef = storageRef(storage, 'test-covers/test-cover-default.png');
          try {
            coverURL = await getDownloadURL(defaultImageRef);
          } catch (error) {
            console.error('Ошибка при получении изображения по умолчанию:', error);
          }
        }
        
        // Создаем новый тест в базе данных
        const newTestRef = push(ref(db, 'tests'));
        const testId = newTestRef.key;
        
        // Обрабатываем вопросы и загружаем их изображения
        for (let i = 0; i < questionForms.length; i++) {
          const questionForm = questionForms[i];
          const questionText = questionForm.querySelector('.question-text').value.trim();
          
          if (!questionText) {
            throw new Error(`Пожалуйста, введите текст вопроса ${i + 1}`);
          }
          
          const answerItems = questionForm.querySelectorAll('.answer-item');
          const options = [];
          let correctAnswers = [];
          
          // Собираем данные вариантов ответов
          for (let j = 0; j < answerItems.length; j++) {
            const answerItem = answerItems[j];
            const answerText = answerItem.querySelector('.answer-text-input').value.trim();
            const isCorrect = answerItem.querySelector('.answer-correct').checked;
            
            if (!answerText) {
              throw new Error(`Пожалуйста, введите текст ответа ${j + 1} для вопроса ${i + 1}`);
            }
            
            if (isCorrect) {
              correctAnswers.push(j);
            }
            
            options.push(answerText);
          }
          
          if (correctAnswers.length === 0) {
            throw new Error(`Пожалуйста, выберите хотя бы один правильный ответ для вопроса ${i + 1}`);
          }
          
          // Создаем новый вопрос
          const question = {
            text: questionText,
            options: options,
            correctAnswer: correctAnswers.length === 1 ? correctAnswers[0] : correctAnswers,
            isMultipleChoice: correctAnswers.length > 1
          };
          
          // Загружаем изображение вопроса, если оно есть
          const questionData = getQuestionData(i);
          if (questionData && questionData.image) {
            const imagePath = `test-questions/${testId}/${i}/question-image.jpg`;
            const questionImageRef = storageRef(storage, imagePath);
            await uploadBytes(questionImageRef, questionData.image);
            question.imageURL = await getDownloadURL(questionImageRef);
          }
          
          // Загружаем изображения вариантов ответов, если они есть
          if (questionData && questionData.answerImages && Object.keys(questionData.answerImages).length > 0) {
            question.optionImages = [];
            
            for (const [optionIndex, imageFile] of Object.entries(questionData.answerImages)) {
              const imagePath = `test-questions/${testId}/${i}/options/${optionIndex}.jpg`;
              const optionImageRef = storageRef(storage, imagePath);
              await uploadBytes(optionImageRef, imageFile);
              
              // Создаем массив, если его ещё нет
              if (!question.optionImages) {
                question.optionImages = [];
              }
              
              question.optionImages[optionIndex] = await getDownloadURL(optionImageRef);
            }
          }
          
          questions.push(question);
        }
        
        const testData = {
          title: testTitle,
          description: testDescription,
          coverURL: coverURL,
          questionsCount: questions.length,
          questions: questions,
          createdBy: currentUser.uid,
          createdAt: Date.now(),
          cooperativeMode: cooperativeMode,
          timeLimit: timeLimit,
          showCorrectAnswers: showCorrectAnswers,
          category: testCategory
        };
        
        await set(newTestRef, testData);
        
        // Перенаправляем на домашнюю страницу
        window.location.href = 'home.html';
      } catch (error) {
        console.error('Ошибка при сохранении теста:', error);
        alert(error.message || 'Произошла ошибка при сохранении теста. Пожалуйста, попробуйте еще раз.');
        saveTestBtn.disabled = false;
        saveTestBtn.innerHTML = 'Сохранить тест';
      }
    });
    
    // Инициализация сайдбара
    window.addEventListener('load', () => {
      initializeSidebar();
    });

    // Инициализация при загрузке страницы
    window.addEventListener('DOMContentLoaded', () => {
      // Генерируем начальные вопросы
      generateQuestionForms(questionsCount);
      
      // Инициализируем обработчик для категорий с иконками
      const categorySelect = document.getElementById('test-category');
      const selectedIcon = document.querySelector('.selected-option-icon i');
      
      // Обновляем иконку при изменении выбора
      categorySelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const iconClass = selectedOption.getAttribute('data-icon');
        selectedIcon.className = iconClass;
      });
    });
    
    // Флаг для отслеживания изменений
    let hasUnsavedChanges = false;
    
    // Функция для отметки о наличии несохраненных изменений
    function markUnsavedChanges() {
      hasUnsavedChanges = true;
    }
    
    // Добавляем обработчики изменений для полей формы
    document.getElementById('test-title').addEventListener('input', markUnsavedChanges);
    document.getElementById('test-description').addEventListener('input', markUnsavedChanges);
    document.getElementById('questions-count').addEventListener('change', markUnsavedChanges);
    document.getElementById('cooperative-mode').addEventListener('change', markUnsavedChanges);
    document.getElementById('show-correct-answers').addEventListener('change', markUnsavedChanges);
    document.getElementById('time-limit').addEventListener('input', markUnsavedChanges);
    document.getElementById('test-cover').addEventListener('change', markUnsavedChanges);
    
    // Добавляем слушатель на изменения в контейнере вопросов
    document.getElementById('questions-container').addEventListener('input', markUnsavedChanges);
    document.getElementById('questions-container').addEventListener('change', markUnsavedChanges);
    
    // Добавляем обработчик для кнопки добавления вопроса
    document.getElementById('add-new-question').addEventListener('click', markUnsavedChanges);
    
    // Сбрасываем флаг при сохранении
    saveTestBtn.addEventListener('click', () => {
      hasUnsavedChanges = false;
    });
    
    // Предупреждение при попытке покинуть страницу с несохраненными изменениями
    window.addEventListener('beforeunload', (event) => {
      if (hasUnsavedChanges) {
        event.preventDefault();
        event.returnValue = 'У вас есть несохраненные изменения. Вы уверены, что хотите покинуть страницу?';
        return event.returnValue;
      }
    });

    // Обработчик для кнопки "Отмена"
    document.getElementById('cancel-btn').addEventListener('click', (event) => {
      if (hasUnsavedChanges) {
        if (confirm('У вас есть несохраненные изменения. Вы уверены, что хотите покинуть страницу?')) {
          window.location.href = 'home.html';
        }
      } else {
        window.location.href = 'home.html';
      }
    });
    
    // Переключение между вертикальным и горизонтальным расположением карточек с вопросами
    const layoutOptions = document.querySelectorAll('input[name="layout"]');
    const questionsContainer = document.getElementById('questions-container');
    
    // Установка начального класса для контейнера вопросов
    questionsContainer.classList.add('vertical');
    
    // Обработчик изменения расположения
    layoutOptions.forEach(option => {
      option.addEventListener('change', (e) => {
        if (e.target.value === 'vertical') {
          questionsContainer.classList.remove('horizontal');
          questionsContainer.classList.add('vertical');
          // Сохраняем выбор в localStorage
          localStorage.setItem('questionsLayout', 'vertical');
        } else {
          questionsContainer.classList.remove('vertical');
          questionsContainer.classList.add('horizontal');
          // Сохраняем выбор в localStorage
          localStorage.setItem('questionsLayout', 'horizontal');
        }
      });
    });
    
    // Загружаем сохраненное расположение из localStorage при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
      const savedLayout = localStorage.getItem('questionsLayout');
      if (savedLayout === 'horizontal') {
        document.querySelector('input[name="layout"][value="horizontal"]').checked = true;
        questionsContainer.classList.remove('vertical');
        questionsContainer.classList.add('horizontal');
      }
    });
  </script>
</body>

<!-- Модальное окно для кадрирования изображения -->
<div class="crop-modal" id="crop-modal">
  <div class="crop-container">
    <div class="crop-header">
      <div class="crop-title">Настройка изображения</div>
      <button class="crop-close" id="crop-close">&times;</button>
    </div>
    <div class="crop-area">
      <img src="" alt="Изображение для обложки" id="crop-img" class="crop-img">
    </div>
    <div class="crop-controls">
      <div class="crop-zoom">
        <i class="fas fa-search-minus"></i>
        <input type="range" id="zoom-slider" class="zoom-slider" min="0" max="100" value="0">
        <i class="fas fa-search-plus"></i>
      </div>
      <div class="crop-actions">
        <button class="crop-btn cancel" id="crop-cancel">Отмена</button>
        <button class="crop-btn apply" id="crop-apply">Применить</button>
      </div>
    </div>
  </div>
</div>
</html> 