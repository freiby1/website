<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
	<title>Страница группы</title>
	<script type="module" src="online-status.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="styles.css">
	<link rel="preload" href="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js" as="script"
		crossorigin="anonymous">
	<link rel="preload" href="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js" as="script"
		crossorigin="anonymous">
	<link rel="preload" href="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js" as="script"
		crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

	<style>
		.group-container {
			max-width: 1200px;
			margin: 20px auto;
			padding: 0 20px;
			overflow: hidden;
		}

		.group-header {
			position: relative;
			border-radius: 10px;
			overflow: hidden;
			margin-bottom: 30px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			background-color: #f8f8f8;
		}

		.dark-mode .group-header {
			background-color: #2d2d2d;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
		}

		.group-cover {
			height: 250px;
			background-color: #eee;
			position: relative;
			overflow: hidden;
		}

		.dark-mode .group-cover {
			background-color: #3d3d3d;
		}

		.group-cover img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.group-info {
			padding: 20px;
			position: relative;
			display: flex;
			align-items: center;
		}

		.group-avatar {
			width: 120px;
			height: 120px;
			border-radius: 50%;
			overflow: hidden;
			margin-right: 20px;
			background-color: #eee;
			border: 4px solid #fff;
			margin-top: -60px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			flex-shrink: 0;
		}

		.dark-mode .group-avatar {
			background-color: #3d3d3d;
			border-color: #2d2d2d;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
		}

		.group-avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.group-details {
			flex: 1;
		}

		.group-name {
			font-size: 28px;
			font-weight: 600;
			margin-bottom: 10px;
			color: #333;
		}

		.dark-mode .group-name {
			color: #f5f5f5;
		}

		.group-description {
			font-size: 16px;
			color: #666;
			margin-bottom: 15px;
			line-height: 1.5;
		}

		.dark-mode .group-description {
			color: #bbb;
		}

		.group-meta {
			display: flex;
			align-items: center;
			font-size: 14px;
			color: #888;
		}

		.dark-mode .group-meta {
			color: #999;
		}

		.group-meta-item {
			display: flex;
			align-items: center;
			margin-right: 20px;
		}

		.group-meta-item i {
			margin-right: 5px;
		}

		.group-actions {
			display: flex;
			justify-content: flex-end;
			margin-left: auto;
		}

		.group-btn {
			display: inline-block;
			padding: 8px 15px;
			background-color: #4a76a8;
			color: white;
			border: none;
			border-radius: 5px;
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s;
			margin-left: 10px;
		}

		.group-btn:hover {
			background-color: #3a5b80;
		}

		.dark-mode .group-btn {
			background-color: #5a86b8;
		}

		.dark-mode .group-btn:hover {
			background-color: #4a76a8;
		}

		.group-btn.secondary {
			background-color: transparent;
			color: #4a76a8;
			border: 1px solid #4a76a8;
		}

		.group-btn.secondary:hover {
			background-color: rgba(74, 118, 168, 0.1);
		}

		.dark-mode .group-btn.secondary {
			color: #5a86b8;
			border-color: #5a86b8;
		}

		.dark-mode .group-btn.secondary:hover {
			background-color: rgba(90, 134, 184, 0.1);
		}

		.group-content {
			display: flex;
			gap: 30px;
		}

		.group-main {
			flex: 1;
		}

		.group-sidebar {
			width: 300px;
			flex-shrink: 0;
		}
		
		.group-sidebar .content-section {
			padding: 15px;
		}
		
		.group-sidebar .section-title {
			margin-top: 0;
		}

		.content-section {
			background-color: #fff;
			border-radius: 10px;
			margin-bottom: 20px;
			padding: 15px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}

		.dark-mode .content-section {
			background-color: #2d2d2d;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
		}

		.section-title {
			font-size: 18px;
			font-weight: 600;
			margin-bottom: 15px;
			color: #333;
			border-bottom: 1px solid #eee;
			padding-bottom: 10px;
			text-align: left; /* Выравнивание по левому краю */
			display: flex;
			align-items: baseline; /* Выравниваем элементы по базовой линии */
		}

		.section-title .members-count {
			font-size: 18px;
			font-weight: normal;
			margin-left: 5px;
		}

		.dark-mode .section-title {
			color: #f5f5f5;
			border-bottom-color: #444;
		}

		.members-list {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
			gap: 15px;
		}

		.member-item {
			text-align: center;
			cursor: pointer;
		}

		.member-avatar {
			width: 60px;
			height: 60px;
			border-radius: 50%;
			overflow: hidden;
			margin: 0 auto 5px;
			background-color: #eee;
		}

		.dark-mode .member-avatar {
			background-color: #3d3d3d;
		}

		.member-avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.member-name {
			font-size: 12px;
			color: #333;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.dark-mode .member-name {
			color: #ddd;
		}

		.member-role {
			font-size: 11px;
			color: #888;
		}

		.dark-mode .member-role {
			color: #999;
		}

		.posts-list {
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.loading-indicator {
			text-align: center;
			padding: 50px 0;
			color: #888;
			font-size: 16px;
		}

		.dark-mode .loading-indicator {
			color: #999;
		}

		.loading-indicator i {
			margin-right: 10px;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}

		.error-message {
			text-align: center;
			padding: 50px 0;
			color: #e74c3c;
			font-size: 16px;
		}

		.dark-mode .error-message {
			color: #ff6b6b;
		}

		.error-message i {
			margin-right: 10px;
		}

		@media (max-width: 992px) {
			.group-content {
				flex-direction: column;
			}

			.group-sidebar {
				width: 100%;
				order: -1; /* Размещаем сайдбар перед основным контентом */
			}
			
			.group-main {
				order: 1; /* Размещаем основной контент после сайдбара */
			}
		}

		@media (max-width: 768px) {
			.group-info {
				flex-direction: column;
				align-items: center;
				text-align: center;
			}

			.group-avatar {
				margin-right: 0;
				margin-bottom: 20px;
			}

			.group-meta {
				justify-content: center;
				flex-wrap: wrap;
			}

			.group-actions {
				margin-left: 0;
				margin-top: 20px;
				justify-content: center;
			}
		}

		.empty-state {
			text-align: center;
			padding: 50px 0;
			color: #888;
			font-size: 16px;
		}

		.dark-mode .empty-state {
			color: #999;
		}

		.empty-state i {
			margin-right: 10px;
		}

		/* Стили для модального окна редактирования */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: rgba(0, 0, 0, 0.5);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			opacity: 0;
			visibility: hidden;
			transition: opacity 0.3s, visibility 0.3s;
		}

		.modal-overlay.active {
			opacity: 1;
			visibility: visible;
		}

		.members-modal-container {
			background-color: #fff;
			border-radius: 10px;
			width: 90%;
			max-width: 600px;
			max-height: 90vh;
			overflow-y: auto;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
			position: relative;
			display: flex;
			flex-direction: column;
			opacity: 0;
			transition: opacity 0.3s ease, transform 0.3s ease;
			transform: translateY(-20px);
		}

		.dark-mode .members-modal-container {
			background-color: #2d2d2d;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
		}

		.modal-overlay.active .members-modal-container {
			opacity: 1;
			transform: translateY(0);
		}

		.members-modal-header {
			padding: 15px 20px;
			border-bottom: 1px solid #eee;
			display: flex;
			justify-content: space-between;
			align-items: center;
			position: sticky;
			top: 0;
			background-color: inherit;
			z-index: 10;
		}

		.dark-mode .members-modal-header {
			border-bottom-color: #444;
		}

		.members-modal-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
		}

		.dark-mode .members-modal-title {
			color: #f5f5f5;
		}

		.members-modal-close {
			background: none;
			border: none;
			color: #888;
			font-size: 20px;
			cursor: pointer;
		}

		.dark-mode .members-modal-close {
			color: #bbb;
		}

		.members-modal-body {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
}

		/* Адаптивные стили для модального окна участников на маленьких экранах */
		@media (max-width: 768px) {
			.members-modal-container {
				width: 95%;
				max-height: 80vh;
			}
			
			.members-modal-list {
				grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
				gap: 15px;
			}
			
			.members-modal-item {
				padding: 5px;
			}
			
			.members-modal-item:active {
				background-color: rgba(0, 0, 0, 0.05);
				border-radius: 8px;
			}
			
			.dark-mode .members-modal-item:active {
				background-color: rgba(255, 255, 255, 0.1);
			}
			
			.members-modal-avatar {
				width: 70px;
				height: 70px;
			}
			
			.members-modal-name {
				font-size: 13px;
			}
			
			.members-modal-role {
				font-size: 11px;
			}
			
			.members-modal-header {
				padding: 12px 15px;
			}
			
			.members-modal-body {
				padding: 15px;
				-webkit-overflow-scrolling: touch; /* Плавный скроллинг на iOS */
			}
			
			.members-modal-title {
				font-size: 16px;
			}
			
			.members-modal-close {
				width: 32px;
				height: 32px;
				display: flex;
				align-items: center;
				justify-content: center;
				touch-action: manipulation; /* Улучшает отзывчивость на мобильных */
			}
		}

		@media (max-width: 480px) {
			.members-modal-container {
				width: 98%;
				border-radius: 8px;
				max-height: 90vh;
			}
			
			.members-modal-list {
				grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
				gap: 10px;
			}
			
			.members-modal-avatar {
				width: 60px;
				height: 60px;
				margin-bottom: 6px;
			}
			
			.members-modal-name {
				font-size: 12px;
			}
			
			.members-modal-role {
				font-size: 10px;
			}
			
			.tab-button {
				padding: 8px 10px;
				font-size: 12px;
				margin-right: 5px;
			}
			
			.members-modal-tabs {
				margin-bottom: 15px;
				position: sticky;
				top: 0;
				background-color: #fff;
				z-index: 2;
				padding-top: 5px;
				padding-bottom: 5px;
				border-radius: 0 0 8px 8px;
			}
			
			.dark-mode .members-modal-tabs {
				background-color: #2d2d2d;
			}
			
			.tab-button.active {
				position: relative;
			}
			
			.tab-button.active:after {
				content: '';
				position: absolute;
				bottom: -5px;
				left: 50%;
				transform: translateX(-50%);
				width: 5px;
				height: 5px;
				background-color: #4a76a8;
				border-radius: 50%;
			}
			
			.dark-mode .tab-button.active:after {
				background-color: #5a86b8;
			}
			
			.members-modal-body {
				padding: 12px;
			}
			
			.empty-tab-message {
				padding: 20px 0;
				font-size: 13px;
			}
		}

		@media (max-width: 360px) {
			.members-modal-list {
				grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
				gap: 8px;
			}
			
			.members-modal-avatar {
				width: 50px;
				height: 50px;
			}
			
			.members-modal-name {
				font-size: 11px;
			}
			
			.members-modal-role {
				font-size: 9px;
			}
			
			.members-modal-tabs {
				display: flex;
				justify-content: center;
				flex-wrap: wrap;
			}
			
			.tab-button {
				padding: 6px 8px;
				font-size: 11px;
				margin: 2px;
			}
			
			.members-modal-header {
				padding: 10px;
			}
			
			.members-modal-body {
				padding: 10px;
			}
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-label {
			display: block;
			margin-bottom: 8px;
			font-weight: 500;
			color: #333;
		}

		.dark-mode .form-label {
			color: #f5f5f5;
		}

		.form-input {
			width: 100%;
			padding: 10px 12px;
			border: 1px solid #ddd;
			border-radius: 5px;
			font-size: 14px;
			color: #333;
		}

		.dark-mode .delete-btn:disabled {
			background-color: #ff6b6b80;
		}

		/* Стили для элементов с префиксом edit-group */
		.edit-group-modal-container {
			background-color: white;
			border-radius: 8px;
			width: 90%;
			max-width: 600px;
			max-height: 90vh;
			overflow-y: auto;
			position: relative;
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
		}

		.dark-mode .edit-group-modal-container {
			background-color: #2c2c2c;
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
		}

		.edit-group-modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 15px 20px;
			border-bottom: 1px solid #eee;
		}

		.dark-mode .edit-group-modal-header {
			border-bottom-color: #444;
		}

		.edit-group-modal-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
			margin: 0;
		}

		.dark-mode .edit-group-modal-title {
			color: #fff;
		}

		.edit-group-modal-close {
			background: none;
			border: none;
			font-size: 24px;
			color: #999;
			cursor: pointer;
		}

		.edit-group-modal-close:hover {
			color: #333;
		}

		.dark-mode .edit-group-modal-close {
			color: #aaa;
		}

		.dark-mode .edit-group-modal-close:hover {
			color: #fff;
		}

		.edit-group-modal-body {
			padding: 20px;
		}

		.edit-group-modal-footer {
			display: flex;
			justify-content: flex-end;
			padding: 15px 20px;
			border-top: 1px solid #eee;
		}

		.dark-mode .edit-group-modal-footer {
			border-top-color: #444;
		}

		.edit-group-modal-btn {
			padding: 8px 16px;
			border-radius: 5px;
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			margin-left: 10px;
			transition: background-color 0.3s;
		}

		.edit-group-modal-btn-primary {
			background-color: #4a76a8;
			color: white;
			border: none;
		}

		.edit-group-modal-btn-primary:hover {
			background-color: #3d6598;
		}

		.dark-mode .edit-group-modal-btn-primary {
			background-color: #5a86b8;
		}

		.dark-mode .edit-group-modal-btn-primary:hover {
			background-color: #4a76a8;
		}

		.edit-group-modal-btn-secondary {
			background-color: transparent;
			color: #4a76a8;
			border: 1px solid #4a76a8;
		}

		.edit-group-modal-btn-secondary:hover {
			background-color: rgba(74, 118, 168, 0.1);
		}

		.dark-mode .edit-group-modal-btn-secondary {
			color: #5a86b8;
			border-color: #5a86b8;
		}

		.dark-mode .edit-group-modal-btn-secondary:hover {
			background-color: rgba(90, 134, 184, 0.1);
		}

		.edit-group-form-group {
			margin-bottom: 20px;
		}

		.edit-group-form-label {
			display: block;
			margin-bottom: 8px;
			font-weight: 500;
			color: #333;
		}

		.dark-mode .edit-group-form-label {
			color: #eee;
		}

		.edit-group-form-input {
			width: 100%;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 5px;
			font-size: 14px;
			color: #333;
			background-color: white;
		}

		.edit-group-form-textarea {
			min-height: 100px;
			resize: vertical;
		}

		.dark-mode .edit-group-form-input {
			border-color: #555;
			background-color: #3d3d3d;
			color: #eee;
		}

		.edit-group-image-upload {
			display: flex;
			flex-direction: column;
			align-items: center;
			margin-top: 10px;
		}

		.edit-group-image-preview {
			width: 100%;
			height: 150px;
			background-color: #f5f5f5;
			border: 2px dashed #ddd;
			border-radius: 5px;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
			cursor: pointer;
		}

		.dark-mode .edit-group-image-preview {
			background-color: #3d3d3d;
			border-color: #555;
		}

		.edit-group-image-preview img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.edit-group-image-preview i {
			font-size: 40px;
			color: #aaa;
		}

		.dark-mode .edit-group-image-preview i {
			color: #888;
		}

		.edit-group-upload-hint {
			margin-top: 5px;
			font-size: 12px;
			color: #888;
		}

		.dark-mode .edit-group-upload-hint {
			color: #aaa;
		}

		.edit-group-avatar-preview {
			width: 120px;
			height: 120px;
			border-radius: 50%;
			margin: 0 auto;
		}

		#edit-avatar-crop-container, #edit-cover-crop-container {
			max-width: 100%;
			height: 300px;
			overflow: hidden;
			margin-bottom: 15px;
		}

		.edit-group-crop-controls {
			display: flex;
			justify-content: space-between;
			margin-top: 15px;
		}

		.edit-group-crop-btn {
			padding: 8px 15px;
			border-radius: 5px;
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.edit-group-crop-btn-save {
			background-color: #4a76a8;
			color: white;
			border: none;
		}

		.edit-group-crop-btn-cancel {
			background-color: transparent;
			color: #666;
			border: 1px solid #ddd;
		}

		.dark-mode .edit-group-crop-btn-save {
			background-color: #5a86b8;
		}

		.dark-mode .edit-group-crop-btn-cancel {
			color: #bbb;
			border-color: #555;
		}

		/* Стили для блока удаления группы с префиксом edit-group */
		.edit-group-delete-section {
			margin-top: 30px;
			padding-top: 20px;
			border-top: 1px solid #eee;
		}

		.dark-mode .edit-group-delete-section {
			border-top-color: #444;
		}

		.edit-group-delete-title {
			color: #e74c3c;
			font-size: 16px;
			font-weight: 600;
			margin-bottom: 15px;
		}

		.dark-mode .edit-group-delete-title {
			color: #ff6b6b;
		}

		.edit-group-delete-instructions {
			font-size: 14px;
			color: #666;
			margin-bottom: 15px;
			line-height: 1.5;
		}

		.dark-mode .edit-group-delete-instructions {
			color: #bbb;
		}

		.edit-group-delete-confirmation {
			margin-bottom: 15px;
		}

		.edit-group-delete-btn {
			background-color: #e74c3c;
			color: white;
			border: none;
			padding: 8px 15px;
			border-radius: 5px;
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.edit-group-delete-btn:hover {
			background-color: #c0392b;
		}

		.edit-group-delete-btn:disabled {
			background-color: #e74c3c80;
			cursor: not-allowed;
		}

		.dark-mode .edit-group-delete-btn {
			background-color: #ff6b6b;
		}

		.dark-mode .edit-group-delete-btn:hover {
			background-color: #e74c3c;
		}

		.dark-mode .edit-group-delete-btn:disabled {
			background-color: #ff6b6b80;
		}

		/* Добавим стили для модального окна участников и табов */
		.members-modal-tabs {
			max-width: 1200px;
			margin: 20px auto;
			padding: 0 20px;
			overflow: hidden;
		}

		.group-header {
			position: relative;
			border-radius: 10px;
			overflow: hidden;
			margin-bottom: 30px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			background-color: #f8f8f8;
		}

		.dark-mode .group-header {
			background-color: #2d2d2d;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
		}

		.group-cover {
			height: 250px;
			background-color: #eee;
			position: relative;
			overflow: hidden;
		}

		.dark-mode .group-cover {
			background-color: #3d3d3d;
		}

		.group-cover img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.group-info {
			padding: 20px;
			position: relative;
			display: flex;
			align-items: center;
		}

		.group-avatar {
			width: 120px;
			height: 120px;
			border-radius: 50%;
			overflow: hidden;
			margin-right: 20px;
			background-color: #eee;
			border: 4px solid #fff;
			margin-top: -60px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			flex-shrink: 0;
		}

		.dark-mode .group-avatar {
			background-color: #3d3d3d;
			border-color: #2d2d2d;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
		}

		.group-avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.group-details {
			flex: 1;
		}

		.group-name {
			font-size: 28px;
			font-weight: 600;
			margin-bottom: 10px;
			color: #333;
		}

		.dark-mode .group-name {
			color: #f5f5f5;
		}

		.group-description {
			font-size: 16px;
			color: #666;
			margin-bottom: 15px;
			line-height: 1.5;
		}

		.dark-mode .group-description {
			color: #bbb;
		}

		.group-meta {
			display: flex;
			align-items: center;
			font-size: 14px;
			color: #888;
		}

		.dark-mode .group-meta {
			color: #999;
		}

		.group-meta-item {
			display: flex;
			align-items: center;
			margin-right: 20px;
		}

		.group-meta-item i {
			margin-right: 5px;
		}

		.group-actions {
			display: flex;
			justify-content: flex-end;
			margin-left: auto;
		}

		.group-btn {
			display: inline-block;
			padding: 8px 15px;
			background-color: #4a76a8;
			color: white;
			border: none;
			border-radius: 5px;
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s;
			margin-left: 10px;
		}

		.group-btn:hover {
			background-color: #3a5b80;
		}

		.dark-mode .group-btn {
			background-color: #5a86b8;
		}

		.dark-mode .group-btn:hover {
			background-color: #4a76a8;
		}

		.group-btn.secondary {
			background-color: transparent;
			color: #4a76a8;
			border: 1px solid #4a76a8;
		}

		.group-btn.secondary:hover {
			background-color: rgba(74, 118, 168, 0.1);
		}

		.dark-mode .group-btn.secondary {
			color: #5a86b8;
			border-color: #5a86b8;
		}

		.dark-mode .group-btn.secondary:hover {
			background-color: rgba(90, 134, 184, 0.1);
		}

		.group-content {
			display: flex;
			gap: 30px;
		}

		.group-main {
			flex: 1;
		}

		.group-sidebar {
			width: 300px;
			flex-shrink: 0;
		}
		
		.group-sidebar .content-section {
			padding: 15px;
		}
		
		.group-sidebar .section-title {
			margin-top: 0;
		}

		.content-section {
			background-color: #fff;
			border-radius: 10px;
			margin-bottom: 20px;
			padding: 15px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}

		.dark-mode .content-section {
			background-color: #2d2d2d;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
		}

		.section-title {
			font-size: 18px;
			font-weight: 600;
			margin-bottom: 15px;
			color: #333;
			border-bottom: 1px solid #eee;
			padding-bottom: 10px;
			text-align: left; /* Выравнивание по левому краю */
			display: flex;
			align-items: baseline; /* Выравниваем элементы по базовой линии */
		}

		.section-title .members-count {
			font-size: 18px;
			font-weight: normal;
			margin-left: 5px;
		}

		.dark-mode .section-title {
			color: #f5f5f5;
			border-bottom-color: #444;
		}

		.members-list {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
			gap: 15px;
		}

		.member-item {
			text-align: center;
			cursor: pointer;
		}

		.member-avatar {
			width: 60px;
			height: 60px;
			border-radius: 50%;
			overflow: hidden;
			margin: 0 auto 5px;
			background-color: #eee;
		}

		.dark-mode .member-avatar {
			background-color: #3d3d3d;
		}

		.member-avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.member-name {
			font-size: 12px;
			color: #333;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.dark-mode .member-name {
			color: #ddd;
		}

		.member-role {
			font-size: 11px;
			color: #888;
		}

		.dark-mode .member-role {
			color: #999;
		}

		.posts-list {
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.loading-indicator {
			text-align: center;
			padding: 50px 0;
			color: #888;
			font-size: 16px;
		}

		.dark-mode .loading-indicator {
			color: #999;
		}

		.loading-indicator i {
			margin-right: 10px;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}

		.error-message {
			text-align: center;
			padding: 50px 0;
			color: #e74c3c;
			font-size: 16px;
		}

		.dark-mode .error-message {
			color: #ff6b6b;
		}

		.error-message i {
			margin-right: 10px;
		}

		@media (max-width: 992px) {
			.group-content {
				flex-direction: column;
			}

			.group-sidebar {
				width: 100%;
				order: -1; /* Размещаем сайдбар перед основным контентом */
			}
			
			.group-main {
				order: 1; /* Размещаем основной контент после сайдбара */
			}
		}

		@media (max-width: 768px) {
			.group-info {
				flex-direction: column;
				align-items: center;
				text-align: center;
			}

			.group-avatar {
				margin-right: 0;
				margin-bottom: 20px;
			}

			.group-meta {
				justify-content: center;
				flex-wrap: wrap;
			}

			.group-actions {
				margin-left: 0;
				margin-top: 20px;
				justify-content: center;
			}
		}

		.empty-state {
			text-align: center;
			padding: 50px 0;
			color: #888;
			font-size: 16px;
		}

		.dark-mode .empty-state {
			color: #999;
		}

		.empty-state i {
			margin-right: 10px;
		}

		/* Стили для модального окна редактирования */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: rgba(0, 0, 0, 0.5);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			opacity: 0;
			visibility: hidden;
			transition: opacity 0.3s, visibility 0.3s;
		}

		.modal-overlay.active {
			opacity: 1;
			visibility: visible;
		}

		.members-modal-container {
			background-color: #fff;
			border-radius: 10px;
			width: 90%;
			max-width: 600px;
			max-height: 90vh;
			overflow-y: auto;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
			position: relative;
			display: flex;
			flex-direction: column;
			opacity: 0;
			transition: opacity 0.3s ease, transform 0.3s ease;
			transform: translateY(-20px);
		}

		.dark-mode .members-modal-container {
			background-color: #2d2d2d;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
		}

		.modal-overlay.active .members-modal-container {
			opacity: 1;
			transform: translateY(0);
		}

		.members-modal-header {
			padding: 15px 20px;
			border-bottom: 1px solid #eee;
			display: flex;
			justify-content: space-between;
			align-items: center;
			position: sticky;
			top: 0;
			background-color: inherit;
			z-index: 10;
		}

		.dark-mode .members-modal-header {
			border-bottom-color: #444;
		}

		.members-modal-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
		}

		.dark-mode .members-modal-title {
			color: #f5f5f5;
		}

		.members-modal-close {
			background: none;
			border: none;
			color: #888;
			font-size: 20px;
			cursor: pointer;
		}

		.dark-mode .members-modal-close {
			color: #bbb;
		}

		.members-modal-body {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
}

		/* Адаптивные стили для модального окна участников на маленьких экранах */
		@media (max-width: 768px) {
			.members-modal-container {
				width: 95%;
				max-height: 80vh;
			}
			
			.members-modal-list {
				grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
				gap: 15px;
			}
			
			.members-modal-item {
				padding: 5px;
			}
			
			.members-modal-item:active {
				background-color: rgba(0, 0, 0, 0.05);
				border-radius: 8px;
			}
			
			.dark-mode .members-modal-item:active {
				background-color: rgba(255, 255, 255, 0.1);
			}
			
			.members-modal-avatar {
				width: 70px;
				height: 70px;
			}
			
			.members-modal-name {
				font-size: 13px;
			}
			
			.members-modal-role {
				font-size: 11px;
			}
			
			.members-modal-header {
				padding: 12px 15px;
			}
			
			.members-modal-body {
				padding: 15px;
				-webkit-overflow-scrolling: touch; /* Плавный скроллинг на iOS */
			}
			
			.members-modal-title {
				font-size: 16px;
			}
			
			.members-modal-close {
				width: 32px;
				height: 32px;
				display: flex;
				align-items: center;
				justify-content: center;
				touch-action: manipulation; /* Улучшает отзывчивость на мобильных */
			}
		}

		@media (max-width: 480px) {
			.members-modal-container {
				width: 98%;
				border-radius: 8px;
				max-height: 90vh;
			}
			
			.members-modal-list {
				grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
				gap: 10px;
			}
			
			.members-modal-avatar {
				width: 60px;
				height: 60px;
				margin-bottom: 6px;
			}
			
			.members-modal-name {
				font-size: 12px;
			}
			
			.members-modal-role {
				font-size: 10px;
			}
			
			.tab-button {
				padding: 8px 10px;
				font-size: 12px;
				margin-right: 5px;
			}
			
			.members-modal-tabs {
				margin-bottom: 15px;
				position: sticky;
				top: 0;
				background-color: #fff;
				z-index: 2;
				padding-top: 5px;
				padding-bottom: 5px;
				border-radius: 0 0 8px 8px;
			}
			
			.dark-mode .members-modal-tabs {
				background-color: #2d2d2d;
			}
			
			.tab-button.active {
				position: relative;
			}
			
			.tab-button.active:after {
				content: '';
				position: absolute;
				bottom: -5px;
				left: 50%;
				transform: translateX(-50%);
				width: 5px;
				height: 5px;
				background-color: #4a76a8;
				border-radius: 50%;
			}
			
			.dark-mode .tab-button.active:after {
				background-color: #5a86b8;
			}
			
			.members-modal-body {
				padding: 12px;
			}
			
			.empty-tab-message {
				padding: 20px 0;
				font-size: 13px;
			}
		}

		@media (max-width: 360px) {
			.members-modal-list {
				grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
				gap: 8px;
			}
			
			.members-modal-avatar {
				width: 50px;
				height: 50px;
			}
			
			.members-modal-name {
				font-size: 11px;
			}
			
			.members-modal-role {
				font-size: 9px;
			}
			
			.members-modal-tabs {
				display: flex;
				justify-content: center;
				flex-wrap: wrap;
			}
			
			.tab-button {
				padding: 6px 8px;
				font-size: 11px;
				margin: 2px;
			}
			
			.members-modal-header {
				padding: 10px;
			}
			
			.members-modal-body {
				padding: 10px;
			}
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-label {
			display: block;
			margin-bottom: 8px;
			font-weight: 500;
			color: #333;
		}

		.dark-mode .form-label {
			color: #f5f5f5;
		}

		.form-input {
			width: 100%;
			padding: 10px 12px;
			border: 1px solid #ddd;
			border-radius: 5px;
			font-size: 14px;
			color: #333;
		}

		.dark-mode .form-input {
			background-color: #3d3d3d;
			border-color: #555;
			color: #f5f5f5;
		}

		.form-input:focus {
			border-color: #4a76a8;
			outline: none;
		}

		.dark-mode .form-input:focus {
			border-color: #5a86b8;
		}

		.form-textarea {
			min-height: 100px;
			resize: vertical;
		}

		.modal-footer {
			padding: 15px 20px;
			border-top: 1px solid #eee;
			display: flex;
			justify-content: flex-end;
			gap: 10px;
			position: sticky;
			bottom: 0;
			background-color: inherit;
			z-index: 10;
		}

		.dark-mode .modal-footer {
			border-top-color: #444;
		}

		.modal-btn {
			padding: 8px 15px;
			border-radius: 5px;
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.modal-btn.primary {
			background-color: #4a76a8;
			color: white;
			border: none;
		}

		.modal-btn.primary:hover {
			background-color: #3a5b80;
		}

		.dark-mode .modal-btn.primary {
			background-color: #5a86b8;
		}

		.dark-mode .modal-btn.primary:hover {
			background-color: #4a76a8;
		}

		.modal-btn.secondary {
			background-color: transparent;
			color: #4a76a8;
			border: 1px solid #4a76a8;
		}

		.modal-btn.secondary:hover {
			background-color: rgba(74, 118, 168, 0.1);
		}

		.dark-mode .modal-btn.secondary {
			color: #5a86b8;
			border-color: #5a86b8;
		}

		.dark-mode .modal-btn.secondary:hover {
			background-color: rgba(90, 134, 184, 0.1);
		}

		.image-upload {
			display: flex;
			flex-direction: column;
			align-items: center;
			margin-top: 10px;
		}

		.image-preview {
			width: 100%;
			height: 150px;
			background-color: #f5f5f5;
			border: 2px dashed #ddd;
			border-radius: 5px;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
			cursor: pointer;
		}

		.dark-mode .image-preview {
			background-color: #3d3d3d;
			border-color: #555;
		}

		.image-preview img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.image-preview i {
			font-size: 40px;
			color: #aaa;
		}

		.dark-mode .image-preview i {
			color: #888;
		}

		.upload-hint {
			margin-top: 5px;
			font-size: 12px;
			color: #888;
		}

		.dark-mode .upload-hint {
			color: #aaa;
		}

		.avatar-preview {
			width: 120px;
			height: 120px;
			border-radius: 50%;
			margin: 0 auto;
		}

		#avatar-crop-container, #cover-crop-container {
			max-width: 100%;
			height: 300px;
			overflow: hidden;
			margin-bottom: 15px;
		}

		.crop-controls {
			display: flex;
			justify-content: space-between;
			margin-top: 15px;
		}

		.crop-btn {
			padding: 8px 15px;
			border-radius: 5px;
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.crop-btn.save {
			background-color: #4a76a8;
			color: white;
			border: none;
		}

		.crop-btn.cancel {
			background-color: transparent;
			color: #666;
			border: 1px solid #ddd;
		}

		.dark-mode .crop-btn.save {
			background-color: #5a86b8;
		}

		.dark-mode .crop-btn.cancel {
			color: #bbb;
			border-color: #555;
		}

		/* Стили для блока удаления группы */
		.delete-group-section {
			margin-top: 30px;
			padding-top: 20px;
			border-top: 1px solid #eee;
		}

		.dark-mode .delete-group-section {
			border-top-color: #444;
		}

		.delete-group-title {
			color: #e74c3c;
			font-size: 16px;
			font-weight: 600;
			margin-bottom: 15px;
		}

		.dark-mode .delete-group-title {
			color: #ff6b6b;
		}

		.delete-group-instructions {
			font-size: 14px;
			color: #666;
			margin-bottom: 15px;
			line-height: 1.5;
		}

		.dark-mode .delete-group-instructions {
			color: #bbb;
		}

		.delete-group-confirmation {
			margin-bottom: 15px;
		}

		.delete-btn {
			background-color: #e74c3c;
			color: white;
			border: none;
			padding: 8px 15px;
			border-radius: 5px;
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.delete-btn:hover {
			background-color: #c0392b;
		}

		.delete-btn:disabled {
			background-color: #e74c3c80;
			cursor: not-allowed;
		}

		.dark-mode .delete-btn {
			background-color: #ff6b6b;
		}

		.dark-mode .delete-btn:hover {
			background-color: #e74c3c;
		}

		.dark-mode .delete-btn:disabled {
			background-color: #ff6b6b80;
		}

		/* Добавим стили для модального окна участников и табов */
		.members-modal-tabs {
			display: flex;
			margin-bottom: 20px;
			border-bottom: 1px solid #ddd;
		}

		.dark-mode .members-modal-tabs {
			border-bottom-color: #444;
		}

		.tab-button {
			padding: 10px 15px;
			background: none;
			border: none;
			border-bottom: 2px solid transparent;
			font-size: 14px;
			font-weight: 500;
			color: #666;
			cursor: pointer;
			transition: all 0.3s;
			margin-right: 10px;
		}

		.dark-mode .tab-button {
			color: #bbb;
		}

		.tab-button.active {
			color: #4a76a8;
			border-bottom-color: #4a76a8;
		}

		.dark-mode .tab-button.active {
			color: #5a86b8;
			border-bottom-color: #5a86b8;
		}

		.tab-content {
			display: none;
		}

		.tab-content.active {
			display: block;
		}

		.members-modal-list {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
			gap: 20px;
		}

		.members-modal-item {
			display: flex;
			flex-direction: column;
			align-items: center;
			cursor: pointer;
			transition: transform 0.2s, background-color 0.2s;
			border-radius: 10px;
			padding: 8px;
		}

		.members-modal-item:hover {
			transform: translateY(-5px);
			background-color: rgba(0, 0, 0, 0.03);
		}
		
		.dark-mode .members-modal-item:hover {
			background-color: rgba(255, 255, 255, 0.05);
		}

		.members-modal-avatar {
			width: 80px;
			height: 80px;
			border-radius: 50%;
			overflow: hidden;
			margin-bottom: 8px;
			background-color: #eee;
		}

		.dark-mode .members-modal-avatar {
			background-color: #3d3d3d;
		}

		.members-modal-avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.members-modal-name {
			font-size: 14px;
			font-weight: 500;
			color: #333;
			text-align: center;
			max-width: 100%;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.dark-mode .members-modal-name {
			color: #ddd;
		}

		.members-modal-role {
			font-size: 12px;
			color: #888;
			text-align: center;
		}

		.dark-mode .members-modal-role {
			color: #999;
		}

		.empty-tab-message {
			text-align: center;
			color: #888;
			padding: 30px 0;
		}

		.dark-mode .empty-tab-message {
			color: #999;
		}

		/* Стили для постов и создания постов */
		.post-item {
			background-color: #fff;
			border-radius: 10px;
			padding: 20px;
			margin-bottom: 20px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}

		.dark-mode .post-item {
			background-color: #2d2d2d;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
		}

		.post-header {
			display: flex;
			align-items: center;
			margin-bottom: 15px;
		}

		.post-author-avatar {
			width: 50px;
			height: 50px;
			border-radius: 50%;
			overflow: hidden;
			margin-right: 15px;
			background-color: #eee;
		}

		.dark-mode .post-author-avatar {
			background-color: #3d3d3d;
		}

		.post-author-avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.post-info {
			flex: 1;
		}

		.post-author-name {
			font-weight: 600;
			color: #333;
			margin-bottom: 3px;
		}

		.dark-mode .post-author-name {
			color: #f5f5f5;
		}

		.post-date {
			font-size: 12px;
			color: #888;
		}

		.dark-mode .post-date {
			color: #999;
		}

		.post-content {
			margin-bottom: 15px;
			color: #333;
			line-height: 1.5;
			word-wrap: break-word;
			overflow-wrap: break-word;
			word-break: break-word;
			hyphens: auto;
			max-width: 100%;
			overflow: hidden;
		}

		.dark-mode .post-content {
			color: #ddd;
		}

		.post-image {
			width: 100%;
			max-height: 400px;
			object-fit: contain;
			border-radius: 8px;
			margin-bottom: 15px;
		}

		.post-actions {
			display: flex;
			align-items: center;
			border-top: 1px solid #eee;
			padding-top: 15px;
			color: #666;
		}

		.dark-mode .post-actions {
			border-top-color: #333;
		}

		.post-action-btn {
			display: flex;
			align-items: center;
			background: none;
			border: none;
			color: #666;
			font-size: 14px;
			padding: 5px 10px;
			margin-right: 15px;
			cursor: pointer;
			transition: color 0.3s;
		}

		.dark-mode .post-action-btn {
			color: #bbb;
		}

		.post-action-btn:hover {
			color: #4a76a8;
		}

		.dark-mode .post-action-btn:hover {
			color: #5a86b8;
		}

		.post-action-btn i {
			margin-right: 5px;
		}

		.create-post-container {
			display: flex;
			justify-content: flex-end;
			margin-bottom: 20px;
		}

		.create-post-btn, .propose-post-btn {
			display: inline-flex;
			align-items: center;
			padding: 8px 15px;
			background-color: #4a76a8;
			color: white;
			border: none;
			border-radius: 5px;
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s;
			margin-left: 10px;
		}

		.create-post-btn:hover, .propose-post-btn:hover {
			background-color: #3a5b80;
		}

		.dark-mode .create-post-btn, .dark-mode .propose-post-btn {
			background-color: #5a86b8;
		}

		.dark-mode .create-post-btn:hover, .dark-mode .propose-post-btn:hover {
			background-color: #4a76a8;
		}

		.create-post-btn i, .propose-post-btn i {
			margin-right: 5px;
		}

		.post-image-preview {
			width: 100%;
			height: 200px;
			background-color: #f5f5f5;
			border: 2px dashed #ddd;
			border-radius: 5px;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
			cursor: pointer;
			margin-top: 10px;
		}

		.dark-mode .post-image-preview {
			background-color: #3d3d3d;
			border-color: #555;
		}

		.post-image-preview img {
			width: 100%;
			height: 100%;
			object-fit: contain;
		}

		.post-image-preview i {
			font-size: 40px;
			color: #aaa;
		}

		.dark-mode .post-image-preview i {
			color: #888;
		}

		.post-tabs {
			display: flex;
			margin-bottom: 20px;
			border-bottom: 1px solid #ddd;
		}

		.dark-mode .post-tabs {
			border-bottom-color: #444;
		}

		.post-tab {
			padding: 10px 15px;
			background: none;
			border: none;
			border-bottom: 2px solid transparent;
			font-size: 14px;
			font-weight: 500;
			color: #666;
			cursor: pointer;
			transition: all 0.3s;
			margin-right: 10px;
		}

		.dark-mode .post-tab {
			color: #bbb;
		}

		.post-tab.active {
			color: #4a76a8;
			border-bottom-color: #4a76a8;
		}

		.dark-mode .post-tab.active {
			color: #5a86b8;
			border-bottom-color: #5a86b8;
		}

		.pending-post-item {
			border-left: 3px solid #f39c12;
			height: auto;
			min-height: 100px;
		}

		.dark-mode .pending-post-item {
			border-left-color: #f5b041;
		}

		.pending-post-status {
			display: flex;
			flex-wrap: wrap;
			justify-content: space-between;
			margin-top: 10px;
			padding-top: 10px;
			border-top: 1px solid #eee;
			gap: 10px;
		}

		.pending-post-info {
			flex: 1;
			min-width: 180px;
			word-wrap: break-word;
			overflow-wrap: break-word;
		}

		.pending-post-actions {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}

		.dark-mode .pending-post-status {
			border-top-color: #444;
		}

		.approve-btn, .reject-btn {
			padding: 5px 10px;
			border-radius: 4px;
			font-size: 13px;
			font-weight: 500;
			cursor: pointer;
		}

		.approve-btn {
			background-color: #2ecc71;
			color: white;
			border: none;
		}

		.approve-btn:hover {
			background-color: #27ae60;
		}

		.reject-btn {
			background-color: #e74c3c;
			color: white;
			border: none;
		}

		.reject-btn:hover {
			background-color: #c0392b;
		}

		.pending-badge {
			display: inline-block;
			background-color: #f39c12;
			color: white;
			font-size: 12px;
			padding: 2px 8px;
			border-radius: 10px;
			margin-left: 10px;
		}

		.dark-mode .pending-badge {
			background-color: #f5b041;
			color: #333;
		}

		/* Стили для блока создания поста */
		.create-post-inline {
			display: flex;
			flex-wrap: wrap;
			align-items: flex-start;
			padding: 15px;
			background-color: #fff;
			border-radius: 10px;
			margin-bottom: 20px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}

		.dark-mode .create-post-inline {
			background-color: #2d2d2d;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
		}

		.create-post-inline .post-author-avatar {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			overflow: hidden;
			margin-right: 15px;
			background-color: #eee;
			flex-shrink: 0;
		}

		.dark-mode .create-post-inline .post-author-avatar {
			background-color: #3d3d3d;
		}

		.create-post-inline .post-author-avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.post-input-area {
			flex: 1;
			display: flex;
			flex-direction: column;
		}

		#inline-post-content {
			width: 100%;
			padding: 10px 15px;
			border: 1px solid #ddd;
			border-radius: 20px;
			font-size: 14px;
			resize: none;
			min-height: 40px; /* Примерная высота как у поля ввода */
			line-height: 1.4;
			margin-bottom: 10px;
			background-color: #f0f2f5;
			color: #333;
			transition: min-height 0.2s ease;
		}

		.dark-mode #inline-post-content {
			background-color: #3a3b3c;
			border-color: #444;
			color: #e4e6eb;
		}

		#inline-post-content::placeholder {
			color: #666;
		}

		.dark-mode #inline-post-content::placeholder {
			color: #aaa;
		}

		#inline-post-content:focus {
			outline: none;
			border-color: #aaa;
			min-height: 80px; /* Увеличиваем высоту при фокусе */
		}

		.dark-mode #inline-post-content:focus {
			border-color: #666;
		}

		.post-inline-actions {
			display: flex;
			justify-content: flex-end;
			align-items: center;
		}

		.post-inline-attach-btn,
		.post-inline-send-btn {
			background: none;
			border: none;
			color: #4a76a8; /* Цвет как у основных кнопок */
			font-size: 14px; /* Размер шрифта как у других кнопок */
			font-weight: 500; /* Сделать текст жирнее */
			cursor: pointer;
			padding: 8px 15px; /* Добавим отступы */
			border-radius: 20px; /* Скруглим углы */
			background-color: #e7f3ff; /* Легкий фон для акцента */
			margin-left: 10px;
			transition: background-color 0.3s, color 0.3s;
			display: inline-flex; /* Для выравнивания иконки и текста */
			align-items: center;
		}

		.dark-mode .post-inline-attach-btn,
		.dark-mode .post-inline-send-btn {
			color: #5a86b8;
			background-color: #3a3b3c;
		}

		.post-inline-attach-btn:hover,
		.post-inline-send-btn:hover {
			background-color: #d0e7ff; /* Чуть темнее фон при наведении */
		}

		.dark-mode .post-inline-attach-btn:hover,
		.dark-mode .post-inline-send-btn:hover {
			background-color: #4f4f4f;
		}

		.post-inline-send-btn:disabled {
			background-color: #f0f2f5;
			color: #bdc1c6;
			cursor: not-allowed;
		}

		.dark-mode .post-inline-send-btn:disabled {
			background-color: #242526;
			color: #555;
		}

		.post-inline-send-btn i {
			margin-right: 5px; /* Отступ между иконкой и текстом */
		}
		
		/* Стили для адаптивности на мобильных устройствах */
		@media (max-width: 768px) {
			.create-post-inline {
				padding: 10px;
			}
			
			.post-inline-actions {
				flex-direction: column;
				align-items: flex-start !important;
				gap: 10px;
			}
			
			.post-inline-actions > div {
				width: 100%;
			}
			
			.image-upload-container {
				justify-content: space-between;
				width: 100%;
			}
			
			.image-upload-button span {
				display: none; /* Скрываем текст кнопки на маленьких экранах */
			}
			
			.image-upload-button {
				padding: 8px 12px;
			}
			
			.post-inline-send-btn {
				padding: 8px 12px;
			}
			
			/* Стили для адаптивности comment-form-content и comment-form-buttons */
			.comment-form-content {
				width: 100%;
			}
			
			.comment-form-buttons {
				flex-wrap: wrap;
				gap: 8px;
			}
			
			.comment-form button.secondary,
			.comment-form button.primary {
				width: auto;
				flex: 1;
				min-width: 100px;
				white-space: nowrap;
				padding: 8px 10px;
				font-size: 13px;
			}
			
			.comment-form .image-upload-button span {
				display: none;
			}
			
			.reply-form .comment-form-buttons {
				flex-wrap: wrap;
				gap: 8px;
			}
			
			.reply-form button.secondary,
			.reply-form button.primary {
				width: auto;
				flex: 1;
				min-width: 100px;
				white-space: nowrap;
				padding: 8px 10px;
				font-size: 13px;
			}
			
			.reply-form .image-upload-button span {
				display: none;
			}
		}
		
		@media (max-width: 480px) {
			.create-post-inline .post-author-avatar {
				width: 30px;
				height: 30px;
				margin-right: 10px;
			}
			
			.post-input-area {
				width: calc(100% - 40px);
			}
			
			#inline-post-content {
				padding: 8px 10px;
				font-size: 13px;
			}
			
			/* Дополнительные стили для comment-form-content на маленьких экранах */
			.comment-form-avatar {
				width: 30px;
				height: 30px;
			}
			
			.comment-form textarea {
				font-size: 13px;
				min-height: 45px;
			}
			
			.comment-form button {
				padding: 6px 10px;
				font-size: 12px;
			}
			
			.reply-form textarea {
				font-size: 13px;
				min-height: 45px;
			}
			
			.comment-form-buttons {
				justify-content: space-between;
			}
			
			.comment-form button.secondary,
			.comment-form button.primary {
				min-width: 80px;
			}
		}
		
		/* Для очень маленьких экранов скроем текст кнопок */
		@media (max-width: 360px) {
			.comment-form button span,
			.reply-form button span {
				display: none;
			}
			
			.comment-form button,
			.reply-form button {
				padding: 6px;
				min-width: 36px;
			}
			
			.comment-form button i,
			.reply-form button i {
				margin-right: 0;
			}
		}

		/* Медиа-запросы для адаптивности post-item и pending-post-item */
		@media (max-width: 768px) {
			.post-item {
				padding: 15px;
			}
			
			.post-header {
				flex-wrap: wrap;
			}
			
			.post-author-avatar {
				width: 40px;
				height: 40px;
			}
			
			.post-actions {
				flex-wrap: wrap;
				gap: 8px;
			}
			
			.pending-post-status {
				flex-direction: column;
			}
			
			.pending-post-info {
				margin-bottom: 10px;
			}
			
			.pending-post-actions {
				justify-content: flex-start;
			}
		}
		
		@media (max-width: 480px) {
			.post-item {
				padding: 12px;
			}
			
			.post-author-avatar {
				width: 35px;
				height: 35px;
				margin-right: 10px;
			}
			
			.post-author-name {
				font-size: 14px;
			}
			
			.post-date {
				font-size: 11px;
			}
			
			.post-content {
				font-size: 14px;
			}
			
			.post-action-btn {
				padding: 3px 8px;
				font-size: 12px;
			}
			
			.approve-btn, .reject-btn {
				padding: 4px 8px;
				font-size: 12px;
			}
		}

		.post-author-avatar, .post-author-name {
			transition: opacity 0.2s ease;
		}

		.post-author-avatar {
			cursor: pointer;
		}

		.post-author-name .author-link {
			cursor: pointer;
			transition: opacity 0.2s ease;
			display: inline-block; /* Чтобы эффект наведения не распространялся на весь блок */
			font-size: 12px;
			color: #888;
		}

		.post-author-name .author-name-text {
			display: inline-block; /* Чтобы эффект наведения не распространялся на другие элементы */
			cursor: pointer;
		}

		.post-author-avatar:hover, 
		.post-author-name .author-name-text:hover {
			opacity: 0.8;
		}

		.post-author-name .author-link:hover {
			opacity: 0.8;
		}

		.post-comments-section {
			display: none;
			margin-top: 10px;
			border-top: 1px solid #eee;
			padding-top: 10px;
		}
		
		.dark-mode .post-comments-section {
			border-top-color: #444;
		}
		
		.post-comments-section.active {
			display: block;
		}
		
		.comments-list {
			display: flex;
			flex-direction: column;
			gap: 15px;
			margin-bottom: 15px;
		}
		
		.comment {
			display: flex;
			gap: 10px;
			padding: 5px;
			border-radius: 10px;
			transition: background-color 0.3s;
		}
		
		.comment-avatar-link {
			text-decoration: none;
			flex-shrink: 0;
		}
		
		.comment-avatar {
			width: 36px;
			height: 36px;
			border-radius: 50%;
			object-fit: cover;
		}
		
		.comment-main {
			flex-grow: 1;
		}
		
		.comment-header {
			display: flex;
			align-items: center;
			margin-bottom: 5px;
		}
		
		.comment-author {
			font-weight: 500;
			color: #333;
			margin-right: 10px;
			text-decoration: none;
		}
		
		.dark-mode .comment-author {
			color: #f5f5f5;
		}
		
		.comment-date {
			font-size: 12px;
			color: #888;
		}
		
		.dark-mode .comment-date {
			color: #999;
		}
		
		.reply-info {
			font-size: 12px;
			color: #888;
			margin-bottom: 5px;
			padding: 2px 5px;
			background-color: rgba(0, 0, 0, 0.03);
			border-radius: 4px;
			display: inline-block;
			cursor: pointer;
		}
		
		.dark-mode .reply-info {
			color: #aaa;
			background-color: rgba(255, 255, 255, 0.05);
		}
		
		.reply-author {
			color: #4a76a8;
			font-weight: 500;
		}
		
		.dark-mode .reply-author {
			color: #5a86b8;
		}
		
		.reply-info-divider {
			margin: 0 5px;
			color: #ccc;
		}
		
		.dark-mode .reply-info-divider {
			color: #666;
		}
		
		.comment-content {
			margin-bottom: 8px;
			white-space: pre-wrap;
			word-break: break-word;
		}
		
		.comment-images {
			display: grid;
			gap: 5px;
			margin-bottom: 8px;
			grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
		}
		
		.comment-images.count-1 {
			grid-template-columns: minmax(0, 250px);
		}
		
		.comment-image-item {
			cursor: pointer;
			border-radius: 8px;
			overflow: hidden;
			aspect-ratio: 1;
			padding-bottom: 60%;
		}
		
		.comment-image-item img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}
		
		.comment-image-item .video-container {
			position: relative;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		
		.comment-image-item .video-container video {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}
		
		.comment-image-item .video-overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.2);
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
		}
		
		.comment-image-item .video-overlay::before {
			content: '\f144';
			font-family: 'Font Awesome 5 Free';
			font-size: 24px;
			color: #fff;
			opacity: 0.8;
		}
		
		.comment-votes {
			display: flex;
			align-items: center;
			gap: 10px;
			margin-bottom: 5px;
		}
		
		.reply-btn {
			background: none;
			border: none;
			color: #4a76a8;
			font-size: 12px;
			cursor: pointer;
			padding: 0;
			display: flex;
			align-items: center;
			gap: 5px;
		}
		
		.dark-mode .reply-btn {
			color: #5a86b8;
		}
		
		.reply-btn.delete {
			color: #e53935;
		}
		
		.dark-mode .reply-btn.delete {
			color: #f44336;
		}
		
		.reply-btn i {
			font-size: 12px;
		}
		
		.reply-form {
			display: none;
			gap: 10px;
			margin-top: 10px;
			margin-bottom: 5px;
		}
		
		.reply-form.active {
			display: flex;
		}
		
		.comment-replies {
			margin-left: 10px;
			margin-top: 10px;
			border-left: none;
			padding-left: 15px;
			display: flex;
			flex-direction: column;
			gap: 15px;
		}
		
		.dark-mode .comment-replies {
			border-left-color: #444;
		}
		
		.no-comments {
			color: #888;
			text-align: center;
			padding: 20px 0;
			font-style: italic;
		}
		
		.dark-mode .no-comments {
			color: #aaa;
		}

		.post-comments-section.always-visible {
			display: block;
		}
		
		/* Стили для скрытых ответов */
		.hidden-replies {
			overflow: hidden;
			max-height: 0;
			opacity: 0;
			transition: max-height 0.5s ease-in, opacity 0.3s ease-in;
		}
		
		.hidden-replies.expanded {
			max-height: none;
			opacity: 1;
			transition: max-height 0.5s ease-out, opacity 0.3s ease-out;
			border-left: 1px solid #eee;
			margin-left: -16px;
			padding-left: 15px;
		}
		
		.dark-mode .hidden-replies.expanded {
			border-left-color: #444;
		}
		
		/* Добавляем стили для анимации комментариев внутри скрытого контейнера */
		.hidden-replies .comment {
			opacity: 0;
			transform: translateY(10px);
			transition: opacity 0.3s ease-in, transform 0.3s ease-in;
		}
		
		.hidden-replies.expanded .comment {
			opacity: 1;
			transform: translateY(0);
			transition: opacity 0.3s ease-out, transform 0.3s ease-out;
		}
		
		/* Стили для кнопки "Показать ответы" */
		.show-more-replies {
			margin-top: 0.5rem;
			padding: 0.25rem 0.5rem;
			font-size: 0.85em;
			background: var(--bg-color, #f5f5f5);
			color: #4a76a8;
			border: 1px solid #e0e0e0;
			border-radius: 4px;
			cursor: pointer;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			width: auto;
			transition: background-color 0.2s;
			width: 250px;
		}
		
		.show-more-replies:hover {
			background: rgba(0, 0, 0, 0.03);
		}
		
		.show-more-replies i {
			margin-right: 0.5rem;
		}
		
		.dark-mode .show-more-replies {
			background: #333;
			color: #5a86b8;
			border-color: #444;
		}
		
		.dark-mode .show-more-replies:hover {
			background: #444;
		}
		
		/* Добавляем анимацию подсветки новых комментариев */
		@keyframes newCommentHighlight {
			0% {
				background: rgba(74, 118, 168, 0.2);
			}
			100% {
				background: transparent;
			}
		}
		
		/* Улучшаем подсветку при прокрутке к комментарию */
		@keyframes highlightComment {
			0% {
				background: transparent;
			}
			20% {
				background: rgba(74, 118, 168, 0.2);
			}
			80% {
				background: rgba(74, 118, 168, 0.2);
			}
			100% {
				background: transparent;
			}
		}
		
		.dark-mode .comment.new-comment {
			animation-name: darkModeNewCommentHighlight;
		}
		
		@keyframes darkModeNewCommentHighlight {
			0% {
				background: rgba(90, 134, 184, 0.2);
			}
			100% {
				background: transparent;
			}
		}
		
		/* Стили для загрузки изображений */
		.image-upload-container {
			display: flex;
			align-items: center;
			gap: 10px;
			margin-top: 5px;
		}
		
		.image-upload-button {
			background: none;
			border: none;
			color: #4a76a8;
			font-size: 12px;
			cursor: pointer;
			padding: 5px 10px;
			border-radius: 4px;
			display: flex;
			align-items: center;
			gap: 5px;
			transition: background-color 0.2s;
		}
		
		.image-upload-button:hover {
			background-color: rgba(74, 118, 168, 0.1);
		}
		
		.dark-mode .image-upload-button {
			color: #5a86b8;
		}
		
		.dark-mode .image-upload-button:hover {
			background-color: rgba(90, 134, 184, 0.2);
		}
		
		.image-upload-input {
			display: none;
		}
		
		.image-counter {
			font-size: 12px;
			color: #888;
		}
		
		.dark-mode .image-counter {
			color: #aaa;
		}
		
		.image-preview-container {
			display: none;
			margin-top: 10px;
			width: 100%;
		}
		
		.image-gallery {
			display: grid;
			grid-template-columns: repeat(5, 1fr);
			gap: 5px;
			margin-bottom: 5px;
		}
		
		.image-preview-item {
			position: relative;
			width: 100%;
			aspect-ratio: 1;
			border-radius: 4px;
			overflow: hidden;
		}
		
		.image-preview-item img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			display: block;
		}
		
		.remove-image-btn {
			position: absolute;
			top: 2px;
			right: 2px;
			width: 20px;
			height: 20px;
			background-color: rgba(0, 0, 0, 0.5);
			color: white;
			border: none;
			border-radius: 50%;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			font-size: 10px;
			transition: background-color 0.2s ease;
			z-index: 2;
		}
		
		.remove-image-btn:hover {
			background-color: rgba(255, 0, 0, 0.8);
		}
		
		.upload-spinner, .upload-error {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
			background-color: rgba(0, 0, 0, 0.4);
			z-index: 1;
		}
		
		.upload-error {
			background-color: rgba(255, 0, 0, 0.4);
		}
		
		.upload-spinner i, .upload-error i {
			color: white;
			font-size: 20px;
		}
		
		.image-preview-item.uploading img {
			opacity: 0.7;
		}
		
		.clear-all-images {
			background: none;
			border: none;
			color: #e53935;
			font-size: 12px;
			cursor: pointer;
			padding: 5px;
			border-radius: 4px;
			display: flex;
			align-items: center;
			gap: 5px;
			margin-left: auto;
		}
		
		.dark-mode .clear-all-images {
			color: #f44336;
		}
		
		.clear-all-images:hover {
			background-color: rgba(229, 57, 53, 0.1);
		}
		
		/* Стили для изображений в комментариях */
		.comment-images {
			display: grid;
			gap: 5px;
			margin: 5px 0;
			grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
		}
		
		.comment-images.count-1 {
			grid-template-columns: minmax(0, 250px);
		}
		
		.comment-image-item img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			transition: transform 0.2s;
		}
		
		.comment-image-item .video-container {
			position: relative;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		
		.comment-image-item .video-container video {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}
		
		.comment-image-item .video-overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.2);
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
		}
		
		.comment-image-item .video-overlay::before {
			content: '\f144';
			font-family: 'Font Awesome 5 Free';
			font-size: 24px;
			color: #fff;
			opacity: 0.8;
		}
		
		.comment-image-item:hover img {
			transform: scale(1.05);
		}
		
		.dark-mode .post-comments-section .delete-comment-button:hover {
			color: #e57373;
		}
		
		.image-nav-button {
			width: 50px;
			height: 50px;
			background-color: rgba(0, 0, 0, 0.5);
			border: none;
			border-radius: 50%;
			color: #fff;
			font-size: 20px;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			pointer-events: auto;
			transition: background-color 0.3s ease;
		}
		
		.image-nav-button:hover {
			background-color: rgba(0, 0, 0, 0.8);
		}
		
		.image-counter-indicator {
			position: absolute;
			bottom: 15px;
			left: 50%;
			transform: translateX(-50%);
			background-color: rgba(0, 0, 0, 0.6);
			color: #fff;
			padding: 5px 10px;
			border-radius: 15px;
			font-size: 14px;
			z-index: 1;
		}
		
		.dark-mode .image-modal {
			background-color: rgba(0, 0, 0, 0.9);
		}
		
		/* Стили для анимации загрузки */
		.modal-image-container.loading::after {
			content: '';
			position: absolute;
			width: 50px;
			height: 50px;
			border: 5px solid rgba(255, 255, 255, 0.3);
			border-top: 5px solid #fff;
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}
		
		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}
		
		/* Стили для галереи изображений в постах */
		.post-images {
			margin: 10px 0;
			display: revert;
			flex-wrap: wrap;
			gap: 5px;
		}
		
		.post-images-gallery {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
			grid-gap: 5px;
			margin: 10px 0;
		}
		
		.post-images-gallery.count-1 {
			grid-template-columns: minmax(0, 300px);
		}
		
		.post-images-gallery.count-2 {
			grid-template-columns: repeat(2, 1fr);
		}
		
		.post-images-gallery.count-3 {
			grid-template-columns: repeat(3, 1fr);
		}
		
		.post-images-gallery.count-4 {
			grid-template-columns: repeat(2, 1fr);
		}
		
		.post-images-gallery.count-5,
		.post-images-gallery.count-6 {
			grid-template-columns: repeat(3, 1fr);
		}
		
		.post-image-item {
			position: relative;
			overflow: hidden;
			border-radius: 8px;
			max-width: 500px;
		}
		
		.post-image-item img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			transition: transform 0.3s ease;
			cursor: pointer;
		}
		
		.post-image-item video {
			width: 100%;
			height: 100%;
			object-fit: cover;
			transition: transform 0.3s ease;
			cursor: pointer;
		}
		
		.post-image-item .video-container {
			position: relative;
			width: 100%;
			height: 100%;
			overflow: hidden;
			border-radius: 8px;
		}
		
		.post-image-item .video-overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.2);
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
		}
		
		.post-image-item .video-overlay::before {
			content: '\f144';
			font-family: 'Font Awesome 5 Free';
			font-size: 32px;
			color: #fff;
			opacity: 0.8;
		}
		
		.post-image-item:hover img {
			transform: scale(1.05);
		}
		
		/* Стили для модального окна просмотра изображений */
		.image-modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			z-index: 1000;
			justify-content: center;
			align-items: center;
			padding: 20px;
			box-sizing: border-box;
		}
		
		.dark-mode .image-modal {
			background: rgba(0, 0, 0, 0.9);
		}
		
		.light-mode .image-modal {
			background: rgba(0, 0, 0, 0.7);
		}
		
		.image-modal.active {
			display: flex;
		}
		
		.modal-content {
			display: flex;
			width: 100%;
			max-width: 1200px;
			height: 90vh;
			position: relative;
			background: var(--bg-color);
			border-radius: 8px;
			overflow: hidden;
		}
		
		.modal-image-container {
			flex: 2;
			display: flex;
			justify-content: center;
			align-items: center;
			max-height: 100%;
			overflow: hidden;
			min-width: 0;
			position: relative;
		}
		
		.modal-image {
			max-width: 100%;
			max-height: 100%;
			object-fit: contain;
		}
		
		.modal-video {
			max-width: 100%;
			max-height: 80vh;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			background-color: #000;
		}
		
		.close-modal {
			position: absolute;
			top: 20px;
			right: 20px;
			width: 40px;
			height: 40px;
			background: rgba(0, 0, 0, 0.5);
			border-radius: 50%;
			display: flex;
			justify-content: center;
			align-items: center;
			color: white;
			font-size: 30px;
			cursor: pointer;
			z-index: 1001;
			transition: background 0.3s ease;
		}
		
		.dark-mode .close-modal {
			background: rgba(0, 0, 0, 0.7);
		}
		
		.light-mode .close-modal {
			background: rgba(255, 255, 255, 0.3);
		}
		
		.close-modal:hover {
			background: rgba(255, 0, 0, 0.7);
			transform: scale(1.1);
		}
		
		.dark-mode .close-modal:hover {
			background: rgba(255, 0, 0, 0.7);
		}
		
		.light-mode .close-modal:hover {
			background: rgba(255, 0, 0, 0.7);
		}
		
		.image-nav-buttons {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0 20px;
			box-sizing: border-box;
			pointer-events: none;
		}
		
		.image-nav-button {
			width: 50px;
			height: 50px;
			background: rgba(0, 0, 0, 0.5);
			border-radius: 50%;
			display: flex;
			justify-content: center;
			align-items: center;
			color: white;
			font-size: 20px;
			cursor: pointer;
			transition: background 0.3s ease, transform 0.3s ease;
			pointer-events: auto;
		}
		
		.dark-mode .image-nav-button {
			background: rgba(0, 0, 0, 0.7);
		}
		
		.light-mode .image-nav-button {
			background: rgba(255, 255, 255, 0.3);
		}
		
		.image-nav-button.prev {
			margin-right: auto;
			transform: translateX(-10px);
		}
		
		.image-nav-button.next {
			margin-left: auto;
			transform: translateX(10px);
		}
		
		.image-nav-button:hover {
			background: rgba(0, 0, 0, 0.7);
			transform: scale(1.1);
		}
		
		.dark-mode .image-nav-button:hover {
			background: rgba(0, 0, 0, 0.9);
		}
		
		.light-mode .image-nav-button:hover {
			background: rgba(0, 0, 0, 0.6);
		}
		
		.image-nav-button.prev:hover {
			transform: translateX(-10px) scale(1.1);
		}
		
		.image-nav-button.next:hover {
			transform: translateX(10px) scale(1.1);
		}
		
		.image-counter-indicator {
			position: absolute;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(0, 0, 0, 0.5);
			color: white;
			padding: 8px 15px;
			border-radius: 30px;
			font-size: 14px;
			z-index: 1;
		}
		
		.dark-mode .image-counter-indicator {
			background: rgba(0, 0, 0, 0.7);
		}
		
		.light-mode .image-counter-indicator {
			background: rgba(0, 0, 0, 0.6);
		}
		
		@media (max-width: 768px) {
			.modal-content {
				flex-direction: column;
				height: auto;
				max-height: 90vh;
			}
			
			.modal-image-container {
				flex: 1;
				max-height: 70vh;
			}
			
			.dark-mode .modal-image-container {
				background: rgba(0, 0, 0, 0.8);
			}
			
			.light-mode .modal-image-container {
				background: rgba(255, 255, 255, 0.8);
			}
		}

		.image-modal .modal-content {
			position: relative;
			max-width: 90vw;
			max-height: 90vh;
			margin: 0 auto;
			text-align: center;
			margin-top: 5vh;
		}

		.image-modal .modal-image {
			max-width: 100%;
			max-height: 80vh;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			transition: opacity 0.3s ease;
		}

		.image-modal .modal-video {
			max-width: 100%;
			max-height: 80vh;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			transition: opacity 0.3s ease;
		}

		/* Стили для drag and drop изображений */
		.image-preview-item {
			position: relative;
			width: 80px;
			height: 80px;
			margin: 5px;
			border-radius: 8px;
			overflow: hidden;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			cursor: move;
			transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
		}

		.image-preview-item.dragging {
			z-index: 10;
			box-shadow: 0 5px 15px rgba(0,0,0,0.2);
		}

		.image-preview-item.drag-over {
			transform: scale(1.05);
			box-shadow: 0 8px 20px rgba(0,0,0,0.3);
			border: 2px dashed #4a89dc;
		}

		.image-gallery, .post-image-gallery {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			margin-bottom: 10px;
		}

		/* Обновленные стили для контейнера превью изображений */
		.image-preview-container, .post-image-preview-container {
			margin-top: 10px;
			padding: 10px;
			border-radius: 8px;
			background-color: var(--bg-secondary);
			border: 1px solid var(--border-color);
		}

		.image-preview-container.active, .post-image-preview-container.active {
			display: block;
		}
	</style>

	<script>
		(function () {
			const savedTheme = localStorage.getItem('theme');
			const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

			// Обновляем логику установки темы
			if (savedTheme === 'system') {
				document.documentElement.style.visibility = 'hidden';
				document.documentElement.classList.add(prefersDark ? 'dark-mode' : 'light-mode');

				document.addEventListener('DOMContentLoaded', () => {
					document.body.classList.add(prefersDark ? 'dark-mode' : 'light-mode');
					document.documentElement.classList.remove(prefersDark ? 'dark-mode' : 'light-mode');
					document.documentElement.style.visibility = 'visible';
				});
			} else {
				const theme = savedTheme || (prefersDark ? 'dark-mode' : 'light-mode');
				document.documentElement.style.visibility = 'hidden';
				document.documentElement.classList.add(theme);

				document.addEventListener('DOMContentLoaded', () => {
					document.body.classList.add(theme);
					document.documentElement.classList.remove(theme);
					document.documentElement.style.visibility = 'visible';
				});
			}

			// Добавляем слушатель изменения системной темы
			if (savedTheme === 'system') {
				window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
					document.body.classList.remove('dark-mode', 'light-mode');
					document.body.classList.add(e.matches ? 'dark-mode' : 'light-mode');
				});
			}
		})();
	</script>

	<script type="module">
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
		import {
			getAuth,
			onAuthStateChanged
		} from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
		import { 
			getDatabase, 
			ref, 
			get, 
			set,
			push,
			query,
			orderByChild,
			equalTo,
			onValue,
			update,
			remove,
			serverTimestamp,
			child
		} from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';
		import {
			getStorage,
			ref as storageRef,
			uploadBytes,
			uploadBytesResumable,
			getDownloadURL
		} from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js';
		import { initializeSidebar } from './sidebar.js'; // Добавляем импорт сайдбара

		// Инициализация Firebase
		const firebaseConfig = {
			apiKey: "AIzaSyCPQajYeeRG-GyQHhwlZ08nI5-BT36XpaU",
			authDomain: "ochat-9cfc9.firebaseapp.com",
			databaseURL: "https://ochat-9cfc9-default-rtdb.europe-west1.firebasedatabase.app",
			projectId: "ochat-9cfc9",
			storageBucket: "ochat-9cfc9.appspot.com",
			messagingSenderId: "190209379577",
			appId: "1:190209379577:web:a57171ab4b1f55a49f6628",
			measurementId: "G-KNRXS2ZKZ9"
		};

		const app = initializeApp(firebaseConfig);
		const auth = getAuth(app);
		const db = getDatabase(app);
		const storage = getStorage(app);

		// Вызов инициализации сайдбара после загрузки DOM
		document.addEventListener('DOMContentLoaded', () => {
		  initializeSidebar();
		  // Можно добавить другие инициализации сюда, если нужно
		});

		// Получение ID группы из URL
		const urlParams = new URLSearchParams(window.location.search);
		const groupId = urlParams.get('id');

		if (!groupId) {
			showError('ID группы не указан');
		} else {
			// Проверка авторизации
			onAuthStateChanged(auth, (user) => {
				if (user) {
					// Пользователь авторизован
					console.log('User is signed in:', user.uid);
					// Загружаем данные группы
					loadGroupData(groupId, user.uid);
				} else {
					// Пользователь не авторизован, перенаправляем на страницу входа
					console.log('User is not signed in');
					window.location.href = 'index.html';
				}
			});
		}

		// Функция для загрузки данных группы
		async function loadGroupData(groupId, userId) {
			try {
				// Получаем данные группы из Firebase
				const groupRef = ref(db, `groups/${groupId}`);
				const groupSnapshot = await get(groupRef);

				if (!groupSnapshot.exists()) {
					showError('Группа не найдена');
					return;
				}

				const groupData = groupSnapshot.val();
				groupData.id = groupId;

				// Обновляем заголовок страницы
				document.title = `${groupData.name} - Группа`;

				// Отображаем информацию о группе
				renderGroupInfo(groupData, userId);

				// Загружаем участников группы
				await loadGroupMembers(groupData);
                
                // Загружаем посты группы
                await loadGroupPosts(groupId, userId, groupData);

				// Сразу показываем контейнер с информацией о группе
				document.querySelector('.group-container').style.display = 'block';
				
				// Слушаем изменения в членах группы в реальном времени
				const groupMembersRef = ref(db, `groups/${groupId}/members`);
				onValue(groupMembersRef, (snapshot) => {
					if (snapshot.exists()) {
						const updatedMembers = snapshot.val();
						// Обновляем интерфейс при изменении состава участников
						loadGroupMembers({ ...groupData, members: updatedMembers });
						
						// Обновляем количество участников в шапке
						const memberCountEl = document.querySelector('.group-meta-item:first-child');
						const memberCount = Object.keys(updatedMembers).length;
						memberCountEl.innerHTML = `
							<i class="fas fa-users"></i> 
							${memberCount} 
							${getWordForm(memberCount, ['участник', 'участника', 'участников'])}
						`;
						
						// Обновляем кнопки действий
						updateActionButtons(updatedMembers, userId, groupId);
                        
                        // Обновляем секцию постов с учетом новой роли пользователя
                        // updatePostSection(updatedMembers[userId]?.role === 'admin', groupId); // Удаляем этот вызов
					}
				});
				
				// Слушаем изменения в информации о группе в реальном времени
				const groupInfoRef = ref(db, `groups/${groupId}`);
				onValue(groupInfoRef, (snapshot) => {
					if (snapshot.exists()) {
						const updatedGroupData = snapshot.val();
						updatedGroupData.id = groupId;
						
						// Обновляем заголовок страницы
						document.title = `${updatedGroupData.name} - Группа`;
						
						// Обновляем информацию о группе
						renderGroupInfo(updatedGroupData, userId);
					}
				});
				
			} catch (error) {
				console.error('Error loading group data:', error);
				showError('Ошибка при загрузке данных группы');
			}
		}
        
        // Функция для загрузки постов группы
        async function loadGroupPosts(groupId, userId, groupData) {
            try {
                const isAdmin = groupData.members && 
                            groupData.members[userId] && 
                            groupData.members[userId].role === 'admin';
                const isMember = groupData.members && userId in groupData.members;
                
                // Обновляем секцию постов
                updatePostSection(isAdmin, groupId, userId); // Передаем userId
                
                // Загружаем опубликованные посты
                const postsRef = ref(db, `groupPosts/${groupId}`);
                // Изменяем запрос для получения постов в порядке убывания по времени создания
                const postsQuery = query(postsRef, orderByChild('timestamp'));
                
                // Создаем Set для отслеживания уже отрендеренных постов
                let renderedPosts = new Set();
                
                // Слушаем изменения в постах в реальном времени
                onValue(postsQuery, async (snapshot) => {
                    const postsContainer = document.querySelector('.posts-list');
                    
                    if (!snapshot.exists()) {
                        postsContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-file-alt"></i>
                                <p>В этой группе пока нет постов</p>
                            </div>
                        `;
                        renderedPosts.clear(); // Очищаем список отрендеренных постов
                        return;
                    }
                    
                    // Удаляем сообщение о пустом списке, если оно есть
                    const emptyState = postsContainer.querySelector('.empty-state');
                    if (emptyState) {
                        emptyState.remove();
                    }
                    
                    // Собираем все посты и сортируем их по времени (сначала новые)
                    const posts = [];
                    snapshot.forEach((childSnapshot) => {
                        const post = childSnapshot.val();
                        post.id = childSnapshot.key;
                        posts.push(post);
                    });
                    
                    // Сортируем посты по убыванию времени (новые сверху)
                    posts.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Если это первая загрузка, отрисовываем все посты
                    if (renderedPosts.size === 0) {
                        // Очищаем контейнер перед первой загрузкой
                        postsContainer.innerHTML = '';
                        
                        // Добавляем все посты и отмечаем их как отрендеренные
                        for (const post of posts) {
                            const postElement = document.createElement('div');
                            await renderPost(post, postElement, false, userId, isAdmin, groupId);
                            if (postElement.firstChild) {
                                postsContainer.appendChild(postElement.firstChild);
                                renderedPosts.add(post.id);
                            }
                        }
                    } else {
                        // Находим новые посты, которых еще нет в контейнере
                        const newPosts = posts.filter(post => !renderedPosts.has(post.id));
                        
                        // Если есть новые посты, добавляем их в начало списка
                        if (newPosts.length > 0) {
                            for (const post of newPosts) {
                                const postElement = document.createElement('div');
                                await renderPost(post, postElement, false, userId, isAdmin, groupId);
                                if (postElement.firstChild) {
                                    // Вставляем новый пост в начало списка
                                    postsContainer.insertBefore(postElement.firstChild, postsContainer.firstChild);
                                    renderedPosts.add(post.id);
                                }
                            }
                        }
                        
                        // Проверяем, есть ли удаленные посты и удаляем их из DOM
                        const currentPostIds = new Set(posts.map(post => post.id));
                        for (const renderedId of renderedPosts) {
                            if (!currentPostIds.has(renderedId)) {
                                const postElement = document.getElementById(`post-${renderedId}`);
                                if (postElement) {
                                    postElement.remove();
                                }
                                renderedPosts.delete(renderedId);
                            }
                        }
                    }
                });
                
                // Если пользователь администратор, загружаем также предложенные посты
                if (isAdmin) {
                    const proposedPostsRef = ref(db, `proposedGroupPosts/${groupId}`);
                    const proposedPostsQuery = query(proposedPostsRef, orderByChild('timestamp'));
                    
                    // Слушаем изменения в предложенных постах
                    onValue(proposedPostsQuery, async (snapshot) => {
                        const pendingPostsContainer = document.getElementById('pending-posts-container');
                        
                        // Если нет контейнера предложенных постов, пропускаем
                        if (!pendingPostsContainer) return;
                        
                        if (!snapshot.exists()) {
                            pendingPostsContainer.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>Нет предложенных постов</p>
                                </div>
                            `;
                            
                            // Скрываем бейдж с количеством предложенных постов
                            const pendingTab = document.getElementById('pending-posts-tab');
                            if (pendingTab) {
                                const badge = pendingTab.querySelector('.pending-badge');
                                if (badge) badge.style.display = 'none';
                            }
                            
                            return;
                        }
                        
                        // Удаляем сообщение о пустом списке, если оно есть
                        const emptyState = pendingPostsContainer.querySelector('.empty-state');
                        if (emptyState) {
                            emptyState.remove();
                        }
                        
                        // Собираем все предложенные посты
                        const proposedPosts = [];
                        snapshot.forEach((childSnapshot) => {
                            const post = childSnapshot.val();
                            post.id = childSnapshot.key;
                            proposedPosts.push(post);
                        });
                        
                        // Обновляем бейдж с количеством предложенных постов
                        const pendingTab = document.getElementById('pending-posts-tab');
                        if (pendingTab) {
                            let badge = pendingTab.querySelector('.pending-badge');
                            if (!badge) {
                                badge = document.createElement('span');
                                badge.className = 'pending-badge';
                                pendingTab.appendChild(badge);
                            }
                            badge.textContent = proposedPosts.length;
                            badge.style.display = 'inline-block';
                        }
                        
                        // Сортируем посты по времени (сначала новые)
                        proposedPosts.sort((a, b) => b.timestamp - a.timestamp);
                        
                        // Очищаем контейнер перед добавлением отсортированных постов
                        pendingPostsContainer.innerHTML = '';
                        
                        // Добавляем предложенные посты в отсортированном порядке
                        for (const post of proposedPosts) {
                            const postElement = document.createElement('div');
                            await renderPost(post, postElement, true, userId, isAdmin, groupId);
                            if (postElement.firstChild) {
                                pendingPostsContainer.appendChild(postElement.firstChild);
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error loading group posts:', error);
            }
        }
        
        // Функция для обновления секции постов
        async function updatePostSection(isAdmin, groupId, userId) { // Принимаем userId
            const groupMain = document.querySelector('.group-main');
            const postsSection = document.querySelector('.group-main .content-section');
            
            // Удаляем существующую секцию постов
            if (postsSection) {
                postsSection.remove();
            }
            
            // Создаем новую секцию постов
            const newPostsSection = document.createElement('div');
            newPostsSection.className = 'content-section';
            
            let currentUserAvatarURL = '';
            try {
                const userRef = ref(db, `users/${userId}`);
                const userSnapshot = await get(userRef);
                if (userSnapshot.exists()) {
                    currentUserAvatarURL = userSnapshot.val().photoURL || '';
                }
            } catch (error) {
                console.error("Error fetching current user data for post input:", error);
            }
            
            newPostsSection.innerHTML = `
                <div class="create-post-inline">
                    <div class="post-author-avatar">
                        ${currentUserAvatarURL ? `<img src="${currentUserAvatarURL}" alt="Ваш аватар">` : ''}
                    </div>
                    <div class="post-input-area">
                        <textarea id="inline-post-content" placeholder="Что у вас нового?"></textarea>
                        <div class="post-inline-actions" style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px;">
                            ${isAdmin ? `
                            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
                                <div class="publish-as-group-option" style="display: flex; align-items: center; margin-right: 5px;">
                                    <input type="checkbox" id="publish-as-group" style="margin-right: 5px;" checked>
                                    <label for="publish-as-group" style="font-size: 13px; color: #666;">От имени группы</label>
                                </div>
                                <div class="show-author-option" style="display: flex; align-items: center;">
                                    <input type="checkbox" id="show-author" style="margin-right: 5px;" checked>
                                    <label for="show-author" style="font-size: 13px; color: #666;">Указать автора</label>
                                </div>
                            </div>
                            ` : `<div></div>`}
                            <div class="image-upload-container" style="display: flex; flex-wrap: wrap; align-items: center; gap: 5px;">
                                <button type="button" class="image-upload-button post-image-upload-button">
                                    <i class="fas fa-image"></i> <span>Прикрепить</span>
                                </button>
                                <input type="file" class="image-upload-input post-image-upload-input" accept="image/*,video/*" multiple>
                                <div class="image-counter post-image-counter" style="display: none;">0/10</div>
                                <button class="post-inline-send-btn" disabled>
                                    <i class="fas fa-paper-plane"></i> ${isAdmin ? 'Опубликовать' : 'Предложить'}
                                </button>
                            </div>
                        </div>
                        <!-- Контейнер для превью изображений -->
                        <div class="image-preview-container post-image-preview-container" style="display: none;">
                            <div class="image-gallery post-image-gallery"></div>
                            <button type="button" class="clear-all-images post-clear-all-images">
                                <i class="fas fa-trash"></i> Удалить все
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            if (isAdmin) {
                // Для администраторов показываем табы (Опубликованные, Предложенные)
                newPostsSection.innerHTML += `
                    <div class="post-tabs">
                        <button class="post-tab active" id="published-posts-tab" data-tab="published-posts">Опубликованные</button>
                        <button class="post-tab" id="pending-posts-tab" data-tab="pending-posts">Предложенные</button>
                    </div>
                    <div class="tab-content active" id="published-posts">
                        <div class="posts-list"></div>
                    </div>
                    <div class="tab-content" id="pending-posts">
                        <div class="posts-list" id="pending-posts-container"></div>
                    </div>
                `;
            } else {
                // Для обычных пользователей показываем табы (Опубликованные, Мои предложенные)
                newPostsSection.innerHTML += `
                    <div class="post-tabs">
                        <button class="post-tab active" id="published-posts-tab" data-tab="published-posts">Опубликованные</button>
                        <button class="post-tab" id="my-proposed-posts-tab" data-tab="my-proposed-posts">Мои предложенные</button>
                    </div>
                    <div class="tab-content active" id="published-posts">
                        <div class="posts-list"></div>
                    </div>
                    <div class="tab-content" id="my-proposed-posts">
                        <div class="posts-list" id="my-proposed-posts-container"></div>
                    </div>
                `;
            }
            
            // Добавляем секцию в главный контейнер
            groupMain.prepend(newPostsSection);
            
            const postContentInput = document.getElementById('inline-post-content');
            const sendButton = document.querySelector('.post-inline-send-btn');
            const postForm = document.querySelector('.create-post-inline');
            const postImageUploadManager = new ImageUploadManager(postForm, 'post');
            
            // Получаем информацию о группе для аватарки
            let groupAvatarURL = '';
            if (isAdmin) {
                try {
                    const groupRef = ref(db, `groups/${groupId}`);
                    const groupSnapshot = await get(groupRef);
                    if (groupSnapshot.exists()) {
                        const groupData = groupSnapshot.val();
                        groupAvatarURL = groupData.photoURL || '';
                    }
                    
                    // Подписываемся на изменения данных группы
                    onValue(groupRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const updatedGroupData = snapshot.val();
                            const newGroupAvatarURL = updatedGroupData.photoURL || '';
                            
                            // Обновляем локальную переменную
                            groupAvatarURL = newGroupAvatarURL;
                            
                            // Проверяем состояние чекбокса и обновляем аватарку, если он активирован
                            const publishAsGroupCheckbox = document.getElementById('publish-as-group');
                            const postAuthorAvatar = document.querySelector('.post-author-avatar');
                            
                            if (publishAsGroupCheckbox && publishAsGroupCheckbox.checked) {
                                postAuthorAvatar.innerHTML = `<img src="${newGroupAvatarURL}" alt="Аватар группы">`;
                            }
                        }
                    });
                } catch (error) {
                    console.error("Error fetching group avatar:", error);
                }
            }

            // Активация/деактивация кнопки отправки
            postContentInput.addEventListener('input', () => {
                sendButton.disabled = postContentInput.value.trim() === '' && !postImageUploadManager.hasImages();
            });

            // Обработчик чекбокса "От имени группы"
            if (isAdmin) {
                const publishAsGroupCheckbox = document.getElementById('publish-as-group');
                const postAuthorAvatar = document.querySelector('.post-author-avatar');
                
                // Сразу устанавливаем аватарку группы, так как чекбокс активен по умолчанию
                if (publishAsGroupCheckbox.checked && groupAvatarURL) {
                    postAuthorAvatar.innerHTML = `<img src="${groupAvatarURL}" alt="Аватар группы">`;
                }
                
                publishAsGroupCheckbox.addEventListener('change', async function() {
                    if (this.checked) {
                        // Получаем актуальную аватарку группы при каждой активации чекбокса
                        try {
                            const groupRef = ref(db, `groups/${groupId}`);
                            const groupSnapshot = await get(groupRef);
                            if (groupSnapshot.exists()) {
                                const groupData = groupSnapshot.val();
                                groupAvatarURL = groupData.photoURL || '';
                                // Меняем аватарку на аватарку группы
                                postAuthorAvatar.innerHTML = `<img src="${groupAvatarURL}" alt="Аватар группы">`;
                            }
                        } catch (error) {
                            console.error("Error fetching group avatar:", error);
                            // В случае ошибки оставляем текущую аватарку пользователя
                            postAuthorAvatar.innerHTML = `${currentUserAvatarURL ? `<img src="${currentUserAvatarURL}" alt="Ваш аватар">` : ''}`;
                        }
                    } else {
                        // Возвращаем аватарку пользователя
                        postAuthorAvatar.innerHTML = `${currentUserAvatarURL ? `<img src="${currentUserAvatarURL}" alt="Ваш аватар">` : ''}`;
                    }
                });
            }

            // Обработчик отправки поста
            sendButton.addEventListener('click', async () => {
                const content = postContentInput.value.trim();
                
                // Получаем загруженные изображения
                const uploadedImages = postImageUploadManager.getUploadedImagesUrls();
                
                // Проверяем, что есть текст или изображения
                if (!content && (!uploadedImages || uploadedImages.length === 0)) {
                    if (typeof window.showError === 'function') {
                        window.showError('Пост должен содержать текст или изображение');
                    } else {
                        alert('Пост должен содержать текст или изображение');
                    }
                    return;
                }
                
                // Показываем индикатор загрузки
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                sendButton.disabled = true;
                
                // Дополнительные параметры для администраторов
                let publishAsGroup = false;
                let showAuthor = false;
                
                if (isAdmin) {
                    // Для админов проверяем состояние чекбоксов
                    const publishAsGroupCheckbox = document.getElementById('publish-as-group');
                    const showAuthorCheckbox = document.getElementById('show-author');
                    
                    publishAsGroup = publishAsGroupCheckbox && publishAsGroupCheckbox.checked;
                    showAuthor = showAuthorCheckbox && showAuthorCheckbox.checked;
                }
                
                try {
                    // Создаем новый пост
                    await createGroupPost({
                        content: content,
                        authorId: auth.currentUser.uid,
                        groupId: groupId,
                        imageUrls: uploadedImages,
                        publishAsGroup: publishAsGroup,
                        showAuthor: showAuthor,
                        isPending: !isAdmin // Только админы могут публиковать напрямую
                    });
                    
                    // Очищаем поле ввода и сбрасываем изображения
                    postContentInput.value = '';
                    postImageUploadManager.clearImages();
                    
                    // Переключаемся на соответствующую вкладку
                    if (!isAdmin) {
                        // Для обычных пользователей переключаемся на "Мои предложенные"
                        const myProposedTab = document.getElementById('my-proposed-posts-tab');
                        if (myProposedTab) {
                            myProposedTab.click();
                        }
                    }
                    
                    // Уведомление об успешной отправке
                    const successMessage = isAdmin ? 'Пост успешно опубликован' : 'Пост успешно предложен и будет опубликован после проверки администратором';
                    if (typeof window.showSuccess === 'function') {
                        window.showSuccess(successMessage);
                    } else {
                        alert(successMessage);
                    }
                    
                } catch (error) {
                    console.error('Ошибка при создании поста:', error);
                    if (typeof window.showError === 'function') {
                        window.showError('Произошла ошибка при отправке поста. Пожалуйста, попробуйте еще раз.');
                    } else {
                        alert('Произошла ошибка при отправке поста. Пожалуйста, попробуйте еще раз.');
                    }
                } finally {
                    // Восстанавливаем кнопку
                    sendButton.innerHTML = `<i class="fas fa-paper-plane"></i> ${isAdmin ? 'Опубликовать' : 'Предложить'}`;
                    sendButton.disabled = true;
                }
            });
            
            // Добавляем обработчики для табов
            const tabButtons = document.querySelectorAll('.post-tab');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Загружаем предложенные посты пользователя, если он не админ
            if (!isAdmin) {
                loadUserProposedPosts(groupId, userId);
            }
        }
        
        // Функция для отображения поста
        async function renderPost(post, container, isPending, currentUserId, isAdmin, groupId) {
            try {
                // Добавляем получение текущего пользователя из Firebase Auth
                const currentUser = auth.currentUser;
                
                // Проверяем, опубликован ли пост от имени группы
                let authorName, authorPhotoURL, publisherName;
                
                if (post.publishedAsGroup && !isPending) {
                    // Получаем информацию о группе
                    const groupRef = ref(db, `groups/${groupId}`);
                    const groupSnapshot = await get(groupRef);
                    
                    // Получаем информацию о реальном авторе поста
                    const authorRef = ref(db, `users/${post.authorId}`);
                    const authorSnapshot = await get(authorRef);
                    
                    if (groupSnapshot.exists()) {
                        const groupData = groupSnapshot.val();
                        authorName = groupData.name || 'Группа';
                        authorPhotoURL = groupData.photoURL || '';
                        
                        if (authorSnapshot.exists()) {
                            const authorData = authorSnapshot.val();
                            publisherName = authorData.name || authorData.displayName || authorData.email || 'Пользователь';
                        }
                    } else {
                        authorName = 'Группа';
                        authorPhotoURL = '';
                    }
                } else {
                    // Получаем информацию об авторе поста
                    const authorRef = ref(db, `users/${post.authorId}`);
                    const authorSnapshot = await get(authorRef);
                    
                    if (!authorSnapshot.exists()) {
                        console.error('Author data not found for post:', post.id);
                        return;
                    }
                    
                    const authorData = authorSnapshot.val();
                    authorName = authorData.name || authorData.displayName || authorData.email || 'Пользователь';
                    authorPhotoURL = authorData.photoURL || '';
                }
                
                // Создаем элемент поста
                const postEl = document.createElement('div');
                postEl.className = `post-item ${isPending ? 'pending-post-item' : ''}`;
                postEl.id = `post-${post.id}`;
                
                // Форматируем дату
                const postDate = new Date(post.timestamp);
                const formattedDate = postDate.toLocaleString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Заполняем содержимое поста
                postEl.innerHTML = `
                    <div class="post-header">
                        <div class="post-author-avatar">
                            ${authorPhotoURL ? `<img src="${authorPhotoURL}" alt="${authorName}">` : ''}
                        </div>
                        <div class="post-info">
                            <div class="post-author-name">
                                <span class="author-name-text">${authorName}</span> 
                                ${post.publishedAsGroup && publisherName && (post.showAuthor === true) ? 
                                    `<span class="author-link">(${publisherName})</span>` : ''}
                            </div>
                            <div class="post-date">${formattedDate}</div>
                        </div>
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${post.imageURL ? `<img src="${post.imageURL}" alt="Изображение к посту" class="post-image">` : ''}
                    ${post.imageUrls && post.imageUrls.length > 0 ? `
                    <div class="post-images ${post.imageUrls.length > 1 ? 'post-images-gallery count-' + post.imageUrls.length : ''}">
                        ${post.imageUrls.map((url, index) => {
                            const isVideo = url.includes('.mp4') || url.includes('.webm') || url.includes('.ogg') || url.includes('.mov') || 
                                           url.includes('video') || url.includes('comment_videos');
                            return `
                                <div class="post-image-item" data-url="${url}" data-index="${index}">
                                    ${isVideo ? 
                                        `<div class="video-container">
                                            <video src="${url}" preload="metadata"></video>
                                            <div class="video-overlay"></div>
                                        </div>` : 
                                        `<img src="${url}" alt="Изображение ${index + 1}" class="post-image">`
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>` : ''}
                    ${!isPending ? `
                    <div class="post-actions">
                        <button class="post-action-btn post-like-btn" data-post-id="${post.id}" onclick="window.handlePostVote('${post.id}', 1)">
                            <i class="far fa-thumbs-up"></i> <span class="post-like-count">0</span>
                        </button>
                        <button class="post-action-btn post-dislike-btn" data-post-id="${post.id}" onclick="window.handlePostVote('${post.id}', -1)">
                            <i class="far fa-thumbs-down"></i> <span class="post-dislike-count">0</span>
                        </button>
                        <span class="post-author-like-container"></span>
                        ${post.authorId === currentUserId || isAdmin ? `
                        <button class="post-action-btn post-delete-btn" data-post-id="${post.id}">
                            <i class="far fa-trash-alt"></i> Удалить
                        </button>
                        ` : ''}
                    </div>
                    <div class="post-comments-section always-visible" data-post-id="${post.id}">
                        <div class="comments-list" data-post-id="${post.id}">
                            <!-- Комментарии будут добавлены через JavaScript -->
                        </div>
                        <form class="comment-form" data-post-id="${post.id}">
                            <img class="comment-form-avatar"
                                src="${currentUser ? (currentUser.photoURL || window.currentUserData?.photoURL || 'https://ui-avatars.com/api/?name=User&background=random') : 'https://ui-avatars.com/api/?name=User&background=random'}" alt="">
                            <div class="comment-form-content">
                                <textarea class="comment-input" placeholder="Написать комментарий..." maxlength="1000" rows="1"></textarea>
                                <div class="character-counter">0/1000</div>
                                <div class="image-upload-container">
                                    <button type="button" class="image-upload-button">
<i class="fas fa-image"></i> <span>Прикрепить медиа</span>
                                    </button>
                                    <input type="file" class="image-upload-input" accept="image/*,video/*" multiple>
                                    <div class="image-counter" style="display: none;">0/10</div>
                                </div>
                                <div class="image-preview-container">
                                    <div class="image-gallery"></div>
                                    <button type="button" class="clear-all-images">
                                        <i class="fas fa-trash"></i> Удалить все
                                    </button>
                                </div>
                                <div class="comment-form-buttons">
                                    <button type="button" class="secondary cancel-comment-button">
                                        <i class="fas fa-times"></i> <span>Отмена</span>
                                    </button>
                                    <button type="submit" class="primary">
                                        <i class="fas fa-paper-plane"></i> <span>Отправить</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    ` : `
                    <div class="pending-post-status">
                        <div class="pending-post-info">Ожидает одобрения администратора</div>
                        <div class="pending-post-actions">
                            <button class="approve-btn" data-post-id="${post.id}">Одобрить</button>
                            <button class="reject-btn" data-post-id="${post.id}">Отклонить</button>
                        </div>
                    </div>
                    `}
                `;
                
                // Добавляем обработчики для просмотра медиафайлов
                const mediaItems = postEl.querySelectorAll('.post-image-item');
                mediaItems.forEach((item, index) => {
                    item.addEventListener('click', (e) => {
                        // Если клик был по оверлею или изображению, но не по видео
                        if (e.target.closest('.video-overlay') || e.target.tagName === 'IMG') {
                            const url = item.dataset.url;
                            if (url) {
                                window.openImageModal(url, postEl, index);
                            }
                        }
                    });
                    
                    // Добавляем отдельный обработчик для видео-оверлея
                    const videoOverlay = item.querySelector('.video-overlay');
                    if (videoOverlay) {
                        videoOverlay.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const url = item.dataset.url;
                            if (url) {
                                window.openImageModal(url, postEl, index);
                            }
                        });
                    }
                });
                
                // Добавляем обработчики для кнопок
                if (!isPending) {
                    // Обработчик для кнопки удаления
                    const deleteBtn = postEl.querySelector('.post-delete-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => {
                            deletePost(groupId, post.id);
                        });
                    }
                    
                    // Настраиваем слушатель голосов для поста
                    setupPostVotesListener(groupId, post.id, postEl);
                } else if (isAdmin) {
                    // Обработчики для кнопок одобрения/отклонения предложенного поста
                    const approveBtn = postEl.querySelector('.approve-btn');
                    const rejectBtn = postEl.querySelector('.reject-btn');
                    
                    if (approveBtn) {
                        approveBtn.addEventListener('click', () => {
                            approvePost(groupId, post.id);
                        });
                    }
                    
                    if (rejectBtn) {
                        rejectBtn.addEventListener('click', () => {
                            rejectPost(groupId, post.id);
                        });
                    }
                }
                
                // Добавляем обработчики для аватара и имени автора поста
                if (post.publishedAsGroup) {
                    // Если пост опубликован от имени группы, добавляем обработчик для перехода на страницу группы
                    const authorAvatar = postEl.querySelector('.post-author-avatar');
                    const authorNameEl = postEl.querySelector('.author-name-text');
                    
                    // Функция перехода на страницу группы
                    const goToGroupPage = () => {
                        // Поскольку мы уже находимся на странице группы, можно просто прокрутить вверх
                        // или обновить страницу, если это нужно
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    };
                    
                    // Добавляем обработчики кликов
                    authorAvatar.addEventListener('click', goToGroupPage);
                    authorNameEl.addEventListener('click', goToGroupPage);
                    
                    // Если пост показывает информацию об авторе, добавляем обработчик для имени автора в скобках
                    if (post.showAuthor && publisherName) {
                        const authorSpan = postEl.querySelector('.author-link');
                        if (authorSpan) {
                            // Получаем ссылку на базу данных для получения numericId пользователя-автора
                            const userRef = ref(db, `users/${post.authorId}`);
                            
                            // Получаем информацию о пользователе и устанавливаем обработчик
                            get(userRef).then((snapshot) => {
                                if (snapshot.exists()) {
                                    const userData = snapshot.val();
                                    // Используем numericId или обычный id, если numericId не найден
                                    const profileId = userData.numericId || post.authorId;
                                    
                                    // Добавляем отдельный обработчик только для имени автора в скобках
                                    authorSpan.addEventListener('click', (e) => {
                                        e.stopPropagation(); // Останавливаем всплытие события, чтобы не сработал клик по родителю
                                        window.location.href = `profile.html?id=${profileId}`;
                                    });
                                }
                            }).catch(error => {
                                console.error("Error getting user data for profile link:", error);
                            });
                        }
                    }
                } else {
                    // Если пост от обычного пользователя, переходим на его профиль
                    const authorAvatar = postEl.querySelector('.post-author-avatar');
                    const authorNameEl = postEl.querySelector('.post-author-name');
                    
                    // Получаем ссылку на базу данных для получения numericId пользователя
                    const userRef = ref(db, `users/${post.authorId}`);
                    
                    // Получаем информацию о пользователе и устанавливаем обработчики
                    get(userRef).then((snapshot) => {
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            // Используем numericId или обычный id, если numericId не найден
                            const profileId = userData.numericId || post.authorId;
                            
                            // Функция перехода на страницу профиля автора
                            const goToAuthorProfile = () => {
                                window.location.href = `profile.html?id=${profileId}`;
                            };
                            
                            // Добавляем обработчики кликов
                            authorAvatar.addEventListener('click', goToAuthorProfile);
                            authorNameEl.addEventListener('click', goToAuthorProfile);
                        }
                    }).catch(error => {
                        console.error("Error getting user data for profile link:", error);
                    });
                }
                
                // Добавляем пост в контейнер
                container.appendChild(postEl);
                
                // Если пост не ожидает одобрения, загружаем комментарии
                if (!isPending) {
                    // Инициализируем форму комментария
                    initCommentForm(postEl, groupId, post.id);
                    
                    // Загружаем комментарии к посту
                    loadComments(groupId, post.id);
                }
                
            } catch (error) {
                console.error('Error rendering post:', error);
            }
        }
        
        // Функция для инициализации формы комментария
        function initCommentForm(postEl, groupId, postId) {
            const commentForm = postEl.querySelector(`.comment-form[data-post-id="${postId}"]`);
            if (!commentForm) return;
            
            // Инициализируем загрузку изображений для комментариев
            const imageUploadManager = new ImageUploadManager(commentForm, 'comment');
            
            // Инициализируем обработчик для формы комментария
            commentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitButton = commentForm.querySelector('button[type="submit"]');
                if (submitButton.disabled) return; // Предотвращаем повторную отправку
                
                submitButton.disabled = true; // Блокируем кнопку
                
                const textarea = commentForm.querySelector('.comment-input');
                const text = textarea.value.trim();
                
                // Получаем загруженные изображения
                const uploadedImages = imageUploadManager.getUploadedImagesUrls();
                
                // Проверяем, что есть текст или изображения
                if (!text && (!uploadedImages || uploadedImages.length === 0)) {
                    if (typeof window.showError === 'function') {
                        window.showError('Пост должен содержать текст или изображение');
                    } else {
                        alert('Пост должен содержать текст или изображение');
                    }
                    submitButton.disabled = false; // Разблокируем кнопку
                    return;
                }
                
                try {
                    await addComment(groupId, postId, text, null, null, null, uploadedImages);
                    textarea.value = '';
                    
                    // Сбрасываем счетчик символов
                    const counter = commentForm.querySelector('.character-counter');
                    if (counter) {
                        counter.textContent = '0/1000';
                    }
                    
                    // Очищаем загруженные изображения
                    imageUploadManager.clearImages();
                    
                    // Скрываем кнопки
                    const buttonsContainer = commentForm.querySelector('.comment-form-buttons');
                    if (buttonsContainer) {
                        buttonsContainer.style.display = 'none';
                    }
                    
                    // Прокручиваем список комментариев к концу для пользователя, который добавил комментарий
                    const commentsList = postEl.querySelector('.comments-list');
                    if (commentsList) {
                        setTimeout(() => {
                            commentsList.scrollTop = commentsList.scrollHeight;
                        }, 500); // Небольшая задержка, чтобы комментарий успел загрузиться
                    }
                } catch (error) {
                    console.error('Ошибка при добавлении комментария:', error);
                    alert('Не удалось добавить комментарий');
                } finally {
                    // Разблокируем кнопку в любом случае
                    submitButton.disabled = false;
                }
            });
            
            // Инициализируем обработчик для текстового поля
            const textarea = commentForm.querySelector('.comment-input');
            const counter = commentForm.querySelector('.character-counter');
            const buttonsContainer = commentForm.querySelector('.comment-form-buttons');
            
            if (textarea && counter && buttonsContainer) {
                // Обновляем счетчик символов при вводе
                textarea.addEventListener('input', () => {
                    const length = textarea.value.length;
                    counter.textContent = `${length}/1000`;
                    
                    // Показываем кнопки, если есть текст
                    if (length > 0 || imageUploadManager.hasImages()) {
                        buttonsContainer.style.display = 'flex';
                    } else {
                        buttonsContainer.style.display = 'none';
                    }
                    
                    // Авторасширение текстового поля
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                });
                
                // Инициализируем кнопку отмены
                const cancelButton = commentForm.querySelector('.cancel-comment-button');
                if (cancelButton) {
                    cancelButton.addEventListener('click', () => {
                        textarea.value = '';
                        counter.textContent = '0/1000';
                        buttonsContainer.style.display = 'none';
                        textarea.style.height = 'auto';
                        
                        // Очищаем загруженные изображения
                        imageUploadManager.clearImages();
                    });
                }
            }
        }

        // Инициализируем обработчик для кнопок отмены в ответах на комментарии
        document.addEventListener('click', (e) => {
            const cancelButton = e.target.closest('.cancel-reply-button');
            if (cancelButton) {
                const commentId = cancelButton.dataset.commentId;
                const replyForm = document.querySelector(`.reply-form[data-parent-id="${commentId}"]`);
                if (replyForm) {
                    const textarea = replyForm.querySelector('.reply-input');
                    if (textarea) {
                        textarea.value = '';
                    }
                    replyForm.classList.remove('active');
                }
            }
        });

        // Инициализируем обработчик для отслеживания ввода в ответах на комментарии
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('reply-input')) {
                const replyForm = e.target.closest('.reply-form');
                if (replyForm) {
                    const commentId = replyForm.dataset.parentId;
                    const counter = replyForm.querySelector(`.reply-character-counter[data-comment-id="${commentId}"]`);
                    if (counter) {
                        const length = e.target.value.length;
                        counter.textContent = `${length}/1000`;
                    }
                    
                    // Авторасширение текстового поля
                    e.target.style.height = 'auto';
                    e.target.style.height = `${e.target.scrollHeight}px`;
                }
            } else if (e.target.classList.contains('comment-input')) {
                // Авторасширение текстового поля для основных комментариев
                e.target.style.height = 'auto';
                e.target.style.height = `${e.target.scrollHeight}px`;
            }
        });

        // Добавляем CSS стили для комментариев
        document.addEventListener('DOMContentLoaded', () => {
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
                .post-comments-section {
                    margin-top: 10px;
                    border-top: 1px solid #eee;
                    padding-top: 10px;
                }
                
                .dark-mode .post-comments-section {
                    border-top-color: #444;
                }
                
                .post-comments-section.always-visible {
                    display: block;
                }
                
                .comments-list {
                    display: flex;
										max-height: 500px;
										overflow-y: auto;
                    flex-direction: column;
                    gap: 15px;
                    margin-bottom: 15px;
                }
                
                .comment {
                    display: flex;
                    gap: 10px;
                    padding: 5px;
                    border-radius: 10px;
                    transition: background-color 0.3s;
                }
                
                .comment-avatar-link {
                    text-decoration: none;
                    flex-shrink: 0;
                }
                
                .comment-avatar {
                    width: 36px;
                    height: 36px;
                    border-radius: 50%;
                    object-fit: cover;
                }
                
                .comment-main {
                    flex-grow: 1;
                }
                
                .comment-header {
                    display: flex;
                    align-items: center;
                    margin-bottom: 5px;
                }
                
                .comment-author {
                    font-weight: 500;
                    color: #333;
                    margin-right: 10px;
                    text-decoration: none;
                }
                
                .dark-mode .comment-author {
                    color: #f5f5f5;
                }
                
                .comment-date {
                    font-size: 12px;
                    color: #888;
                }
                
                .dark-mode .comment-date {
                    color: #999;
                }
                
                .reply-info {
                    font-size: 12px;
                    color: #888;
                    margin-bottom: 5px;
                    padding: 2px 5px;
                    background-color: rgba(0, 0, 0, 0.03);
                    border-radius: 4px;
                    display: inline-block;
                    cursor: pointer;
                }
                
                .dark-mode .reply-info {
                    color: #aaa;
                    background-color: rgba(255, 255, 255, 0.05);
                }
                
                .reply-author {
                    color: #4a76a8;
                    font-weight: 500;
                }
                
                .dark-mode .reply-author {
                    color: #5a86b8;
                }
                
                .reply-info-divider {
                    margin: 0 5px;
                    color: #ccc;
                }
                
                .dark-mode .reply-info-divider {
                    color: #666;
                }
                
                .comment-content {
                    margin-bottom: 8px;
                    white-space: pre-wrap;
                    word-break: break-word;
                }
                
                .comment-images {
                    display: grid;
                    gap: 5px;
                    margin-bottom: 8px;
                    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                }
                
                .comment-images.count-1 {
                    grid-template-columns: minmax(0, 250px);
                }
                
                .comment-image-item {
                    cursor: pointer;
                    border-radius: 8px;
                    overflow: hidden;
                    aspect-ratio: 1;
                }
                
                .comment-image-item img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
                
                .comment-image-item .video-container {
                    position: relative;
                    width: 100%;
                    height: 100%;
                    overflow: hidden;
                }
                
                .comment-image-item .video-container video {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
                
                .comment-image-item .video-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.2);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    cursor: pointer;
                }
                
                .comment-image-item .video-overlay::before {
                    content: '\f144';
                    font-family: 'Font Awesome 5 Free';
                    font-size: 24px;
                    color: #fff;
                    opacity: 0.8;
                }
                
                .comment-votes {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 5px;
                }
                
                .reply-btn {
                    background: none;
                    border: none;
                    color: #4a76a8;
                    font-size: 12px;
                    cursor: pointer;
                    padding: 0;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                }
                
                .dark-mode .reply-btn {
                    color: #5a86b8;
                }
                
                .reply-btn.delete {
                    color: #e53935;
                }
                
                .dark-mode .reply-btn.delete {
                    color: #f44336;
                }
                
                .reply-btn i {
                    font-size: 12px;
                }
                
                .reply-form {
                    display: none;
                    gap: 10px;
                    margin-top: 10px;
                    margin-bottom: 5px;
                }
                
                .reply-form.active {
                    display: flex;
                }
                
                .comment-replies {
                    margin-left: 10px;
                    margin-top: 10px;
                    border-left: none;
                    padding-left: 15px;
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                }
                
                .dark-mode .comment-replies {
                    border-left-color: #444;
                }
                
                .no-comments {
                    color: #888;
                    text-align: center;
                    padding: 20px 0;
                    font-style: italic;
                }
                
                .dark-mode .no-comments {
                    color: #aaa;
                }
            `;
            
            document.head.appendChild(styleSheet);
        });
        
        // Функция для открытия модального окна создания/предложения поста
        function openCreatePostModal(groupId, isAdmin) {
            // Создаем модальное окно, если его нет
            if (!document.getElementById('create-post-modal-overlay')) {
                const modalHTML = `
                    <div id="create-post-modal-overlay" class="modal-overlay">
                        <div class="modal-container">
                            <div class="modal-header">
                                <h3 class="modal-title" id="create-post-modal-title">Создание поста</h3>
                                <button class="modal-close" id="create-post-modal-close">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="create-post-form">
                                    <div class="form-group">
                                        <label for="post-content" class="form-label">Содержание поста</label>
                                        <textarea id="post-content" class="form-input form-textarea" placeholder="Напишите что-нибудь..." required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Изображение (необязательно)</label>
                                        <div class="image-upload">
                                            <div class="post-image-preview" id="post-image-preview">
                                                <i class="fas fa-image"></i>
                                            </div>
                                            <input type="file" id="post-image-input" accept="image/*,video/*" style="display: none;">
                                            <div class="upload-hint">Нажмите на изображение, чтобы выбрать файл</div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="modal-btn secondary" id="cancel-post">Отмена</button>
                                <button class="modal-btn primary" id="submit-post">Опубликовать</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Добавляем обработчики для модального окна
                setupCreatePostModalHandlers();
            }
            
            // Обновляем заголовок модального окна в зависимости от роли пользователя
            const modalTitle = document.getElementById('create-post-modal-title');
            const submitBtn = document.getElementById('submit-post');
            
            if (isAdmin) {
                modalTitle.textContent = 'Создание поста';
                submitBtn.textContent = 'Опубликовать';
            } else {
                modalTitle.textContent = 'Предложить пост';
                submitBtn.textContent = 'Предложить';
            }
            
            // Сохраняем данные о группе и роли пользователя
            window.currentPostGroupId = groupId;
            window.isCurrentUserAdmin = isAdmin;
            
            // Сбрасываем форму
            document.getElementById('create-post-form').reset();
            document.getElementById('post-image-preview').innerHTML = '<i class="fas fa-image"></i>';
            window.postImageBlob = null;
            
            // Показываем модальное окно
            document.getElementById('create-post-modal-overlay').classList.add('active');
        }
        
        // Настройка обработчиков для модального окна создания поста
        function setupCreatePostModalHandlers() {
            const modalOverlay = document.getElementById('create-post-modal-overlay');
            const modalClose = document.getElementById('create-post-modal-close');
            const cancelBtn = document.getElementById('cancel-post');
            const submitBtn = document.getElementById('submit-post');
            const imageInput = document.getElementById('post-image-input');
            const imagePreview = document.getElementById('post-image-preview');
            
            // Закрытие модального окна
            modalClose.addEventListener('click', () => {
                modalOverlay.classList.remove('active');
            });
            
            cancelBtn.addEventListener('click', () => {
                modalOverlay.classList.remove('active');
            });
            
            // Клик вне модального окна закрывает его
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.remove('active');
                }
            });
            
            // Обработка клика на превью изображения
            imagePreview.addEventListener('click', () => {
                imageInput.click();
            });
            
            // Обработка выбора изображения
            imageInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    // Проверка типа файла
                    if (!file.type.match('image.*') && !file.type.match('video.*')) {
                        alert('Пожалуйста, выберите изображение или видео');
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // Отображаем превью выбранного изображения или видео
                        if (file.type.match('image.*')) {
                            imagePreview.innerHTML = `<img src="${e.target.result}" alt="Превью">`;
                        } else if (file.type.match('video.*')) {
                            imagePreview.innerHTML = `<video src="${e.target.result}" controls></video>`;
                        }
                        
                        // Сохраняем blob для загрузки
                        const byteString = atob(e.target.result.split(',')[1]);
                        const mimeString = e.target.result.split(',')[0].split(':')[1].split(';')[0];
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        
                        window.postImageBlob = new Blob([ab], { type: mimeString });
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Обработка отправки формы
            submitBtn.addEventListener('click', async () => {
                const content = document.getElementById('post-content').value.trim();
                
                if (!content) {
                    alert('Пожалуйста, введите содержание поста');
                    return;
                }
                
                // Блокируем кнопку отправки
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
                
                try {
                    await submitPost(content, window.currentPostGroupId, window.isCurrentUserAdmin, window.postImageBlob);
                    
                    // Закрываем модальное окно после успешной отправки
                    modalOverlay.classList.remove('active');
                } catch (error) {
                    console.error('Error submitting post:', error);
                    alert('Ошибка при отправке поста');
                } finally {
                    // Разблокируем кнопку отправки
                    submitBtn.disabled = false;
                    submitBtn.textContent = window.isCurrentUserAdmin ? 'Опубликовать' : 'Предложить';
                }
            });
        }
        
        // Функция для отправки поста
        async function submitPost(content, groupId, isAdmin, imageBlob = null, publishAsGroup = false, showAuthor = true) { // Добавляем параметры
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (!user) {
                throw new Error('User not authenticated');
            }
            
            try {
                // Создаем объект с данными поста
                const postData = {
                    content,
                    authorId: user.uid,
                    timestamp: Date.now(),
                    createdAt: serverTimestamp()
                };
                
                // Если пост публикуется от имени группы, добавляем соответствующий флаг
                if (publishAsGroup && isAdmin) {
                    postData.publishedAsGroup = true;
                }
                
                // Добавляем флаг отображения автора
                postData.showAuthor = showAuthor;
                
                // Определяем, куда будет сохранен пост (опубликованные или предложенные)
                const postsRef = isAdmin 
                    ? ref(db, `groupPosts/${groupId}`) 
                    : ref(db, `proposedGroupPosts/${groupId}`);
                
                const newPostRef = push(postsRef);
                
                // Если есть изображение, загружаем его
                if (imageBlob) { // Используем переданный imageBlob
                    const imagePath = `groupPosts/${groupId}/${newPostRef.key}`;
                    const imageStorageRef = storageRef(storage, imagePath);
                    
                    const uploadTask = await uploadBytes(imageStorageRef, imageBlob); // Загружаем blob
                    const imageURL = await getDownloadURL(uploadTask.ref);
                    
                    // Добавляем URL изображения к данным поста
                    postData.imageURL = imageURL;
                }
                
                // Сохраняем пост в базе данных
                await set(newPostRef, postData);
                
                console.log(`Post ${isAdmin ? 'published' : 'proposed'} successfully`);
                
            } catch (error) {
                console.error('Error submitting post:', error);
                throw error;
            }
        }
        
        // Функция для переключения состояния лайка
        async function toggleLike(groupId, postId, userId) {
            try {
                const likeRef = ref(db, `groupPosts/${groupId}/${postId}/likes/${userId}`);
                const likeSnapshot = await get(likeRef);
                
                if (likeSnapshot.exists()) {
                    // Удаляем лайк, если он уже есть
                    await set(likeRef, null);
                } else {
                    // Добавляем лайк, если его нет
                    await set(likeRef, true);
                }
                
                // Обновление UI происходит автоматически через onValue
                
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }
        
        // Функция для удаления поста
        async function deletePost(groupId, postId) {
            if (!confirm('Вы уверены, что хотите удалить этот пост?')) {
                return;
            }
            
            try {
                // Удаляем пост из базы данных
                await set(ref(db, `groupPosts/${groupId}/${postId}`), null);
                
                console.log('Post deleted successfully');
                
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('Ошибка при удалении поста');
            }
        }
        
        // Функция для одобрения предложенного поста
        async function approvePost(groupId, postId) {
            try {
                // Получаем данные предложенного поста
                const proposedPostRef = ref(db, `proposedGroupPosts/${groupId}/${postId}`);
                const proposedPostSnapshot = await get(proposedPostRef);
                
                if (!proposedPostSnapshot.exists()) {
                    console.error('Proposed post not found');
                    return;
                }
                
                const postData = proposedPostSnapshot.val();
                
                // Добавляем пост в опубликованные
                const publishedPostsRef = ref(db, `groupPosts/${groupId}`);
                const newPostRef = push(publishedPostsRef);
                
                // Спрашиваем, нужно ли опубликовать пост от имени группы
                if (confirm('Опубликовать этот пост от имени группы?')) {
                    postData.publishedAsGroup = true;
                    
                    // Спрашиваем, нужно ли указывать автора поста
                    postData.showAuthor = confirm('Указать автора поста?');
                }
                
                await set(newPostRef, postData);
                
                // Удаляем пост из предложенных
                await set(proposedPostRef, null);
                
                console.log('Post approved and published successfully');
                
            } catch (error) {
                console.error('Error approving post:', error);
                alert('Ошибка при одобрении поста');
            }
        }
        
        // Функция для отклонения предложенного поста
        async function rejectPost(groupId, postId) {
            if (!confirm('Вы уверены, что хотите отклонить этот пост?')) {
                return;
            }
            
            try {
                // Удаляем предложенный пост из базы данных
                await set(ref(db, `proposedGroupPosts/${groupId}/${postId}`), null);
                
                console.log('Post rejected successfully');
                
            } catch (error) {
                console.error('Error rejecting post:', error);
                alert('Ошибка при отклонении поста');
            }
        }

		// Функция для обновления кнопок действий
		function updateActionButtons(members, userId, groupId) {
			const actionsContainer = document.querySelector('.group-actions');
			const isAdmin = members && members[userId] && members[userId].role === 'admin';
			const isMember = members && userId in members;
			
			actionsContainer.innerHTML = '';
			
			if (isAdmin) {
				const editButton = document.createElement('button');
				editButton.className = 'group-btn secondary';
				editButton.id = 'edit-group-btn';
				editButton.innerHTML = '<i class="fas fa-edit"></i> Редактировать';
				editButton.addEventListener('click', () => {
					// Получаем актуальные данные группы перед редактированием
					const groupRef = ref(db, `groups/${groupId}`);
					get(groupRef).then((snapshot) => {
						if (snapshot.exists()) {
							const groupData = snapshot.val();
							groupData.id = groupId;
							openEditModal(groupData);
						}
					});
				});
				actionsContainer.appendChild(editButton);
			} else if (isMember) {
				const leaveButton = document.createElement('button');
				leaveButton.className = 'group-btn secondary';
				leaveButton.id = 'leave-group-btn';
				leaveButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Выйти';
				leaveButton.addEventListener('click', () => {
					leaveGroup(groupId, userId);
				});
				actionsContainer.appendChild(leaveButton);
			} else {
				const joinButton = document.createElement('button');
				joinButton.className = 'group-btn';
				joinButton.id = 'join-group-btn';
				joinButton.innerHTML = '<i class="fas fa-plus"></i> Вступить';
				joinButton.addEventListener('click', () => {
					joinGroup(groupId, userId);
				});
				actionsContainer.appendChild(joinButton);
			}
		}
		
		// Функция вступления в группу
		async function joinGroup(groupId, userId) {
			try {
				// Получаем информацию о пользователе
				const userRef = ref(db, `users/${userId}`);
				const userSnapshot = await get(userRef);
				
				if (!userSnapshot.exists()) {
					console.error('User data not found');
					return;
				}
				
				// Добавляем пользователя в члены группы с ролью участника
				const memberData = {
					role: 'member',
					joinedAt: Date.now()
				};
				
				// Обновляем данные в базе данных
				await set(ref(db, `groups/${groupId}/members/${userId}`), memberData);
				
				// Добавляем группу в список групп пользователя
				await set(ref(db, `users/${userId}/joinedGroups/${groupId}`), true);
				
				console.log('Successfully joined the group');
			} catch (error) {
				console.error('Error joining group:', error);
				alert('Ошибка при вступлении в группу');
			}
		}
		
		// Функция выхода из группы
		async function leaveGroup(groupId, userId) {
			try {
				// Убеждаемся, что пользователь не является единственным администратором
				const groupRef = ref(db, `groups/${groupId}`);
				const groupSnapshot = await get(groupRef);
				
				if (!groupSnapshot.exists()) {
					console.error('Group not found');
					return;
				}
				
				const groupData = groupSnapshot.val();
				
				// Проверяем, является ли пользователь администратором
				const isAdmin = groupData.members && 
								groupData.members[userId] && 
								groupData.members[userId].role === 'admin';
				
				// Если пользователь админ, проверяем, есть ли другие админы
				if (isAdmin) {
					const adminCount = Object.entries(groupData.members || {})
						.filter(([uid, data]) => data.role === 'admin' && uid !== userId)
						.length;
					
					if (adminCount === 0) {
						alert('Вы не можете покинуть группу, так как вы единственный администратор. Назначьте другого администратора перед выходом.');
						return;
					}
				}
				
				// Удаляем пользователя из группы
				await set(ref(db, `groups/${groupId}/members/${userId}`), null);
				
				// Удаляем группу из списка групп пользователя
				await set(ref(db, `users/${userId}/joinedGroups/${groupId}`), null);
				
				console.log('Successfully left the group');
			} catch (error) {
				console.error('Error leaving group:', error);
				alert('Ошибка при выходе из группы');
			}
		}

		// Функция для отображения информации о группе
		function renderGroupInfo(groupData, userId) {
			const groupHeaderEl = document.querySelector('.group-header');
			const isAdmin = groupData.members && 
							groupData.members[userId] && 
							groupData.members[userId].role === 'admin';
			const isMember = groupData.members && userId in groupData.members;

			// Заполняем шапку группы
			groupHeaderEl.innerHTML = `
				<div class="group-cover">
					${groupData.coverImage ? `<img src="${groupData.coverImage}" alt="${groupData.name}">` : ''}
				</div>
				<div class="group-info">
					<div class="group-avatar">
						${groupData.photoURL ? `<img src="${groupData.photoURL}" alt="${groupData.name}">` : ''}
					</div>
					<div class="group-details">
						<h1 class="group-name">${groupData.name}</h1>
						<p class="group-description">${groupData.description || 'Нет описания'}</p>
						<div class="group-meta">
							<div class="group-meta-item">
								<i class="fas fa-users"></i> 
								${groupData.members ? Object.keys(groupData.members).length : 0} 
								${getWordForm(groupData.members ? Object.keys(groupData.members).length : 0, ['участник', 'участника', 'участников'])}
							</div>
							<div class="group-meta-item">
								<i class="fas fa-id-card"></i> 
								ID: ${groupData.id}
							</div>
						</div>
					</div>
					<div class="group-actions">
						${isAdmin ? `
							<button class="group-btn secondary" id="edit-group-btn">
								<i class="fas fa-edit"></i> Редактировать
							</button>
						` : isMember ? `
							<button class="group-btn secondary" id="leave-group-btn">
								<i class="fas fa-sign-out-alt"></i> Выйти
							</button>
						` : `
							<button class="group-btn" id="join-group-btn">
								<i class="fas fa-plus"></i> Вступить
							</button>
						`}
					</div>
				</div>
			`;

			// Добавляем обработчики для кнопок
			if (isAdmin) {
				document.getElementById('edit-group-btn').addEventListener('click', () => {
					openEditModal(groupData);
				});
			} else if (isMember) {
				document.getElementById('leave-group-btn').addEventListener('click', () => {
					leaveGroup(groupData.id, userId);
				});
			} else {
				document.getElementById('join-group-btn').addEventListener('click', () => {
					joinGroup(groupData.id, userId);
				});
			}

			// Добавляем возможность клика на количество участников
			document.querySelector('.group-meta-item:first-child').style.cursor = 'pointer';
			document.querySelector('.group-meta-item:first-child').addEventListener('click', () => {
				openMembersModal(groupData, userId);
			});
		}

		// Функция для загрузки участников группы
		async function loadGroupMembers(groupData) {
			if (!groupData.members) return;

			const membersListEl = document.querySelector('.members-list');
			const membersCount = Object.keys(groupData.members).length;
			
			// Обновляем заголовок с количеством участников
			const sectionTitle = document.querySelector('.group-sidebar .section-title');
			if (sectionTitle) {
				sectionTitle.innerHTML = `Подписчики<span class="members-count">${membersCount}</span>`;
				sectionTitle.style.cursor = 'pointer';
				sectionTitle.addEventListener('click', () => {
						openMembersModal(groupData, auth.currentUser.uid);
					});
			}
			
			// Очищаем список участников перед добавлением новых
			membersListEl.innerHTML = '';
			
			const memberPromises = Object.entries(groupData.members).map(async ([userId, memberData]) => {
				try {
					// Получаем информацию о пользователе
					const userRef = ref(db, `users/${userId}`);
					const userSnapshot = await get(userRef);

					if (!userSnapshot.exists()) {
						return null;
					}

					const userData = userSnapshot.val();
					
					// Проверяем, есть ли numericId, иначе используем Firebase UID как запасной вариант
					const profileId = userData.numericId || userId; 
					
					// Создаем элемент участника с правильным отображением имени
					const memberEl = document.createElement('div');
					memberEl.className = 'member-item';
					memberEl.innerHTML = `
						<div class="member-avatar">
							${userData.photoURL ? `<img src="${userData.photoURL}" alt="${userData.name || userData.displayName || 'Пользователь'}">` : ''}
						</div>
						<div class="member-name">${userData.name || userData.displayName || userData.email || 'Пользователь'}</div>
						<div class="member-role">${memberData.role === 'admin' ? 'Администратор' : 'Участник'}</div>
					`;
					
					// Добавляем обработчик для перехода на страницу пользователя с использованием profileId
					memberEl.addEventListener('click', () => {
						window.location.href = `profile.html?id=${profileId}`; 
					});

					return memberEl;
				} catch (error) {
					console.error('Error loading member data:', error);
					return null;
				}
			});

			const memberElements = await Promise.all(memberPromises);
			const validMembers = memberElements.filter(el => el !== null);

			if (validMembers.length > 0) {
				validMembers.forEach(el => membersListEl.appendChild(el));
			} else {
				membersListEl.innerHTML = '<div class="empty-state">Нет участников</div>';
			}
		}

		// Вспомогательные функции
		function showLoading(isLoading) {
			const loadingEl = document.querySelector('.loading-indicator');
			if (isLoading) {
				loadingEl.style.display = 'block';
				document.querySelector('.group-container').style.display = 'none';
			} else {
				loadingEl.style.display = 'none';
				document.querySelector('.group-container').style.display = 'block';
			}
		}

		function showError(message) {
			const errorEl = document.querySelector('.error-message');
			errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
			errorEl.style.display = 'block';
			document.querySelector('.loading-indicator').style.display = 'none';
			document.querySelector('.group-container').style.display = 'none';
		}

		function getWordForm(number, words) {
			const cases = [2, 0, 1, 1, 1, 2];
			return words[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[Math.min(number % 10, 5)]];
		}

		// Инициализация сайдбара при загрузке страницы
		window.addEventListener('load', () => {
			
			// Добавляем модальное окно для участников группы, если его еще нет
			if (!document.getElementById('members-modal-overlay')) {
				const membersModalHTML = `
					<div id="members-modal-overlay" class="modal-overlay">
						<div class="members-modal-container">
							<div class="members-modal-header">
								<h3 class="members-modal-title">Подписчики группы</h3>
								<button class="members-modal-close" id="members-modal-close">&times;</button>
							</div>
							<div class="members-modal-body">
								<div class="members-modal-tabs">
									<button class="tab-button active" data-tab="all-members">Подписчики</button>
									<button class="tab-button" data-tab="admins">Администраторы</button>
									<button class="tab-button" data-tab="friends">Друзья</button>
								</div>
								<div class="tab-content active" id="all-members">
									<div class="members-modal-list" id="all-members-list"></div>
								</div>
								<div class="tab-content" id="admins">
									<div class="members-modal-list" id="admins-list"></div>
								</div>
								<div class="tab-content" id="friends">
									<div class="members-modal-list" id="friends-list"></div>
								</div>
							</div>
						</div>
					</div>
				`;
				document.body.insertAdjacentHTML('beforeend', membersModalHTML);
				
				// Настраиваем обработчики для модального окна участников
				setupMembersModalHandlers();
			}
		});

		// Функция для открытия модального окна редактирования группы
		function openEditModal(groupData) {
			// Создаем модальное окно, если его нет
			if (!document.getElementById('edit-group-modal-overlay')) {
				const modalHTML = `
					<div id="edit-group-modal-overlay" class="modal-overlay">
						<div class="edit-group-modal-container">
							<div class="edit-group-modal-header">
								<h3 class="edit-group-modal-title">Редактирование группы</h3>
								<button class="edit-group-modal-close" id="edit-group-modal-close">&times;</button>
							</div>
							<div class="edit-group-modal-body">
								<form id="edit-group-form">
									<div class="edit-group-form-group">
										<label for="edit-group-name" class="edit-group-form-label">Название группы</label>
										<input type="text" id="edit-group-name" class="edit-group-form-input" placeholder="Введите название группы" required>
									</div>
									<div class="edit-group-form-group">
										<label for="edit-group-description" class="edit-group-form-label">Описание группы</label>
										<textarea id="edit-group-description" class="edit-group-form-input edit-group-form-textarea" placeholder="Расскажите о группе"></textarea>
									</div>
									<div class="edit-group-form-group">
										<label for="edit-group-id" class="edit-group-form-label">Уникальный ID группы</label>
										<input type="text" id="edit-group-id" class="edit-group-form-input" placeholder="Например: groupCursor1">
										<div class="edit-group-upload-hint">Если изменить ID, все ссылки на старый ID перестанут работать</div>
									</div>
									<div class="edit-group-form-group">
										<label for="edit-group-category" class="edit-group-form-label">Категория группы</label>
										<select id="edit-group-category" class="edit-group-form-input">
											<option value="" disabled>Выберите категорию</option>
											<option value="technology">Технологии</option>
											<option value="programming">Программирование</option>
											<option value="design">Дизайн</option>
											<option value="education">Образование</option>
											<option value="business">Бизнес</option>
											<option value="entertainment">Развлечения</option>
											<option value="health">Здоровье и спорт</option>
											<option value="cooking">Кулинария и рецепты</option>
											<option value="art">Искусство</option>
											<option value="music">Музыка</option>
											<option value="literature">Литература</option>
											<option value="travel">Путешествия</option>
											<option value="photography">Фотография</option>
											<option value="gaming">Игры</option>
											<option value="science">Наука</option>
											<option value="hobbies">Хобби и творчество</option>
											<option value="nature">Природа и животные</option>
											<option value="languages">Языки</option>
											<option value="fashion">Мода и стиль</option>
											<option value="psychology">Психология</option>
										</select>
									</div>
									<div class="edit-group-form-group">
										<label class="edit-group-form-label">Аватар группы</label>
										<div class="edit-group-image-upload">
											<div class="edit-group-image-preview edit-group-avatar-preview" id="edit-group-avatar-preview">
												<i class="fas fa-camera"></i>
											</div>
											<input type="file" id="edit-group-avatar-input" accept="image/*" style="display: none;">
											<div class="edit-group-upload-hint">Нажмите на изображение, чтобы выбрать файл</div>
										</div>
									</div>
									<div class="edit-group-form-group">
										<label class="edit-group-form-label">Обложка группы</label>
										<div class="edit-group-image-upload">
											<div class="edit-group-image-preview" id="edit-group-cover-preview">
												<i class="fas fa-image"></i>
											</div>
											<input type="file" id="edit-group-cover-input" accept="image/*" style="display: none;">
											<div class="edit-group-upload-hint">Нажмите на изображение, чтобы выбрать файл</div>
										</div>
									</div>
									
									<!-- Блок удаления группы -->
									<div class="edit-group-delete-section">
										<h3 class="edit-group-delete-title">Удаление группы</h3>
										<p class="edit-group-delete-instructions">
											Внимание! Это действие нельзя отменить. Все данные группы будут безвозвратно удалены.
											Для подтверждения введите "Удалить <span id="edit-group-delete-id-text"></span>".
										</p>
										<div class="edit-group-delete-confirmation">
											<input type="text" id="edit-group-delete-confirmation-input" class="edit-group-form-input" placeholder="Введите фразу для подтверждения">
										</div>
										<button type="button" id="edit-group-delete-btn" class="edit-group-delete-btn" disabled>Удалить группу</button>
									</div>
								</form>
							</div>
							<div class="edit-group-modal-footer">
								<button class="edit-group-modal-btn edit-group-modal-btn-secondary" id="edit-group-cancel-btn">Отмена</button>
								<button class="edit-group-modal-btn edit-group-modal-btn-primary" id="edit-group-save-btn">Сохранить</button>
							</div>
						</div>
					</div>

					<div id="edit-avatar-crop-modal" class="modal-overlay">
						<div class="edit-group-modal-container">
							<div class="edit-group-modal-header">
								<h3 class="edit-group-modal-title">Обрезка аватара</h3>
								<button class="edit-group-modal-close" id="edit-avatar-crop-close">&times;</button>
							</div>
							<div class="edit-group-modal-body">
								<div id="edit-avatar-crop-container"></div>
								<div class="edit-group-crop-controls">
									<button class="edit-group-crop-btn edit-group-crop-btn-cancel" id="edit-avatar-crop-cancel">Отмена</button>
									<button class="edit-group-crop-btn edit-group-crop-btn-save" id="edit-avatar-crop-save">Сохранить</button>
								</div>
							</div>
						</div>
					</div>

					<div id="edit-cover-crop-modal" class="modal-overlay">
						<div class="edit-group-modal-container">
							<div class="edit-group-modal-header">
								<h3 class="edit-group-modal-title">Обрезка обложки</h3>
								<button class="edit-group-modal-close" id="edit-cover-crop-close">&times;</button>
							</div>
							<div class="edit-group-modal-body">
								<div id="edit-cover-crop-container"></div>
								<div class="edit-group-crop-controls">
									<button class="edit-group-crop-btn edit-group-crop-btn-cancel" id="edit-cover-crop-cancel">Отмена</button>
									<button class="edit-group-crop-btn edit-group-crop-btn-save" id="edit-cover-crop-save">Сохранить</button>
								</div>
							</div>
						</div>
					</div>
				`;

				document.body.insertAdjacentHTML('beforeend', modalHTML);

				// Добавляем обработчики
				setupEditModalHandlers();
			}

			// Заполняем поля данными группы
			document.getElementById('edit-group-name').value = groupData.name || '';
			document.getElementById('edit-group-description').value = groupData.description || '';
			document.getElementById('edit-group-id').value = groupData.id || '';
			document.getElementById('edit-group-category').value = groupData.category || '';

			// Обновляем превью изображений если они есть
			const avatarPreview = document.getElementById('edit-group-avatar-preview');
			const coverPreview = document.getElementById('edit-group-cover-preview');

			// Очищаем предыдущие изображения
			avatarPreview.innerHTML = '';
			coverPreview.innerHTML = '';

			if (groupData.photoURL) {
				const img = document.createElement('img');
				img.src = groupData.photoURL;
				avatarPreview.appendChild(img);
			} else {
				avatarPreview.innerHTML = '<i class="fas fa-camera"></i>';
			}

			if (groupData.coverImage) {
				const img = document.createElement('img');
				img.src = groupData.coverImage;
				coverPreview.appendChild(img);
			} else {
				coverPreview.innerHTML = '<i class="fas fa-image"></i>';
			}

			// Переменные для хранения обрезанных изображений
			window.editCroppedAvatarBlob = null;
			window.editCroppedCoverBlob = null;
			
			// Переменные для хранения экземпляров Cropper
			window.editAvatarCropper = null;
			window.editCoverCropper = null;

			// Сохраняем original ID для сравнения позже
			window.originalGroupId = groupData.id || '';
			
			// Обновляем текст для подтверждения удаления группы
			if (window.updateDeleteConfirmationText) {
				window.updateDeleteConfirmationText();
			}

			// Показываем модальное окно
			document.getElementById('edit-group-modal-overlay').classList.add('active');
		}

		// Настройка обработчиков для модального окна редактирования
		function setupEditModalHandlers() {
			const modalOverlay = document.getElementById('edit-group-modal-overlay');
			const modalClose = document.getElementById('edit-group-modal-close');
			const cancelBtn = document.getElementById('edit-group-cancel-btn');
			const saveBtn = document.getElementById('edit-group-save-btn');
			const avatarInput = document.getElementById('edit-group-avatar-input');
			const coverInput = document.getElementById('edit-group-cover-input');
			const avatarPreview = document.getElementById('edit-group-avatar-preview');
			const coverPreview = document.getElementById('edit-group-cover-preview');
			const groupIdInput = document.getElementById('edit-group-id');
			
			// Обработчики для удаления группы
			const deleteBtn = document.getElementById('edit-group-delete-btn');
			const deleteGroupIdText = document.getElementById('edit-group-delete-id-text');
			const deleteConfirmationInput = document.getElementById('edit-group-delete-confirmation-input');
			
			// Обновляем текст для подтверждения удаления при открытии модального окна
			window.updateDeleteConfirmationText = function() {
				const groupId = document.getElementById('edit-group-id').value || '';
				deleteGroupIdText.textContent = groupId;
				deleteConfirmationInput.placeholder = `Введите "Удалить ${groupId}"`;
				
				// Сбрасываем поле ввода и кнопку
				deleteConfirmationInput.value = '';
				deleteBtn.disabled = true;
			};
			
			// Обработчик изменения ID группы
			groupIdInput.addEventListener('input', function() {
				window.updateDeleteConfirmationText();
			});
			
			// Валидация поля подтверждения удаления
			deleteConfirmationInput.addEventListener('input', function() {
				const groupId = document.getElementById('edit-group-id').value || '';
				const confirmationText = `Удалить ${groupId}`;
				
				// Проверяем совпадает ли введенный текст с требуемым
				if (this.value === confirmationText) {
					deleteBtn.disabled = false;
				} else {
					deleteBtn.disabled = true;
				}
			});
			
			// Обработчик кнопки удаления
			deleteBtn.addEventListener('click', async function() {
				const groupId = document.getElementById('edit-group-id').value || '';
				
				if (!groupId) {
					alert('ID группы не указан');
					return;
				}
				
				// Запрашиваем подтверждение
				if (!confirm('Вы действительно хотите удалить группу? Это действие нельзя отменить.')) {
					return;
				}
				
				// Блокируем кнопку и меняем текст
				this.disabled = true;
				this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Удаление...';
				
				try {
					// Получаем текущие данные группы
					const groupRef = ref(db, `groups/${groupId}`);
					const groupSnapshot = await get(groupRef);
					
					if (!groupSnapshot.exists()) {
						alert('Группа не найдена');
						return;
					}
					
					const groupData = groupSnapshot.val();
					
					// Удаляем группу из списков всех пользователей, которые в ней состоят
					if (groupData.members) {
						const memberPromises = Object.keys(groupData.members).map(async (userId) => {
							// Удаляем группу из joinedGroups пользователя
							await set(ref(db, `users/${userId}/joinedGroups/${groupId}`), null);
						});
						
						await Promise.all(memberPromises);
					}
					
					// Удаляем группу из базы данных
					await set(ref(db, `groups/${groupId}`), null);
					
					// Удаляем ID группы из реестра
					await set(ref(db, `groupIds/${groupId}`), null);
					
					// Закрываем модальное окно
					modalOverlay.classList.remove('active');
					
					// Перенаправляем на главную страницу
					window.location.href = 'groups.html';
					
				} catch (error) {
					console.error('Error deleting group:', error);
					alert('Ошибка при удалении группы: ' + error.message);
					
					// Разблокируем кнопку
					this.disabled = false;
					this.textContent = 'Удалить группу';
				}
			});

			// Закрытие модального окна
			modalClose.addEventListener('click', () => {
				modalOverlay.classList.remove('active');
			});

			cancelBtn.addEventListener('click', () => {
				modalOverlay.classList.remove('active');
			});

			// Клик вне модального окна закрывает его
			modalOverlay.addEventListener('click', (e) => {
				if (e.target === modalOverlay) {
					modalOverlay.classList.remove('active');
				}
			});

			// Обработка клика на аватар
			avatarPreview.addEventListener('click', () => {
				avatarInput.click();
			});

			// Обработка выбора аватара
			avatarInput.addEventListener('change', function() {
				if (this.files && this.files[0]) {
					const file = this.files[0];
					// Проверка типа файла
					if (!file.type.match('image.*') && !file.type.match('video.*')) {
						alert('Пожалуйста, выберите изображение или видео');
						return;
					}

					const reader = new FileReader();
					
					reader.onload = function(e) {
						// Проверяем, является ли файл GIF
						if (file.type === 'image/gif') {
							// Для GIF не используем кадрирование
							handleGifUpload(e.target.result, 'avatar');
						} else {
							// Открываем модальное окно обрезки аватарки
							openEditAvatarCropModal(e.target.result);
						}
					};
					
					reader.readAsDataURL(file);
				}
			});

			// Обработка клика на обложку
			coverPreview.addEventListener('click', () => {
				coverInput.click();
			});

			// Обработка выбора обложки
			coverInput.addEventListener('change', function() {
				if (this.files && this.files[0]) {
					const file = this.files[0];
					// Проверка типа файла
					if (!file.type.match('image.*') && !file.type.match('video.*')) {
						alert('Пожалуйста, выберите изображение или видео');
						return;
					}

					const reader = new FileReader();
					
					reader.onload = function(e) {
						// Проверяем, является ли файл GIF
						if (file.type === 'image/gif') {
							// Для GIF не используем кадрирование
							handleGifUpload(e.target.result, 'cover');
						} else {
							// Открываем модальное окно обрезки обложки
							openEditCoverCropModal(e.target.result);
						}
					};
					
					reader.readAsDataURL(file);
				}
			});

			// Обработка сохранения изменений
			saveBtn.addEventListener('click', async () => {
				const groupId = document.getElementById('edit-group-id').value;
				const name = document.getElementById('edit-group-name').value;
				const description = document.getElementById('edit-group-description').value;
				const category = document.getElementById('edit-group-category').value;
				const originalGroupId = window.originalGroupId;

				if (!name) {
					alert('Введите название группы');
					return;
				}
				
				if (!groupId) {
					alert('ID группы не может быть пустым');
					return;
				}

				// Блокируем кнопку сохранения
				saveBtn.disabled = true;
				saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';

				try {
					// Проверяем, изменился ли ID группы
					if (groupId !== originalGroupId) {
						// Проверяем уникальность нового ID
						const customIdRef = ref(db, `groupIds/${groupId}`);
						const customIdSnapshot = await get(customIdRef);
						
						if (customIdSnapshot.exists()) {
							alert('Этот ID группы уже занят. Пожалуйста, выберите другой.');
							saveBtn.disabled = false;
							saveBtn.innerHTML = 'Сохранить';
							return;
						}
					}
					
					// Обновляем данные группы
					const updatedData = {
						name,
						description,
						category
					};

					// Загрузка аватарки в Storage (если есть)
					if (window.editCroppedAvatarBlob) {
						const avatarRef = storageRef(storage, `groups/${originalGroupId}/avatar.jpg`);
						const avatarSnapshot = await uploadBytes(avatarRef, window.editCroppedAvatarBlob);
						const avatarURL = await getDownloadURL(avatarSnapshot.ref);
						updatedData.photoURL = avatarURL;
					}

					// Загрузка обложки в Storage (если есть)
					if (window.editCroppedCoverBlob) {
						const coverRef = storageRef(storage, `groups/${originalGroupId}/cover.jpg`);
						const coverSnapshot = await uploadBytes(coverRef, window.editCroppedCoverBlob);
						const coverURL = await getDownloadURL(coverSnapshot.ref);
						updatedData.coverImage = coverURL;
					}

					// Если ID изменился, нужно создать новую группу и удалить старую
					if (groupId !== originalGroupId) {
						// Получаем текущие данные группы
						const groupRef = ref(db, `groups/${originalGroupId}`);
						const groupSnapshot = await get(groupRef);
						
						if (groupSnapshot.exists()) {
							const groupData = groupSnapshot.val();
							
							// Создаем новую группу с новым ID
							await set(ref(db, `groups/${groupId}`), {
								...groupData,
								...updatedData
							});
							
							// Регистрируем новый ID
							await set(ref(db, `groupIds/${groupId}`), true);
							
							// Удаляем старый ID из реестра
							await set(ref(db, `groupIds/${originalGroupId}`), null);
							
							// Удаляем старую группу
							await set(ref(db, `groups/${originalGroupId}`), null);
							
							// Обновляем ссылки в данных пользователей
							// 1. Обновляем ссылки в createdGroups
							const usersSnapshot = await get(ref(db, `users`));
							if (usersSnapshot.exists()) {
								const users = usersSnapshot.val();
								for (const userId in users) {
									if (users[userId].createdGroups && users[userId].createdGroups[originalGroupId]) {
										// Удаляем старую ссылку
										await set(ref(db, `users/${userId}/createdGroups/${originalGroupId}`), null);
										// Добавляем новую ссылку
										await set(ref(db, `users/${userId}/createdGroups/${groupId}`), true);
									}
									
									if (users[userId].joinedGroups && users[userId].joinedGroups[originalGroupId]) {
										// Удаляем старую ссылку
										await set(ref(db, `users/${userId}/joinedGroups/${originalGroupId}`), null);
										// Добавляем новую ссылку
										await set(ref(db, `users/${userId}/joinedGroups/${groupId}`), true);
									}
								}
							}
							
							// Перенаправляем на новую страницу группы
							window.location.href = `group.html?id=${groupId}`;
						}
					} else {
						// Используем выделенную функцию для обновления данных группы
						await updateGroupData(groupId, updatedData);
					}

				} catch (error) {
					console.error('Error updating group:', error);
					alert('Ошибка при обновлении группы');
				} finally {
					// Разблокируем кнопку сохранения
					saveBtn.disabled = false;
					saveBtn.innerHTML = 'Сохранить';
				}
			});

			// Настройка модального окна обрезки аватара
			setupEditAvatarCropModalHandlers();

			// Настройка модального окна обрезки обложки
			setupEditCoverCropModalHandlers();
		}

		// Функция открытия модального окна обрезки аватара
		function openEditAvatarCropModal(imageData) {
			const modal = document.getElementById('edit-avatar-crop-modal');
			const container = document.getElementById('edit-avatar-crop-container');
			
			// Очищаем контейнер и уничтожаем старый экземпляр Cropper
			if (window.editAvatarCropper) {
				try {
					window.editAvatarCropper.destroy();
				} catch (error) {
					console.warn('Error destroying previous cropper instance:', error);
				}
				window.editAvatarCropper = null;
			}
			
			container.innerHTML = '';
			
			// Создаем изображение
			const image = document.createElement('img');
			image.src = imageData;
			container.appendChild(image);
			
			// Показываем модальное окно
			modal.classList.add('active');
			
			// Сбрасываем значение input, чтобы можно было выбрать то же самое изображение
			document.getElementById('edit-group-avatar-input').value = '';
			
			// Инициализируем Cropper только после загрузки изображения
			image.onload = function() {
				try {
					window.editAvatarCropper = new Cropper(image, {
						aspectRatio: 1, // квадратное соотношение сторон для аватара
						viewMode: 1,
						zoomable: true,
						cropBoxResizable: true,
						minContainerWidth: 300,
						minContainerHeight: 300
					});
				} catch (error) {
					console.error('Error initializing avatar cropper:', error);
				}
			};
		}

		// Функция открытия модального окна обрезки обложки
		function openEditCoverCropModal(imageData) {
			const modal = document.getElementById('edit-cover-crop-modal');
			const container = document.getElementById('edit-cover-crop-container');
			
			// Очищаем контейнер и уничтожаем старый экземпляр Cropper
			if (window.editCoverCropper) {
				try {
					window.editCoverCropper.destroy();
				} catch (error) {
					console.warn('Error destroying previous cropper instance:', error);
				}
				window.editCoverCropper = null;
			}
			
			container.innerHTML = '';
			
			// Создаем изображение
			const image = document.createElement('img');
			image.src = imageData;
			container.appendChild(image);
			
			// Показываем модальное окно
			modal.classList.add('active');
			
			// Сбрасываем значение input, чтобы можно было выбрать то же самое изображение
			document.getElementById('edit-group-cover-input').value = '';
			
			// Инициализируем Cropper только после загрузки изображения
			image.onload = function() {
				try {
					window.editCoverCropper = new Cropper(image, {
						aspectRatio: 16 / 9, // широкоэкранное соотношение для обложки
						viewMode: 1,
						zoomable: true,
						cropBoxResizable: true,
						minContainerWidth: 300,
						minContainerHeight: 150
					});
				} catch (error) {
					console.error('Error initializing cover cropper:', error);
				}
			};
		}

		// Настройка обработчиков для модального окна обрезки аватара
		function setupEditAvatarCropModalHandlers() {
			const modal = document.getElementById('edit-avatar-crop-modal');
			const closeBtn = document.getElementById('edit-avatar-crop-close');
			const cancelBtn = document.getElementById('edit-avatar-crop-cancel');
			const saveBtn = document.getElementById('edit-avatar-crop-save');
			
			// Закрытие модального окна
			closeBtn.addEventListener('click', () => {
				modal.classList.remove('active');
			});
			
			cancelBtn.addEventListener('click', () => {
				modal.classList.remove('active');
			});
			
			// Клик вне модального окна закрывает его
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					modal.classList.remove('active');
				}
			});
			
			// Сохранение обрезанного изображения
			saveBtn.addEventListener('click', () => {
				if (window.editAvatarCropper) {
					// Получаем обрезанное изображение
					window.editAvatarCropper.getCroppedCanvas({
						width: 300,
						height: 300
					}).toBlob((blob) => {
						// Сохраняем blob в переменную
						window.editCroppedAvatarBlob = blob;
						
						// Обновляем превью
						const avatarPreview = document.getElementById('edit-group-avatar-preview');
						avatarPreview.innerHTML = '';
						
						const img = document.createElement('img');
						img.src = URL.createObjectURL(blob);
						avatarPreview.appendChild(img);
						
						// Закрываем модальное окно
						modal.classList.remove('active');
					}, 'image/jpeg');
				}
			});
		}

		// Настройка обработчиков для модального окна обрезки обложки
		function setupEditCoverCropModalHandlers() {
			const modal = document.getElementById('edit-cover-crop-modal');
			const closeBtn = document.getElementById('edit-cover-crop-close');
			const cancelBtn = document.getElementById('edit-cover-crop-cancel');
			const saveBtn = document.getElementById('edit-cover-crop-save');
			
			// Закрытие модального окна
			closeBtn.addEventListener('click', () => {
				modal.classList.remove('active');
			});
			
			cancelBtn.addEventListener('click', () => {
				modal.classList.remove('active');
			});
			
			// Клик вне модального окна закрывает его
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					modal.classList.remove('active');
				}
			});
			
			// Сохранение обрезанного изображения
			saveBtn.addEventListener('click', () => {
				if (window.editCoverCropper) {
					// Получаем обрезанное изображение
					window.editCoverCropper.getCroppedCanvas({
						width: 1200,
						height: 675
					}).toBlob((blob) => {
						// Сохраняем blob в переменную
						window.editCroppedCoverBlob = blob;
						
						// Обновляем превью
						const coverPreview = document.getElementById('edit-group-cover-preview');
						coverPreview.innerHTML = '';
						
						const img = document.createElement('img');
						img.src = URL.createObjectURL(blob);
						coverPreview.appendChild(img);
						
						// Закрываем модальное окно
						modal.classList.remove('active');
					}, 'image/jpeg');
				}
			});
		}

		// Функция для обработки загрузки GIF изображений
		function handleGifUpload(dataUrl, type) {
			// Преобразуем Data URL в Blob
			const byteString = atob(dataUrl.split(',')[1]);
			const mimeString = dataUrl.split(',')[0].split(':')[1].split(';')[0];
			const ab = new ArrayBuffer(byteString.length);
			const ia = new Uint8Array(ab);
			
			for (let i = 0; i < byteString.length; i++) {
				ia[i] = byteString.charCodeAt(i);
			}
			
			const blob = new Blob([ab], { type: mimeString });
			
			// Обновляем превью и сохраняем blob
			if (type === 'avatar') {
				// Обновляем превью аватарки
				const avatarPreview = document.getElementById('edit-group-avatar-preview');
				avatarPreview.innerHTML = '';
				
				const img = document.createElement('img');
				img.src = dataUrl;
				avatarPreview.appendChild(img);
				
				// Сохраняем blob для последующей загрузки
				window.editCroppedAvatarBlob = blob;
			} else if (type === 'cover') {
				// Обновляем превью обложки
				const coverPreview = document.getElementById('edit-group-cover-preview');
				coverPreview.innerHTML = '';
				
				const img = document.createElement('img');
				img.src = dataUrl;
				coverPreview.appendChild(img);
				
				// Сохраняем blob для последующей загрузки
				window.editCroppedCoverBlob = blob;
			}
		}

		// Добавляем функцию обновления группы в базе данных с расширенным функционалом для отображения в реальном времени
		async function updateGroupData(groupId, updatedData) {
			try {
				// Сохраняем обновленные данные в базе данных
				await update(ref(db, `groups/${groupId}`), updatedData);
				
				// Закрываем модальное окно
				document.getElementById('edit-group-modal-overlay').classList.remove('active');
				
				// Информация о группе теперь обновляется автоматически через слушатель onValue
				
			} catch (error) {
				console.error('Error updating group:', error);
				alert('Ошибка при обновлении группы');
			}
		}

		// Функция настройки обработчиков для модального окна участников
		function setupMembersModalHandlers() {
			const modal = document.getElementById('members-modal-overlay');
			const modalContainer = modal.querySelector('.members-modal-container');
			const closeBtn = document.getElementById('members-modal-close');
			
			// Закрытие модального окна
			closeBtn.addEventListener('click', () => {
				modal.classList.remove('active');
				modalContainer.style.opacity = '0';
			});
			
			// Клик вне модального окна закрывает его
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					modal.classList.remove('active');
					modalContainer.style.opacity = '0';
				}
			});
			
			// Обработчики для табов
			const tabButtons = modal.querySelectorAll('.tab-button');
			tabButtons.forEach(button => {
				button.addEventListener('click', () => {
					// Убираем активный класс у всех кнопок и контента
					tabButtons.forEach(btn => btn.classList.remove('active'));
					modal.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
					
					// Добавляем активный класс нажатой кнопке и соответствующему контенту
					button.classList.add('active');
					const tabId = button.getAttribute('data-tab');
					document.getElementById(tabId).classList.add('active');
				});
			});
		}

		// Функция открытия модального окна участников
		async function openMembersModal(groupData, currentUserId) {
			const modal = document.getElementById('members-modal-overlay');
			const modalContainer = modal.querySelector('.members-modal-container');
			
			// Очищаем списки перед заполнением
			document.getElementById('all-members-list').innerHTML = '';
			document.getElementById('admins-list').innerHTML = '';
			document.getElementById('friends-list').innerHTML = '';
			
			// Отображаем модальное окно
			modal.classList.add('active');
			
			// Явно устанавливаем opacity для контейнера
			modalContainer.style.opacity = '1';
			
			let currentUserNumericId = null;
			try {
				const currentUserRef = ref(db, `users/${currentUserId}`);
				const currentUserSnapshot = await get(currentUserRef);
				if (currentUserSnapshot.exists()) {
					currentUserNumericId = currentUserSnapshot.val().numericId;
				}
			} catch (error) {
				console.error("Не удалось получить numericId текущего пользователя:", error);
				// Обработка ошибки, если не удалось получить numericId
				document.getElementById('friends-list').innerHTML = '<div class="error-message">Ошибка загрузки данных пользователя</div>';
				return; // Прерываем выполнение, если не можем получить ID
			}
			
			if (!currentUserNumericId) {
				console.error("numericId текущего пользователя не найден.");
				document.getElementById('friends-list').innerHTML = '<div class="error-message">ID пользователя не найден</div>';
				return; // Прерываем выполнение
			}
			console.log(`[openMembersModal] Current user numericId: ${currentUserNumericId}`);

			// Используем currentUserNumericId для запроса friendships
			const friendshipsRef = ref(db, `friendships/${currentUserNumericId}`); 
			const friendshipsSnapshot = await get(friendshipsRef);
			let friendIds = []; // Для Firebase UID друзей

			if (friendshipsSnapshot.exists()) {
				const friendships = friendshipsSnapshot.val();
				// Фильтруем друзей и получаем их numericId
				const friendNumericIds = Object.entries(friendships)
					.filter(([_, data]) => data && data.status === 'friends')
					.map(([friendNumericId, _]) => friendNumericId);
				
				// Получаем Firebase UID друзей по их numericId
				if (friendNumericIds.length > 0) {
					const usersRef = ref(db, 'users');
					const usersSnapshot = await get(usersRef);
					if (usersSnapshot.exists()) {
						const usersData = usersSnapshot.val();
						friendIds = Object.entries(usersData)
							.filter(([firebaseUid, userData]) => userData && friendNumericIds.includes(String(userData.numericId)))
							.map(([firebaseUid, _]) => firebaseUid);
					}
				}
			}
			console.log('[openMembersModal] Friend Firebase UIDs from friendships:', friendIds);
			
			// Массивы для хранения данных участников
			const allMembers = [];
			const admins = [];
			const friends = [];
			
			// Загружаем информацию о каждом участнике
			const memberPromises = Object.entries(groupData.members).map(async ([userId, memberData]) => {
				try {
					// Получаем данные пользователя-участника
					const memberUserRef = ref(db, `users/${userId}`); // userId здесь - это Firebase UID участника
					const memberUserSnapshot = await get(memberUserRef);
					if (!memberUserSnapshot.exists()) {
						console.warn(`[openMembersModal] Member user data not found for userId: ${userId}`);
						return null; 
					}
					const memberUserData = memberUserSnapshot.val();

					// Создаем объект с данными участника
					const memberItem = {
						firebaseId: userId,
						id: memberUserData.numericId || userId, // Используем numericId, если есть
						name: memberUserData.name || memberUserData.displayName || memberUserData.email || 'Пользователь',
						photoURL: memberUserData.photoURL || '',
						role: memberData.role
					};
					
					// Добавляем в соответствующие массивы
					allMembers.push(memberItem);
					
					if (memberData.role === 'admin') {
						admins.push(memberItem);
					}
					
					// Сравниваем Firebase UID участника с Firebase UID друзей
					const isFriend = friendIds.includes(userId); 
					// console.log(`[openMembersModal] Comparing member ${userId} with friends [${friendIds.join(', ')}]? ${isFriend}`); // Оставим один лог для проверки (закомментирован пока)
					
					if (isFriend) {
						friends.push(memberItem);
					}
					
					return memberItem;
				} catch (error) {
					console.error(`[openMembersModal] Error loading member data for ${userId}:`, error);
					return null;
				}
			});
			
			// Ждем завершения всех запросов
			await Promise.all(memberPromises);
			
			// Отображаем списки участников
			renderMembersList(allMembers, 'all-members-list', 'В группе нет участников');
			renderMembersList(admins, 'admins-list', 'В группе нет администраторов');
			renderMembersList(friends, 'friends-list', 'В этой группе нет ваших друзей');
		}

		// Функция отображения списка участников
		function renderMembersList(members, containerId, emptyMessage) {
			const container = document.getElementById(containerId);
			
			// Очищаем контейнер
			container.innerHTML = '';
			
			// Проверяем наличие участников
			if (members.length === 0) {
				container.innerHTML = `<div class="empty-tab-message">${emptyMessage}</div>`;
				return;
			}
			
			// Добавляем каждого участника в список
			members.forEach(member => {
				const memberEl = document.createElement('div');
				memberEl.className = 'members-modal-item';
				memberEl.innerHTML = `
					<div class="members-modal-avatar">
						${member.photoURL ? `<img src="${member.photoURL}" alt="${member.name}">` : ''}
					</div>
					<div class="members-modal-name">${member.name}</div>
					<div class="members-modal-role">${member.role === 'admin' ? 'Администратор' : 'Участник'}</div>
				`;
				
				// Добавляем обработчик для перехода на страницу пользователя, используя member.id (который теперь numericId)
				memberEl.addEventListener('click', () => {
					window.location.href = `profile.html?id=${member.id}`; 
				});
				
				container.appendChild(memberEl);
			});
		}

		// Функция для загрузки предложенных постов пользователя
        async function loadUserProposedPosts(groupId, userId) {
            try {
                const proposedPostsRef = ref(db, `proposedGroupPosts/${groupId}`);
                
                // Создаем запрос для получения предложенных постов
                onValue(proposedPostsRef, async (snapshot) => {
                    const myProposedPostsContainer = document.getElementById('my-proposed-posts-container');
                    
                    if (!myProposedPostsContainer) return;
                    
                    if (!snapshot.exists()) {
                        myProposedPostsContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>У вас нет предложенных постов</p>
                            </div>
                        `;
                        
                        // Скрываем индикатор, если нет предложенных постов
                        const proposedTab = document.getElementById('my-proposed-posts-tab');
                        if (proposedTab) {
                            const badge = proposedTab.querySelector('.pending-badge');
                            if (badge) badge.style.display = 'none';
                        }
                        
                        return;
                    }
                    
                    // Фильтруем посты, оставляя только посты текущего пользователя
                    const myProposedPosts = [];
                    snapshot.forEach((childSnapshot) => {
                        const post = childSnapshot.val();
                        if (post.authorId === userId) {  // Только посты текущего пользователя
                            post.id = childSnapshot.key;
                            myProposedPosts.push(post);
                        }
                    });
                    
                    if (myProposedPosts.length === 0) {
                        myProposedPostsContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>У вас нет предложенных постов</p>
                            </div>
                        `;
                        
                        // Скрываем индикатор, если нет предложенных постов
                        const proposedTab = document.getElementById('my-proposed-posts-tab');
                        if (proposedTab) {
                            const badge = proposedTab.querySelector('.pending-badge');
                            if (badge) badge.style.display = 'none';
                        }
                        
                        return;
                    }
                    
                    // Обновляем индикатор с количеством предложенных постов
                    const proposedTab = document.getElementById('my-proposed-posts-tab');
                    if (proposedTab) {
                        let badge = proposedTab.querySelector('.pending-badge');
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'pending-badge';
                            proposedTab.appendChild(badge);
                        }
                        badge.textContent = myProposedPosts.length;
                        badge.style.display = 'inline-block';
                    }
                    
                    // Удаляем сообщение о пустом списке, если оно есть
                    const emptyState = myProposedPostsContainer.querySelector('.empty-state');
                    if (emptyState) {
                        emptyState.remove();
                    }
                    
                    // Сортируем посты по времени (сначала новые)
                    myProposedPosts.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Получаем список ID постов, которые уже отображаются
                    const existingPostIds = Array.from(
                        myProposedPostsContainer.querySelectorAll('.post-item')
                    ).map(element => element.id.replace('post-', ''));
                    
                    // Найдем ID постов, которые отображаются, но отсутствуют в отфильтрованных данных
                    const postIdsToRemove = existingPostIds.filter(
                        id => !myProposedPosts.some(post => post.id === id)
                    );
                    
                    // Удаляем посты, которых больше нет в данных
                    for (const idToRemove of postIdsToRemove) {
                        const postToRemove = document.getElementById(`post-${idToRemove}`);
                        if (postToRemove) {
                            // Добавляем анимацию исчезновения перед удалением
                            postToRemove.style.transition = 'opacity 0.3s, transform 0.3s';
                            postToRemove.style.opacity = '0';
                            postToRemove.style.transform = 'translateY(-10px)';
                            
                            // Удаляем элемент после завершения анимации
                            setTimeout(() => {
                                if (postToRemove.parentNode) {
                                    postToRemove.parentNode.removeChild(postToRemove);
                                }
                                
                                // Если все посты удалены, показываем сообщение о пустом списке
                                if (!myProposedPostsContainer.querySelector('.post-item')) {
                                    myProposedPostsContainer.innerHTML = `
                                        <div class="empty-state">
                                            <i class="fas fa-inbox"></i>
                                            <p>У вас нет предложенных постов</p>
                                        </div>
                                    `;
                                    
                                    // Скрываем индикатор, если больше нет предложенных постов
                                    const proposedTab = document.getElementById('my-proposed-posts-tab');
                                    if (proposedTab) {
                                        const badge = proposedTab.querySelector('.pending-badge');
                                        if (badge) badge.style.display = 'none';
                                    }
                                }
                            }, 300);
                        }
                    }
                    
                    // Фильтруем только новые посты
                    const newPosts = myProposedPosts.filter(post => !existingPostIds.includes(post.id));
                    
                    // Добавляем новые посты в начало контейнера
                    for (const post of newPosts) {
                        const tempContainer = document.createElement('div');
                        await renderProposedPost(post, tempContainer, userId, groupId);
                        
                        if (tempContainer.firstChild) {
                            const newPostEl = tempContainer.firstChild;
                            
                            // Устанавливаем начальные стили для анимации
                            newPostEl.style.opacity = '0';
                            newPostEl.style.transform = 'translateY(-20px)';
                            newPostEl.style.transition = 'opacity 0.5s, transform 0.5s';
                            
                            // Вставляем пост в начало списка
                            if (myProposedPostsContainer.firstChild) {
                                myProposedPostsContainer.insertBefore(newPostEl, myProposedPostsContainer.firstChild);
                            } else {
                                myProposedPostsContainer.appendChild(newPostEl);
                            }
                            
                            // Запускаем анимацию появления (timeout нужен для работы анимации)
                            setTimeout(() => {
                                newPostEl.style.opacity = '1';
                                newPostEl.style.transform = 'translateY(0)';
                            }, 10);
                        }
                    }
                    
                    // Обновляем существующие посты, если они изменились
                    for (const post of myProposedPosts) {
                        if (existingPostIds.includes(post.id)) {
                            const existingPost = document.getElementById(`post-${post.id}`);
                            // Обновляем только важную информацию, если она изменилась
                            // Например, содержание поста
                            const contentEl = existingPost.querySelector('.post-content');
                            if (contentEl && contentEl.textContent !== post.content) {
                                contentEl.textContent = post.content;
                            }
                            
                            // Обновляем изображение, если оно изменилось
                            const imageEl = existingPost.querySelector('.post-image');
                            if (post.imageURL) {
                                if (!imageEl) {
                                    // Если изображения не было, но теперь оно есть
                                    const newImage = document.createElement('img');
                                    newImage.src = post.imageURL;
                                    newImage.alt = 'Изображение к посту';
                                    newImage.className = 'post-image';
                                    existingPost.querySelector('.post-content').after(newImage);
                                } else if (imageEl.src !== post.imageURL) {
                                    // Если изображение изменилось
                                    imageEl.src = post.imageURL;
                                }
                            } else if (imageEl) {
                                // Если изображение было, но теперь его нет
                                imageEl.remove();
                            }
                            
                            // Обновляем галерею изображений, если она изменилась
                            const imagesGallery = existingPost.querySelector('.post-images');
                            if (post.imageUrls && post.imageUrls.length > 0) {
                                if (!imagesGallery) {
                                    // Если галереи не было, но теперь она есть
                                    const galleryContainer = document.createElement('div');
                                    galleryContainer.className = `post-images ${post.imageUrls.length > 1 ? 'post-images-gallery count-' + post.imageUrls.length : ''}`;
                                    
                                    galleryContainer.innerHTML = post.imageUrls.map((url, index) => {
                                        const isVideo = url.includes('.mp4') || url.includes('.webm') || url.includes('.ogg') || url.includes('.mov') || 
                                                       url.includes('video') || url.includes('comment_videos');
                                        return `
                                            <div class="post-image-item" data-url="${url}" data-index="${index}">
                                                ${isVideo ? 
                                                    `<div class="video-container">
                                                        <video src="${url}" preload="metadata"></video>
                                                        <div class="video-overlay"></div>
                                                    </div>` : 
                                                    `<img src="${url}" alt="Изображение ${index + 1}" class="post-image">`
                                                }
                                            </div>
                                        `;
                                    }).join('');
                                    
                                    // Вставляем после контента или после одиночного изображения
                                    const afterElement = existingPost.querySelector('.post-image') || existingPost.querySelector('.post-content');
                                    afterElement.after(galleryContainer);
                                    
                                    // Добавляем обработчики для просмотра медиафайлов
                                    const mediaItems = galleryContainer.querySelectorAll('.post-image-item');
                                    mediaItems.forEach((item, index) => {
                                        item.addEventListener('click', (e) => {
                                            if (e.target.closest('.video-overlay') || e.target.tagName === 'IMG') {
                                                const url = item.dataset.url;
                                                if (url) {
                                                    window.openImageModal(url, existingPost, index);
                                                }
                                            }
                                        });
                                        
                                        const videoOverlay = item.querySelector('.video-overlay');
                                        if (videoOverlay) {
                                            videoOverlay.addEventListener('click', (e) => {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                const url = item.dataset.url;
                                                if (url) {
                                                    window.openImageModal(url, existingPost, index);
                                                }
                                            });
                                        }
                                    });
                                }
                            } else if (imagesGallery) {
                                // Если галерея была, но теперь ее нет
                                imagesGallery.remove();
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading user proposed posts:', error);
            }
        }
        
        // Функция для отображения предложенного поста пользователя
        async function renderProposedPost(post, container, userId, groupId) {
            try {
                // Получаем информацию об авторе поста (это сам пользователь)
                const authorRef = ref(db, `users/${userId}`);
                const authorSnapshot = await get(authorRef);
                
                if (!authorSnapshot.exists()) {
                    console.error('Author data not found for post:', post.id);
                    return;
                }
                
                const authorData = authorSnapshot.val();
                
                // Создаем элемент поста
                const postEl = document.createElement('div');
                postEl.className = 'post-item pending-post-item';
                postEl.id = `post-${post.id}`;
                
                // Форматируем дату
                const postDate = new Date(post.timestamp);
                const formattedDate = postDate.toLocaleString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Заполняем содержимое поста
                postEl.innerHTML = `
                    <div class="post-header">
                        <div class="post-author-avatar">
                            ${authorData.photoURL ? `<img src="${authorData.photoURL}" alt="${authorData.name || authorData.displayName || 'Пользователь'}">` : ''}
                        </div>
                        <div class="post-info">
                            <div class="post-author-name">${authorData.name || authorData.displayName || authorData.email || 'Пользователь'}</div>
                            <div class="post-date">${formattedDate}</div>
                        </div>
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${post.imageURL ? `<img src="${post.imageURL}" alt="Изображение к посту" class="post-image">` : ''}
                    ${post.imageUrls && post.imageUrls.length > 0 ? `
                    <div class="post-images ${post.imageUrls.length > 1 ? 'post-images-gallery count-' + post.imageUrls.length : ''}">
                        ${post.imageUrls.map((url, index) => {
                            const isVideo = url.includes('.mp4') || url.includes('.webm') || url.includes('.ogg') || url.includes('.mov') || 
                                           url.includes('video') || url.includes('comment_videos');
                            return `
                                <div class="post-image-item" data-url="${url}" data-index="${index}">
                                    ${isVideo ? 
                                        `<div class="video-container">
                                            <video src="${url}" preload="metadata"></video>
                                            <div class="video-overlay"></div>
                                        </div>` : 
                                        `<img src="${url}" alt="Изображение ${index + 1}" class="post-image">`
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>` : ''}
                    <div class="pending-post-status">
                        <div class="pending-post-info">Ожидает одобрения администратора</div>
                        <div class="pending-post-actions">
                            <button class="reject-btn" data-post-id="${post.id}">Удалить</button>
                        </div>
                    </div>
                `;
                
                // Добавляем обработчик для кнопки удаления
                const deleteBtn = postEl.querySelector('.reject-btn');
                deleteBtn.addEventListener('click', () => {
                    deleteProposedPost(groupId, post.id);
                });
                
                // Добавляем обработчики для просмотра медиафайлов
                const mediaItems = postEl.querySelectorAll('.post-image-item');
                mediaItems.forEach((item, index) => {
                    item.addEventListener('click', (e) => {
                        // Если клик был по оверлею или изображению, но не по видео
                        if (e.target.closest('.video-overlay') || e.target.tagName === 'IMG') {
                            const url = item.dataset.url;
                            if (url) {
                                window.openImageModal(url, postEl, index);
                            }
                        }
                    });
                    
                    // Добавляем отдельный обработчик для видео-оверлея
                    const videoOverlay = item.querySelector('.video-overlay');
                    if (videoOverlay) {
                        videoOverlay.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const url = item.dataset.url;
                            if (url) {
                                window.openImageModal(url, postEl, index);
                            }
                        });
                    }
                });
                
                // Добавляем пост в контейнер
                container.appendChild(postEl);
                
            } catch (error) {
                console.error('Error rendering proposed post:', error);
            }
        }
        
        // Функция для удаления предложенного поста пользователем
        async function deleteProposedPost(groupId, postId) {
            if (!confirm('Вы уверены, что хотите удалить этот предложенный пост?')) {
                return;
            }
            
            try {
                // Удаляем предложенный пост из базы данных
                await set(ref(db, `proposedGroupPosts/${groupId}/${postId}`), null);
                
                console.log('Proposed post deleted successfully');
                
            } catch (error) {
                console.error('Error deleting proposed post:', error);
                alert('Ошибка при удалении предложенного поста');
            }
        }
